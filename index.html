<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <title>ุชุฌุงุฑุชู โ TIJARATI</title>

  <script async src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet">

  <script async src="https://unpkg.com/lucide@latest" onload="try{window.lucide&&window.lucide.createIcons&&window.lucide.createIcons()}catch(e){}"></script>

  <style>
    :root {
      --bg: #f7f7fb;
      --surface: #ffffff;
      --surface-2: #f1f5f9;
      --fg: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;

      --primary: #0f766e;
      --primary-2: #14b8a6;
      --danger: #ef4444;
      --warn: #f59e0b;
      --success: #10b981;

      --shadow: 0 18px 55px rgba(2, 6, 23, 0.10);
      --shadow-soft: 0 10px 30px rgba(2, 6, 23, 0.08);
      --radius: 18px;

      --ring: 0 0 0 3px color-mix(in srgb, var(--primary-2) 35%, transparent);

      --font-ar: "IBM Plex Sans Arabic", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --font-latin: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    html.dark {
      --bg: #070b16;
      --surface: #0b1326;
      --surface-2: #0f1b36;
      --fg: #e5e7eb;
      --muted: #9aa4b2;
      --border: #1b2a4a;

      --shadow: 0 30px 80px rgba(0, 0, 0, 0.55);
      --shadow-soft: 0 16px 40px rgba(0, 0, 0, 0.45);

      --ring: 0 0 0 3px color-mix(in srgb, var(--primary-2) 45%, transparent);
    }

    * {
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: radial-gradient(1000px 500px at 50% -120px, color-mix(in srgb, var(--primary-2) 20%, transparent), transparent 60%), var(--bg);
      color: var(--fg);
      font-family: var(--font-ar);
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none;
    }

    .font-latin {
      font-family: var(--font-latin);
    }

    .screen {
      display: none;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 180ms ease, transform 180ms ease;
    }

    .screen.active {
      display: flex;
      opacity: 1;
      transform: translateY(0);
    }

    @media (prefers-reduced-motion: reduce) {
      .screen {
        transition: none !important;
      }

      .animate-in,
      .animate-pop {
        animation: none !important;
      }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
    }

    .chip {
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      border-radius: 999px;
      padding: 0.5rem 0.85rem;
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--muted);
      transition: background 150ms ease, color 150ms ease, border-color 150ms ease;
      white-space: nowrap;
    }

    .chip.active {
      background: color-mix(in srgb, var(--primary) 12%, var(--surface));
      border-color: color-mix(in srgb, var(--primary) 40%, var(--border));
      color: var(--fg);
    }

    .input {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.85rem 0.95rem;
      font-weight: 600;
      outline: none;
      transition: box-shadow 120ms ease, border-color 120ms ease, background 120ms ease;
    }

    /* Money input with inline currency (prevents overlap in RTL/LTR) */
    .money-input {
      text-align: right;
      padding-left: 3.25rem;
    }

    .money-currency {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      font-weight: 900;
      color: var(--muted);
      pointer-events: none;
    }

    html[dir="ltr"] .money-input {
      text-align: left;
      padding-left: 0.95rem;
      padding-right: 3.25rem;
    }

    html[dir="ltr"] .money-currency {
      left: auto;
      right: 1rem;
    }

    .input:focus {
      border-color: color-mix(in srgb, var(--primary-2) 55%, var(--border));
      box-shadow: var(--ring);
      background: color-mix(in srgb, var(--surface) 86%, transparent);
    }

    .btn {
      border-radius: 14px;
      font-weight: 800;
      transition: transform 120ms ease, background 120ms ease, opacity 120ms ease;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .safe-bottom {
      padding-bottom: calc(env(safe-area-inset-bottom) + 92px);
    }

    .nav-safe-bottom {
      padding-bottom: env(safe-area-inset-bottom);
    }

    .glass {
      background: color-mix(in srgb, var(--surface) 70%, transparent);
      backdrop-filter: blur(12px);
      border: 1px solid color-mix(in srgb, var(--border) 75%, transparent);
    }

    .scrollbar-hide::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    .animate-in {
      animation: in 220ms ease-out both;
    }

    @keyframes in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-pop {
      animation: pop 180ms ease-out both;
    }

    @keyframes pop {
      from {
        opacity: 0;
        transform: scale(0.98);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Landscape support (tablet/phone) */
    @media (orientation: landscape) and (min-width: 700px) {
      #app {
        max-width: 100% !important;
      }

      #home-screen > header {
        display: grid;
        grid-template-columns: 1.15fr 0.85fr;
        gap: 16px;
        align-items: start;
      }

      #transaction-modal > div,
      #debt-details-modal > div,
      #transaction-details-modal > div {
        max-width: 860px;
      }
    }
  </style>
</head>

<body class="min-h-screen">
  <div id="app" class="max-w-md mx-auto min-h-screen relative overflow-hidden flex flex-col">

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 z-[80] flex items-center justify-center">
      <div class="absolute inset-0"
        style="background: radial-gradient(800px 400px at 50% 0%, rgba(20,184,166,0.35), transparent 55%), linear-gradient(180deg, rgba(15,23,42,0.96), rgba(2,6,23,0.98));">
      </div>
      <div class="relative text-center text-white animate-in">
        <div class="mx-auto mb-4 w-20 h-20 rounded-2xl flex items-center justify-center p-3"
          style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.14); box-shadow: 0 20px 50px rgba(0,0,0,0.35);">
          <img
            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
            alt="TIJARATI" class="w-full h-full object-contain" />
        </div>
        <div class="text-2xl font-black tracking-tight">ุชุฌุงุฑุชู</div>
        <div class="text-xs mt-1 text-white/70 font-semibold tracking-[0.2em] uppercase">TIJARATI</div>
        <div class="mt-5 flex items-center justify-center gap-2 text-white/70 text-xs">
          <span class="inline-block w-2 h-2 rounded-full" style="background: rgba(20,184,166,0.95);"></span>
          <span data-i18n="loading">ูุชู ุงูุชุญุถูุฑโฆ</span>
        </div>
      </div>
    </div>

    <!-- Main container -->
    <div id="main" class="flex-1 relative overflow-hidden flex flex-col">

      <!-- HOME -->
      <section id="home-screen" class="screen active flex-col h-full overflow-y-auto safe-bottom">
        <header class="px-5 pt-6 pb-10 relative">
          <div class="absolute inset-0 -z-10"
            style="background: radial-gradient(900px 340px at 50% 0%, color-mix(in srgb, var(--primary-2) 28%, transparent), transparent 58%), linear-gradient(180deg, color-mix(in srgb, var(--primary) 28%, transparent), transparent 55%);">
          </div>

          <div class="flex items-center justify-between">
            <div>
              <div id="current-date-header" class="text-xs font-bold"
                style="color: color-mix(in srgb, var(--muted) 80%, transparent);"></div>
              <div class="mt-1 flex items-center gap-2">
                <h1 class="text-2xl font-black tracking-tight" data-i18n="appName">ุชุฌุงุฑุชู</h1>
                <span class="px-2 py-0.5 rounded-full text-[11px] font-extrabold"
                  style="background: color-mix(in srgb, var(--primary) 12%, transparent); border: 1px solid color-mix(in srgb, var(--primary) 20%, var(--border)); color: var(--primary-2);">v3</span>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <button id="theme-toggle" class="w-10 h-10 rounded-2xl glass flex items-center justify-center"
                aria-label="Toggle theme" title="Theme">
                <i data-lucide="moon" class="w-5 h-5"></i>
              </button>
              <button onclick="openSettings()" class="w-10 h-10 rounded-2xl glass flex items-center justify-center"
                aria-label="Settings">
                <i data-lucide="settings" class="w-5 h-5"></i>
              </button>
            </div>
          </div>

          <div class="mt-6 card p-5">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="netProfit">ุตุงูู ุงูุฑุจุญ</div>
                <div class="mt-1 flex items-end gap-2">
                  <div id="dashboard-balance" class="text-4xl font-black tracking-tight">0</div>
                  <div class="text-sm font-extrabold" style="color: var(--muted);"><span
                      class="currency-symbol">DH</span></div>
                </div>
              </div>

              <div class="flex flex-col items-end gap-2">
                <button onclick="showScreen('ai-screen')" class="w-10 h-10 rounded-2xl flex items-center justify-center"
                  style="background: color-mix(in srgb, #4f46e5 12%, var(--surface)); border: 1px solid color-mix(in srgb, #4f46e5 18%, var(--border)); color: color-mix(in srgb, #4f46e5 92%, var(--fg));"
                  aria-label="AI" title="AI">
                  <i data-lucide="sparkles" class="w-5 h-5"></i>
                </button>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-3">
              <div class="rounded-2xl p-4"
                style="background: color-mix(in srgb, var(--success) 12%, var(--surface)); border: 1px solid color-mix(in srgb, var(--success) 18%, var(--border));">
                <div class="flex items-center justify-between">
                  <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="income">ุงููุฏุงุฎูู</div>
                  <div class="w-8 h-8 rounded-2xl flex items-center justify-center"
                    style="background: color-mix(in srgb, var(--success) 18%, transparent); color: var(--success);">
                    <i data-lucide="arrow-down-left" class="w-4 h-4"></i>
                  </div>
                </div>
                <div class="mt-2 font-black text-xl" style="color: var(--success);">
                  <span id="dashboard-income">0</span> <span class="text-xs font-extrabold currency-symbol"
                    style="color: color-mix(in srgb, var(--success) 70%, var(--muted));">DH</span>
                </div>
              </div>

              <div class="rounded-2xl p-4"
                style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 16%, var(--border));">
                <div class="flex items-center justify-between">
                  <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="expenses">ุงููุตุงุฑูู</div>
                  <div class="w-8 h-8 rounded-2xl flex items-center justify-center"
                    style="background: color-mix(in srgb, var(--danger) 18%, transparent); color: var(--danger);">
                    <i data-lucide="arrow-up-right" class="w-4 h-4"></i>
                  </div>
                </div>
                <div class="mt-2 font-black text-xl" style="color: var(--danger);">
                  <span id="dashboard-expense">0</span> <span class="text-xs font-extrabold currency-symbol"
                    style="color: color-mix(in srgb, var(--danger) 70%, var(--muted));">DH</span>
                </div>
              </div>
            </div>

            <div id="debt-alert" class="hidden mt-4 rounded-2xl p-4 flex items-center justify-between cursor-pointer"
              onclick="showScreen('debts-screen')"
              style="background: color-mix(in srgb, var(--warn) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border));">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-2xl flex items-center justify-center"
                  style="background: color-mix(in srgb, var(--warn) 18%, transparent); color: var(--warn);">
                  <i data-lucide="alert-circle" class="w-5 h-5"></i>
                </div>
                <div>
                  <div class="text-sm font-black" data-i18n="pendingDebts">ุฏููู ูุนููุฉ</div>
                  <div class="text-xs font-extrabold" style="color: color-mix(in srgb, var(--warn) 70%, var(--muted));">
                    <span id="total-pending-debt">0</span> <span class="currency-symbol">DH</span>
                  </div>
                </div>
              </div>
              <i data-lucide="chevron-left" class="w-5 h-5" style="color: var(--muted);"></i>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between">
              <h2 class="text-base font-black" data-i18n="quickActions">ุนูููุงุช ุณุฑูุนุฉ</h2>
              <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="tips">ูุตูุญุฉ: ุงุถุบุท (+) ููุฅุถุงูุฉ
                ุงูุณุฑูุนุฉ</div>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-3">
              <button onclick="startFlow('sale')" class="btn card p-4 border-0 text-white"
                style="background: linear-gradient(135deg, color-mix(in srgb, var(--success) 75%, var(--primary-2)), var(--primary)); box-shadow: 0 18px 40px rgba(15,118,110,0.30);">
                <div class="flex items-center justify-between">
                  <div class="text-right">
                    <div class="text-lg font-black" data-i18n="newSale">ุจูุน ุฌุฏูุฏ</div>
                    <div class="text-xs font-bold text-white/85" data-i18n="saleHint">ุฏุฎู ูููุณ</div>
                  </div>
                  <div class="w-10 h-10 rounded-2xl flex items-center justify-center"
                    style="background: rgba(255,255,255,0.16);">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                  </div>
                </div>
              </button>

              <button onclick="startFlow('purchase')" class="btn card p-4" style="background: var(--surface);">
                <div class="flex items-center justify-between">
                  <div class="text-right">
                    <div class="text-lg font-black" data-i18n="newPurchase">ุดุฑุงุก ุณูุนุฉ</div>
                    <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="purchaseHint">ุฎุฑุฌ ูููุณ</div>
                  </div>
                  <div class="w-10 h-10 rounded-2xl flex items-center justify-center"
                    style="background: color-mix(in srgb, var(--warn) 16%, transparent); color: var(--warn);">
                    <i data-lucide="package-plus" class="w-5 h-5"></i>
                  </div>
                </div>
              </button>
            </div>
          </div>

          <div class="mt-6">
            <div class="flex items-center justify-between">
              <h2 class="text-base font-black" data-i18n="recentActivity">ุขุฎุฑ ุงูุนูููุงุช</h2>
              <button onclick="showScreen('history-screen')" class="text-sm font-black" style="color: var(--primary-2);"
                data-i18n="seeAll">ุดูู ุงููู</button>
            </div>
            <div id="recent-transactions-list" class="mt-3 space-y-3"></div>
          </div>
        </header>
      </section>

      <!-- HISTORY -->
      <section id="history-screen" class="screen flex-col h-full overflow-hidden">
        <header class="px-5 pt-5 pb-4 sticky top-0 z-10 glass">
          <div class="flex items-center justify-between">
            <button onclick="goBack()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Back">
              <i data-lucide="arrow-right" class="w-5 h-5 rtl:rotate-180"></i>
            </button>
            <div class="text-lg font-black" data-i18n="transactions">ุงูุณุฌู</div>
            <button onclick="openSettings()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Settings">
              <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="mt-4">
            <div class="relative">
              <span class="absolute right-4 top-1/2 -translate-y-1/2" style="color: var(--muted);">
                <i data-lucide="search" class="w-5 h-5"></i>
              </span>
              <input id="history-search" class="input pr-12" type="text" placeholder="ุจุญุซโฆ" oninput="renderHistory()" />
            </div>
            <div class="mt-3 flex gap-2 overflow-x-auto scrollbar-hide pb-1" id="history-filters"></div>
          </div>
        </header>

        <div id="full-history-list" class="flex-1 overflow-y-auto px-5 pt-4 pb-10 safe-bottom space-y-4"></div>
      </section>

      <!-- DEBTS -->
      <section id="debts-screen" class="screen flex-col h-full overflow-hidden">
        <header class="px-5 pt-6 pb-5 sticky top-0 z-10"
          style="background: radial-gradient(900px 340px at 50% 0%, color-mix(in srgb, var(--warn) 22%, transparent), transparent 60%), linear-gradient(180deg, color-mix(in srgb, var(--warn) 12%, transparent), transparent 65%);">
          <div class="flex items-center justify-between">
            <button onclick="goBack()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: color-mix(in srgb, var(--surface) 70%, transparent); border: 1px solid var(--border);"
              aria-label="Back">
              <i data-lucide="arrow-right" class="w-5 h-5 rtl:rotate-180"></i>
            </button>
            <div>
              <div class="text-lg font-black" data-i18n="creditBook">ุฏูุชุฑ ุงููุฑูุฏู</div>
              <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="peopleOweYou">ูุงุณ ููุชุณุงููู</div>
            </div>
            <div class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: color-mix(in srgb, var(--warn) 16%, transparent); color: var(--warn); border: 1px solid color-mix(in srgb, var(--warn) 20%, var(--border));">
              <i data-lucide="book-open" class="w-5 h-5"></i>
            </div>
          </div>

          <div class="mt-4 card p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="pendingDebts">ุฏููู ูุนููุฉ
                </div>
                <div class="mt-1 text-3xl font-black" style="color: color-mix(in srgb, var(--warn) 90%, var(--fg));">
                  <span id="debts-total">0</span> <span class="text-sm currency-symbol">DH</span>
                </div>
              </div>
              <button onclick="renderDebts(true)" class="btn px-4 py-3 rounded-2xl"
                style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Refresh">
                <div class="flex items-center gap-2">
                  <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                  <span class="text-xs font-black" data-i18n="refresh">ุชุญุฏูุซ</span>
                </div>
              </button>
            </div>
          </div>
        </header>

        <div class="px-5 pt-4 pb-10 safe-bottom overflow-y-auto flex-1">
          <div class="relative">
            <span class="absolute right-4 top-1/2 -translate-y-1/2" style="color: var(--muted);"><i data-lucide="search"
                class="w-5 h-5"></i></span>
            <input id="debts-search" class="input pr-12" type="text" placeholder="ุจุญุซ ุจุงูุงุณู ุฃู ุงูุณูุนุฉโฆ"
              oninput="renderDebts()" />
          </div>
          <div id="debts-list" class="mt-4 space-y-3"></div>
        </div>
      </section>

      <!-- PARTNERS / STOCK -->
      <section id="partners-screen" class="screen flex-col h-full overflow-hidden">
        <header class="px-5 pt-5 pb-4 sticky top-0 z-10 glass">
          <div class="flex items-center justify-between">
            <button onclick="goBack()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Back">
              <i data-lucide="arrow-right" class="w-5 h-5 rtl:rotate-180"></i>
            </button>
            <div class="text-lg font-black" data-i18n="partners">ุงูุดุฑูุงุก</div>
            <button onclick="openSettings()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Settings">
              <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="mt-4 flex rounded-2xl p-1" style="background: var(--surface-2); border: 1px solid var(--border);">
            <button id="tab-stock" onclick="switchPartnerTab('stock')"
              class="flex-1 py-2 rounded-xl font-black text-sm" data-i18n="stock">ุงูุณูุนุฉ</button>
            <button id="tab-partners" onclick="switchPartnerTab('partners')"
              class="flex-1 py-2 rounded-xl font-black text-sm" style="color: var(--muted);" data-i18n="partners">ุงูุดุฑูุงุก</button>
          </div>
        </header>

        <div id="stock-view" class="flex-1 overflow-y-auto px-5 pt-4 pb-10 safe-bottom space-y-3">
          <div class="grid grid-cols-6 gap-2">
            <div class="relative col-span-4">
              <span class="absolute right-4 top-1/2 -translate-y-1/2" style="color: var(--muted);">
                <i data-lucide="search" class="w-5 h-5"></i>
              </span>
              <input id="stock-search" class="input pr-12" type="text" placeholder="ุจุญุซ ุจุงูุณูุนุฉโฆ" oninput="setStockSearch(this.value)" />
            </div>
            <select id="stock-sort" class="input col-span-2" onchange="setStockSort(this.value)">
              <option value="qty-desc">ุงููููุฉ โ</option>
              <option value="qty-asc">ุงููููุฉ โ</option>
              <option value="recent-desc">ุงูุฃุญุฏุซ โ</option>
              <option value="name-asc">ุงูุงุณู AโZ</option>
              <option value="in-desc">IN โ</option>
              <option value="out-desc">OUT โ</option>
            </select>
          </div>

          <div id="stock-filters" class="flex gap-2 overflow-x-auto pb-1" style="-webkit-overflow-scrolling: touch;">
            <button id="stock-filter-all" onclick="setStockFilter('all')" class="btn px-3 py-2 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);"><span class="text-xs font-black" data-i18n="filterAll">ุงููู</span></button>
            <button id="stock-filter-in" onclick="setStockFilter('in')" class="btn px-3 py-2 rounded-2xl" style="background: transparent; border: 1px solid transparent; color: var(--muted);"><span class="text-xs font-black" data-i18n="stockAvailable">ูุชููุฑ</span></button>
            <button id="stock-filter-low" onclick="setStockFilter('low')" class="btn px-3 py-2 rounded-2xl" style="background: transparent; border: 1px solid transparent; color: var(--muted);"><span class="text-xs font-black" data-i18n="stockLow">ูููู</span></button>
            <button id="stock-filter-out" onclick="setStockFilter('out')" class="btn px-3 py-2 rounded-2xl" style="background: transparent; border: 1px solid transparent; color: var(--muted);"><span class="text-xs font-black" data-i18n="stockOut">ููุฐ</span></button>
            <button id="stock-filter-neg" onclick="setStockFilter('neg')" class="btn px-3 py-2 rounded-2xl" style="background: transparent; border: 1px solid transparent; color: var(--muted);"><span class="text-xs font-black" data-i18n="stockNegative">ูุงูุต</span></button>
          </div>

          <div id="stock-summary" class="grid grid-cols-2 gap-2"></div>
          <div id="stock-list" class="space-y-3"></div>
        </div>

        <div id="partners-view" class="hidden flex-1 overflow-y-auto px-5 pt-4 pb-10 safe-bottom space-y-4">
          <div class="grid grid-cols-6 gap-2">
            <div class="relative col-span-4">
              <span class="absolute right-4 top-1/2 -translate-y-1/2" style="color: var(--muted);">
                <i data-lucide="search" class="w-5 h-5"></i>
              </span>
              <input id="partners-search" class="input pr-12" type="text" placeholder="ุจุญุซ ุจุงูุดุฑููโฆ" oninput="setPartnerSearch(this.value)" />
            </div>
            <select id="partners-sort" class="input col-span-2" onchange="setPartnerSort(this.value)">
              <option value="share-desc">ุงูุฃุฑุจุงุญ โ</option>
              <option value="due-desc">ุงููุณุชุญู โ</option>
              <option value="percent-desc">ุงููุณุจุฉ โ</option>
              <option value="name-asc">ุงูุงุณู AโZ</option>
            </select>
          </div>

          <div id="partners-summary" class="card p-4"></div>

          <div class="card p-4">
            <div class="flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="text-base font-black" data-i18n="addPartner">ุฅุถุงูุฉ ุดุฑูู</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="partnerHint">ุญุฏูุฏ ุงููุณุจุฉ ูู ุงูุฃุฑุจุงุญ</div>
              </div>
              <button onclick="togglePartnerAddForm()" id="partner-add-toggle" class="btn px-4 py-2 rounded-2xl"
                style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Toggle add partner">
                <div class="flex items-center gap-2" style="color: var(--fg);">
                  <i data-lucide="plus" class="w-4 h-4"></i>
                  <span class="text-xs font-black">ุฅุถุงูุฉ</span>
                </div>
              </button>
            </div>

            <div id="partner-add-form" class="mt-4 hidden">
              <div class="grid grid-cols-6 gap-2">
                <input id="partner-name" class="input col-span-3" type="text" placeholder="ุงูุงุณูโฆ" autocomplete="off" />
                <input id="partner-percent" class="input col-span-1 text-center" type="number" placeholder="%" min="0" max="100" inputmode="decimal" />
                <input id="partner-invested" class="input col-span-2 text-center" type="number" placeholder="ุงุณุชุซูุงุฑ" min="0" inputmode="decimal" />
              </div>
              <div class="mt-2 grid grid-cols-6 gap-2">
                <input id="partner-invested-at" class="input col-span-6" type="date" />
              </div>

              <div class="mt-2 flex flex-wrap gap-2">
                <button onclick="setPartnerPercent(50)" class="btn px-3 py-2 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);"><span class="text-xs font-black">50%</span></button>
                <button onclick="setPartnerPercent(33.33)" class="btn px-3 py-2 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);"><span class="text-xs font-black">33%</span></button>
                <button onclick="setPartnerPercent(25)" class="btn px-3 py-2 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);"><span class="text-xs font-black">25%</span></button>
                <button onclick="fillRemainingPartnerPercent()" class="btn px-3 py-2 rounded-2xl" style="background: color-mix(in srgb, var(--primary) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--primary) 18%, var(--border)); color: color-mix(in srgb, var(--primary-2) 92%, var(--fg));"><span class="text-xs font-black">ุงูุจุงูู</span></button>
              </div>

              <button onclick="addPartner()" class="btn w-full mt-3 py-3 text-white"
                style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                <span data-i18n="add">ุฅุถุงูุฉ</span>
              </button>
              <div id="partner-add-hint" class="mt-2 text-[11px] font-bold" style="color: var(--muted);"></div>
            </div>
          </div>

          <div id="partners-list" class="space-y-3"></div>
        </div>
      </section>

      <!-- AI -->
      <section id="ai-screen" class="screen flex-col h-full overflow-hidden">
        <header class="px-5 pt-5 pb-4 sticky top-0 z-10 glass">
          <div class="relative h-10">
            <button onclick="goBack()" class="w-10 h-10 rounded-2xl flex items-center justify-center absolute left-0 top-0"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Back">
              <i data-lucide="arrow-right" class="w-5 h-5 rtl:rotate-180"></i>
            </button>

            <div class="absolute inset-0 flex items-center justify-center">
              <div class="text-lg font-black" data-i18n="ai">ุงูุฐูุงุก ุงูุงุตุทูุงุนู</div>
            </div>

            <button onclick="openAiHistory()" class="w-10 h-10 rounded-2xl flex items-center justify-center absolute right-0 top-0"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Menu">
              <i data-lucide="menu" class="w-5 h-5"></i>
            </button>
          </div>
        </header>

        <div class="flex-1 overflow-hidden flex flex-col">
          <div class="px-5 pt-4 pb-3">
            <div id="ai-chat-status" class="text-[11px] font-bold" style="color: var(--muted);"></div>
          </div>

          <div class="flex-1 overflow-y-auto px-5 pb-4">
            <div id="ai-plan-card" class="card p-4 hidden mb-4">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm font-black" data-i18n="aiProposedChanges">ุงูุชุบููุฑุงุช ุงูููุชุฑุญุฉ</div>
                  <div id="ai-plan-summary" class="text-xs font-bold" style="color: var(--muted);"></div>
                </div>
                <button onclick="aiCancelPlan()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
                  style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
                  <i data-lucide="x" class="w-5 h-5"></i>
                </button>
              </div>

              <pre id="ai-plan-json" class="mt-3 text-xs font-bold p-3 rounded-2xl overflow-x-auto"
                style="background: color-mix(in srgb, var(--surface) 88%, transparent); border: 1px solid var(--border); white-space: pre;"></pre>

              <button onclick="aiApplyPlan()" class="btn w-full mt-3 py-3 text-white"
                style="background: linear-gradient(135deg, #4f46e5, #6366f1);">
                <span class="font-black" data-i18n="aiApply">ุชุทุจูู</span>
              </button>
            </div>

            <div id="ai-chat-messages" class="space-y-2"></div>
          </div>

          <div class="px-5 pt-2 pb-0" style="position: sticky; bottom: 0; background: color-mix(in srgb, var(--bg) 78%, transparent); backdrop-filter: blur(16px); border-top: 1px solid color-mix(in srgb, var(--border) 75%, transparent); padding-bottom: calc(env(safe-area-inset-bottom) + 18px);">
            <div id="ai-shortcuts" class="mb-2 hidden">
              <div class="flex flex-wrap gap-2">
                <button id="ai-ex-1" class="btn px-3 py-2 rounded-2xl text-xs font-black"
                  style="background: var(--surface-2); border: 1px solid var(--border);"></button>
                <button id="ai-ex-2" class="btn px-3 py-2 rounded-2xl text-xs font-black"
                  style="background: var(--surface-2); border: 1px solid var(--border);"></button>
                <button id="ai-ex-3" class="btn px-3 py-2 rounded-2xl text-xs font-black"
                  style="background: color-mix(in srgb, #4f46e5 10%, var(--surface)); border: 1px solid color-mix(in srgb, #4f46e5 18%, var(--border)); color: color-mix(in srgb, #4f46e5 92%, var(--fg));"></button>
              </div>
            </div>

            <div class="flex gap-2 p-2 rounded-3xl" style="background: color-mix(in srgb, var(--surface) 82%, transparent); border: 1px solid color-mix(in srgb, #6366f1 22%, var(--border)); box-shadow: 0 0 0 1px color-mix(in srgb, #6366f1 25%, transparent), 0 16px 50px rgba(99,102,241,0.18), 0 0 18px rgba(99,102,241,0.20);">
              <input id="ai-chat-input" type="text" class="input" placeholder="..." onkeydown="if(event.key==='Enter'){sendAiChat();}" style="border-color: transparent; background: transparent; box-shadow: none;" />
              <button onclick="sendAiChat()" class="btn px-5 py-3 text-white" style="background: linear-gradient(135deg, #4f46e5, #6366f1);">
                <span class="text-sm font-black" data-i18n="send">ุฅุฑุณุงู</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- AI history drawer -->
      <div id="ai-history" class="fixed inset-0 z-[95] hidden"
        style="background: rgba(0,0,0,0.45); backdrop-filter: blur(8px);">
        <button onclick="closeAiHistory()" class="absolute inset-0" aria-label="Close overlay" style="background: transparent; z-index: 0;"></button>
        <div class="absolute inset-y-0 left-0 w-[88%] max-w-sm card p-4"
          style="border-radius: 0 26px 26px 0; height: 100%; overflow: hidden; z-index: 1;">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-base font-black" data-i18n="aiHistory">Chat history</div>
              <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="aiHistoryHint">Switch or start a new chat</div>
            </div>
            <button onclick="closeAiHistory()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2">
            <button onclick="aiNewConversation(); closeAiHistory();" class="btn py-3 text-white"
              style="background: linear-gradient(135deg, #4f46e5, #6366f1);">
              <div class="flex items-center justify-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span class="font-black" data-i18n="aiNewChat">New chat</span>
              </div>
            </button>
            <button onclick="aiClearCurrentChat(); closeAiHistory();" class="btn py-3"
              style="background: var(--surface-2); border: 1px solid var(--border);">
              <div class="flex items-center justify-center gap-2">
                <i data-lucide="trash-2" class="w-4 h-4" style="color: var(--danger);"></i>
                <span class="font-black" data-i18n="clear">Clear</span>
              </div>
            </button>
          </div>

          <div id="ai-history-list" class="mt-4 space-y-2" style="overflow-y: auto; height: calc(100% - 140px);"></div>
        </div>
      </div>

      <!-- SETTINGS (Overlay) -->
      <section id="settings-screen" class="screen flex-col h-full absolute inset-0 z-[70]"
        style="background: var(--bg);">
        <header class="px-5 pt-5 pb-4 sticky top-0 z-10 glass">
          <div class="flex items-center justify-between">
            <button onclick="closeSettings()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Back">
              <i data-lucide="arrow-right" class="w-5 h-5 rtl:rotate-180"></i>
            </button>
            <div class="text-lg font-black" data-i18n="settings">ุงูุฅุนุฏุงุฏุงุช</div>
            <div class="w-10 h-10"></div>
          </div>
        </header>

        <div class="px-5 pt-4 pb-10 safe-bottom overflow-y-auto">
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="appearance">ุงููุธูุฑ</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="appearanceHint">Light / Dark
                </div>
              </div>
              <button id="settings-theme" class="btn px-4 py-2 rounded-2xl"
                style="background: var(--surface-2); border: 1px solid var(--border);">
                <span id="settings-theme-label" class="text-sm font-black">Dark</span>
              </button>
            </div>
          </div>

          <div class="card p-4 mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="language">ุงููุบุฉ</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="languageHint">ุงุฎุชูุงุฑ ูุบุฉ ุงููุงุฌูุฉ
                </div>
              </div>
              <i data-lucide="languages" class="w-5 h-5" style="color: var(--muted);"></i>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button onclick="setLanguage('darija')" class="lang-btn btn py-3"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-lang="darija">๐ฒ๐ฆ
                ุงูุฏุงุฑุฌุฉ</button>
              <button onclick="setLanguage('arabic')" class="lang-btn btn py-3"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-lang="arabic">๐ธ๐ฆ
                ุงูุนุฑุจูุฉ</button>
              <button onclick="setLanguage('french')" class="lang-btn btn py-3 font-latin"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-lang="french">๐ซ๐ท
                Franรงais</button>
              <button onclick="setLanguage('english')" class="lang-btn btn py-3 font-latin"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-lang="english">๐ฌ๐ง
                English</button>
            </div>
          </div>

          <div class="card p-4 mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="currency">ุงูุนููุฉ</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="currencyHint">ุงูุชุญููู ูุชู
                  ุชููุงุฆูุงู</div>
              </div>
              <i data-lucide="coins" class="w-5 h-5" style="color: var(--muted);"></i>
            </div>
            <div class="mt-3 grid grid-cols-3 gap-2">
              <button onclick="setCurrency('MAD')" class="curr-btn btn py-3 font-black"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-curr="MAD">MAD</button>
              <button onclick="setCurrency('EUR')" class="curr-btn btn py-3 font-black font-latin"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-curr="EUR">EUR</button>
              <button onclick="setCurrency('USD')" class="curr-btn btn py-3 font-black font-latin"
                style="background: var(--surface-2); border: 1px solid var(--border);" data-curr="USD">USD</button>
            </div>
          </div>

          <div class="card p-4 mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="data">ุงูุจูุงูุงุช</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="dataHint">ุชุตุฏูุฑ/ุงุณุชูุฑุงุฏ ุฃู ูุณุญ
                </div>
              </div>
              <i data-lucide="database" class="w-5 h-5" style="color: var(--muted);"></i>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button onclick="exportData()" class="btn py-3"
                style="background: color-mix(in srgb, var(--primary) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--primary) 18%, var(--border)); color: var(--primary-2);">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="download" class="w-4 h-4"></i>
                  <span data-i18n="exportData">ุญูุธ ูุณุฎุฉ</span>
                </div>
              </button>

              <label class="btn py-3 cursor-pointer"
                style="background: color-mix(in srgb, #3b82f6 10%, var(--surface)); border: 1px solid color-mix(in srgb, #3b82f6 18%, var(--border)); color: color-mix(in srgb, #3b82f6 92%, var(--fg));">
                <input id="import-file" type="file" accept="application/json" class="hidden"
                  onchange="importData(event)" />
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="upload" class="w-4 h-4"></i>
                  <span data-i18n="importData">ุงุณุชูุฑุงุฏ</span>
                </div>
              </label>

              <button id="settings-mock-data" class="btn col-span-2 py-3"
                style="background: color-mix(in srgb, var(--warn) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border)); color: color-mix(in srgb, var(--warn) 92%, var(--fg));">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="flask-conical" class="w-4 h-4"></i>
                  <span id="settings-mock-label" class="font-black"></span>
                </div>
              </button>

              <button
                onclick="console.log('๐ข Clear Data button clicked!'); openConfirm({title: t('clearData'), message: t('deleteWarning'), confirmText: t('yesDelete'), danger: true, onConfirm: clearAllData})"
                class="btn col-span-2 py-3"
                style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border)); color: color-mix(in srgb, var(--danger) 92%, var(--fg));">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                  <span data-i18n="clearData">ูุณุญ ููุดู</span>
                </div>
              </button>
            </div>
          </div>

          <div class="card p-4 mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="cloud">ุงูุณุญุงุจุฉ</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="cloudHint">ูุณุฎ ุงุญุชูุงุทู ุนุจุฑ Google</div>
              </div>
              <i data-lucide="cloud" class="w-5 h-5" style="color: var(--muted);"></i>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button id="cloud-signin" onclick="cloudSignIn()" class="btn py-3"
                style="background: color-mix(in srgb, #3b82f6 10%, var(--surface)); border: 1px solid color-mix(in srgb, #3b82f6 18%, var(--border)); color: color-mix(in srgb, #3b82f6 92%, var(--fg));">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="log-in" class="w-4 h-4"></i>
                  <span data-i18n="cloudSignIn">ุชุณุฌูู ุงูุฏุฎูู</span>
                </div>
              </button>

              <button id="cloud-signout" onclick="cloudSignOut()" class="btn py-3"
                style="background: color-mix(in srgb, var(--muted) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--muted) 18%, var(--border)); color: var(--fg);">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="log-out" class="w-4 h-4"></i>
                  <span data-i18n="cloudSignOut">ุฎุฑูุฌ</span>
                </div>
              </button>

              <button onclick="cloudBackup()" class="btn col-span-2 py-3"
                style="background: color-mix(in srgb, var(--success) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--success) 18%, var(--border)); color: color-mix(in srgb, var(--success) 92%, var(--fg));">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="cloud-upload" class="w-4 h-4"></i>
                  <span data-i18n="cloudBackup">ูุณุฎ ุงุญุชูุงุทู ุงูุขู</span>
                </div>
              </button>

              <button onclick="cloudRestore()" class="btn col-span-2 py-3"
                style="background: color-mix(in srgb, var(--warn) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border)); color: color-mix(in srgb, var(--warn) 92%, var(--fg));">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="cloud-download" class="w-4 h-4"></i>
                  <span data-i18n="cloudRestore">ุงุณุชุฑุฌุงุน ูู ุงูุณุญุงุจุฉ</span>
                </div>
              </button>

              <button onclick="cloudRefreshStatus()" class="btn col-span-2 py-3"
                style="background: color-mix(in srgb, var(--muted) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--muted) 18%, var(--border)); color: var(--fg);">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                  <span data-i18n="cloudRefreshStatus">ุชุญุฏูุซ ุงูุญุงูุฉ</span>
                </div>
              </button>

              <div id="cloud-user" class="col-span-2 text-xs font-bold" style="color: var(--muted);"></div>
              <div id="cloud-status" class="col-span-2 text-xs font-bold" style="color: var(--muted);"></div>
            </div>
          </div>

          <div class="card p-4 mt-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="security">ุงูุฃูุงู</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="securityHint">PIN + ุจุตูุฉ</div>
              </div>
              <i data-lucide="shield" class="w-5 h-5" style="color: var(--muted);"></i>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button onclick="securitySetPin()" class="btn py-3"
                style="background: color-mix(in srgb, var(--primary) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--primary) 18%, var(--border)); color: var(--primary-2);">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="key" class="w-4 h-4"></i>
                  <span data-i18n="setPin">ุชุนููู PIN</span>
                </div>
              </button>

              <button onclick="securityDisablePin()" class="btn py-3"
                style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border)); color: color-mix(in srgb, var(--danger) 92%, var(--fg));">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="lock-open" class="w-4 h-4"></i>
                  <span data-i18n="disablePin">ุฅูุบุงุก PIN</span>
                </div>
              </button>

              <button id="btn-bio" onclick="securityToggleBiometric()" class="btn col-span-2 py-3"
                style="background: color-mix(in srgb, #6366f1 10%, var(--surface)); border: 1px solid color-mix(in srgb, #6366f1 18%, var(--border)); color: color-mix(in srgb, #6366f1 92%, var(--fg));">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="fingerprint" class="w-4 h-4"></i>
                  <span id="bio-label" data-i18n="enableBiometric">ุชูุนูู ุงูุจุตูุฉ</span>
                </div>
              </button>

              <div id="security-status" class="col-span-2 text-xs font-bold" style="color: var(--muted);"></div>
            </div>
          </div>

          <div class="mt-6 text-center text-xs font-bold" style="color: var(--muted);">
            <div class="mb-1">TIJARATI โ v3 <span class="font-latin">offline</span></div>
            <div class="opacity-80">
              Created by <button onclick="API.openExternal('https://portfolio-v2-eight-lovat.vercel.app/en')"
                class="font-black underline decoration-2 decoration-teal-500/50 hover:decoration-teal-500 text-teal-600">OUSSAMA</button>
            </div>
          </div>
        </div>
      </section>

      <!-- AUTH (Full-page) -->
      <section id="auth-screen" class="screen flex-col h-full absolute inset-0 z-[72]"
        style="background: var(--bg);">
        <header class="px-5 pt-5 pb-4 sticky top-0 z-10 glass">
          <div class="flex items-center justify-between">
            <button onclick="goBack()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Back">
              <i data-lucide="arrow-right" class="w-5 h-5 rtl:rotate-180"></i>
            </button>
            <div class="text-lg font-black" data-i18n="authTitle">ุชุณุฌูู ุงูุฏุฎูู</div>
            <div class="w-10 h-10"></div>
          </div>
        </header>

        <div class="flex-1 overflow-y-auto px-5 pt-4 pb-10 safe-bottom">
          <div class="card p-5">
            <div id="auth-screen-status" class="text-xs font-bold" style="color: var(--muted);"></div>

            <div class="mt-4 flex rounded-2xl p-1" style="background: var(--surface-2); border: 1px solid var(--border);">
              <button id="auth-tab-signin" onclick="setAuthScreenMode('signin')" class="flex-1 py-2 rounded-xl font-black text-sm">
                <span data-i18n="signIn">ุฏุฎูู</span>
              </button>
              <button id="auth-tab-signup" onclick="setAuthScreenMode('signup')" class="flex-1 py-2 rounded-xl font-black text-sm" style="color: var(--muted);">
                <span data-i18n="signUp">ุญุณุงุจ ุฌุฏูุฏ</span>
              </button>
            </div>

            <div class="mt-4 space-y-3">
              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                <input id="auth-screen-email" type="email" class="input" placeholder="name@email.com" autocomplete="email" />
              </div>
              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="password">ูููุฉ ุงููุฑูุฑ</label>
                <input id="auth-screen-password" type="password" class="input" placeholder="โขโขโขโขโขโขโขโข" autocomplete="current-password" />
              </div>
              <div id="auth-screen-confirm-wrap" class="hidden">
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="confirmPassword">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ</label>
                <input id="auth-screen-confirm" type="password" class="input" placeholder="โขโขโขโขโขโขโขโข" autocomplete="new-password" />
              </div>

              <button id="auth-screen-primary" onclick="authScreenPrimary()" class="btn py-3 text-white"
                style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="log-in" class="w-4 h-4"></i>
                  <span id="auth-screen-primary-text" class="font-black" data-i18n="signIn">ุฏุฎูู</span>
                </div>
              </button>

              <button onclick="authScreenReset()" class="btn py-3"
                style="background: transparent; border: 1px solid var(--border); color: var(--muted);">
                <span class="font-black" data-i18n="resetPassword">ูุณูุช ูููุฉ ุงููุฑูุฑุ</span>
              </button>

              <div class="flex items-center gap-3 my-2" style="color: var(--muted);">
                <div class="h-px flex-1" style="background: var(--border);"></div>
                <div class="text-[11px] font-extrabold">OR</div>
                <div class="h-px flex-1" style="background: var(--border);"></div>
              </div>

              <button onclick="cloudSignIn()" class="btn py-3"
                style="background: color-mix(in srgb, #3b82f6 10%, var(--surface)); border: 1px solid color-mix(in srgb, #3b82f6 18%, var(--border)); color: color-mix(in srgb, #3b82f6 92%, var(--fg));">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="chrome" class="w-4 h-4"></i>
                  <span class="font-black" data-i18n="continueWithGoogle">ุชุงุจุน ุนุจุฑ Google</span>
                </div>
              </button>

              <button id="auth-screen-signout" onclick="cloudSignOut()" class="btn py-3 hidden"
                style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border)); color: color-mix(in srgb, var(--danger) 92%, var(--fg));">
                <div class="flex items-center justify-center gap-2">
                  <i data-lucide="log-out" class="w-4 h-4"></i>
                  <span class="font-black" data-i18n="cloudSignOut">ุฎุฑูุฌ</span>
                </div>
              </button>
            </div>
          </div>
        </div>
      </section>

    </div>

    <!-- Bottom navigation -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 z-40 nav-safe-bottom px-5 pt-2 pb-3"
      style="background: color-mix(in srgb, var(--bg) 55%, transparent); backdrop-filter: blur(14px); border-top: 1px solid color-mix(in srgb, var(--border) 75%, transparent);">
      <div class="grid grid-cols-5 items-end gap-2">
        <button class="nav-item btn py-2 flex flex-col items-center gap-1" data-target="home-screen"
          onclick="showScreen('home-screen')" aria-label="Home">
          <i data-lucide="home" class="w-6 h-6"></i>
          <span class="text-[10px] font-black" data-i18n="home">ุงูุฑุฆูุณูุฉ</span>
        </button>

        <button class="nav-item btn py-2 flex flex-col items-center gap-1" data-target="history-screen"
          onclick="showScreen('history-screen')" aria-label="History">
          <i data-lucide="list" class="w-6 h-6"></i>
          <span class="text-[10px] font-black" data-i18n="history">ุงูุณุฌู</span>
        </button>

        <div class="flex justify-center">
          <button onclick="openQuickAdd()" class="btn w-14 h-14 rounded-2xl text-white flex items-center justify-center"
            style="background: linear-gradient(135deg, var(--primary), var(--primary-2)); box-shadow: 0 18px 50px rgba(20,184,166,0.30); border: 1px solid color-mix(in srgb, var(--primary-2) 25%, transparent);"
            aria-label="Add">
            <i data-lucide="plus" class="w-7 h-7"></i>
          </button>
        </div>

        <button class="nav-item btn py-2 flex flex-col items-center gap-1" data-target="debts-screen"
          onclick="showScreen('debts-screen')" aria-label="Debts">
          <i data-lucide="book-open" class="w-6 h-6"></i>
          <span class="text-[10px] font-black" data-i18n="credit">ุงููุฑูุฏู</span>
        </button>

        <button class="nav-item btn py-2 flex flex-col items-center gap-1" data-target="partners-screen"
          onclick="showScreen('partners-screen')" aria-label="Partners">
          <i data-lucide="users" class="w-6 h-6"></i>
          <span class="text-[10px] font-black" data-i18n="partners">ุงูุดุฑูุงุก</span>
        </button>
      </div>
    </nav>

    <!-- Quick Add sheet -->
    <div id="quick-add" class="fixed inset-0 z-[75] hidden items-end justify-center p-4"
      style="background: rgba(0,0,0,0.45); backdrop-filter: blur(8px);">
      <div class="w-full max-w-md card p-4 animate-pop" style="border-radius: 26px;">
        <div class="flex items-center justify-between">
          <div class="text-base font-black" data-i18n="quickAdd">ุฅุถุงูุฉ ุณุฑูุนุฉ</div>
          <button onclick="closeQuickAdd()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
            style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button onclick="startFlow('sale'); closeQuickAdd();" class="btn py-4 text-white"
            style="background: linear-gradient(135deg, color-mix(in srgb, var(--success) 75%, var(--primary-2)), var(--primary));">
            <div class="flex items-center justify-center gap-2">
              <i data-lucide="shopping-cart" class="w-5 h-5"></i>
              <span data-i18n="newSale">ุจูุน ุฌุฏูุฏ</span>
            </div>
          </button>
          <button onclick="startFlow('purchase'); closeQuickAdd();" class="btn py-4"
            style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-center gap-2">
              <i data-lucide="package-plus" class="w-5 h-5" style="color: var(--warn);"></i>
              <span data-i18n="newPurchase">ุดุฑุงุก ุณูุนุฉ</span>
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- Transaction modal -->
    <div id="transaction-modal" class="fixed inset-0 z-[90] hidden items-end sm:items-center justify-center p-0 sm:p-4"
      style="background: rgba(0,0,0,0.50); backdrop-filter: blur(10px);">
      <div class="w-full max-w-md card animate-pop overflow-hidden" style="border-radius: 26px;">
        <div id="modal-header" class="p-4 text-white"
          style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs font-extrabold text-white/75" data-i18n="transaction">ุนูููุฉ</div>
              <div id="modal-title" class="text-lg font-black">ุชุณุฌูู</div>
            </div>
            <button onclick="closeModal()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: rgba(255,255,255,0.16); border: 1px solid rgba(255,255,255,0.18);" aria-label="Close">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="mt-3 flex items-center justify-between">
            <div class="text-xs font-extrabold text-white/80" data-i18n="total">ุงููุฌููุน</div>
            <div class="text-2xl font-black"><span id="tx-total-preview">0</span> <span
                class="text-sm currency-symbol">DH</span></div>
          </div>
        </div>

        <div class="p-5 space-y-5 max-h-[70vh] overflow-y-auto">
          <div>
            <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="itemName">ุงุณู
              ุงูุณูุนุฉ</label>
            <input id="tx-item" type="text" class="input" placeholder="โฆ" />
            <div id="quick-suggestions" class="mt-2 flex gap-2 overflow-x-auto scrollbar-hide pb-1"></div>
          </div>

          <!-- Pricing mode (unit vs total) -->
          <div class="rounded-2xl p-4" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="pricingMode">ุทุฑููุฉ ุงูุญุณุงุจ</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="pricingHint">ุฏุฎู ุงูุซูู ูุงูุนุฏุฏ ูุฎูู ุงูุชุทุจูู ูุญุณุจ</div>
              </div>
              <div class="flex rounded-2xl p-1" style="background: var(--surface); border: 1px solid var(--border);">
                <button id="btn-mode-unit" onclick="setPricingMode('unit')" class="px-3 py-1.5 rounded-xl text-xs font-black" data-i18n="unitPriceMode">ุซูู ุงููุญุฏุฉ</button>
                <button id="btn-mode-total" onclick="setPricingMode('total')" class="px-3 py-1.5 rounded-xl text-xs font-black" style="color: var(--muted);" data-i18n="totalPriceMode">ุงูุซูู ุงูุฅุฌูุงูู</button>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="unitPrice">ุงูุซูู (ูููุญุฏุฉ)</label>
                <div class="relative">
                  <input id="tx-unit-price" type="number" inputmode="decimal" class="input money-input" placeholder="0" />
                  <div class="money-currency"><span class="currency-symbol">DH</span></div>
                </div>
              </div>
              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="totalPrice">ุงูุซูู ุงูุฅุฌูุงูู</label>
                <div class="relative">
                  <input id="tx-total-price" type="number" inputmode="decimal" class="input money-input" placeholder="0" />
                  <div class="money-currency"><span class="currency-symbol">DH</span></div>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="quantity">ุงูุนุฏุฏ</label>
              <input id="tx-qty" type="number" inputmode="decimal" class="input text-center" placeholder="0" />
            </div>

            <div id="pricing-hint" class="mt-2 text-[11px] font-bold" style="color: var(--muted);"></div>
          </div>

          <div class="rounded-2xl p-4" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="paymentStatus">ุญุงูุฉ ุงูุฎูุงุต</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="paymentHint">ุฎุงูุต ุฃู ูุฑูุฏู</div>
              </div>
              <div class="flex rounded-2xl p-1" style="background: var(--surface); border: 1px solid var(--border);">
                <button id="btn-paid" onclick="setPaymentType('paid')"
                  class="px-3 py-1.5 rounded-xl text-xs font-black" data-i18n="paidLabel">ุฎุงูุต</button>
                <button id="btn-credit" onclick="setPaymentType('credit')"
                  class="px-3 py-1.5 rounded-xl text-xs font-black" style="color: var(--muted);" data-i18n="creditLabel">ูุฑูุฏู</button>
              </div>
            </div>

            <div id="credit-details" class="hidden mt-4 space-y-3 animate-in">
              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);"
                  data-i18n="clientName">ุณููุฉ ุงูุดุฎุต</label>
                <input id="tx-client" type="text" class="input" placeholder="โฆ" />
              </div>
              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);"
                  data-i18n="amountPaid">ุดุญุงู ุนุทู (ุงูุนุฑุจูู)</label>
                <div class="relative">
                  <input id="tx-paid-amount" type="number" inputmode="decimal" class="input money-input" placeholder="0" />
                  <div class="money-currency"><span class="currency-symbol">DH</span></div>
                </div>
              </div>

              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="debtDueDate">ุชุงุฑูุฎ ุงูุชุฐููุฑ</label>
                <input id="tx-due-date" type="date" class="input" />
                <div class="mt-1 text-[11px] font-bold" style="color: var(--muted);" data-i18n="debtDueHint">ุฎูููุง ุฎุงููุฉ ุฅูุง ูุง ุจุบูุชูุด ุชุฐููุฑ</div>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);"
              data-i18n="date">ุงูุชุงุฑูุฎ</label>
            <input id="tx-date" type="date" class="input" />
          </div>
        </div>

        <div class="p-4"
          style="background: color-mix(in srgb, var(--surface) 90%, transparent); border-top: 1px solid var(--border);">
          <button id="save-btn" onclick="saveTransaction()" class="btn w-full py-4 text-white"
            style="background: linear-gradient(135deg, var(--primary), var(--primary-2)); box-shadow: 0 18px 50px rgba(20,184,166,0.25);">
            <div class="flex items-center justify-center gap-2">
              <i data-lucide="check" class="w-5 h-5"></i>
              <span data-i18n="save">ุญูุธ ุงูุนูููุฉ</span>
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- Confirm modal (generic) -->
    <div id="confirm-modal" class="fixed inset-0 z-[95] hidden items-center justify-center p-4"
      style="background: rgba(0,0,0,0.55); backdrop-filter: blur(10px);">
      <div class="w-full max-w-sm card p-5 animate-pop" style="border-radius: 26px;">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div id="confirm-title" class="text-lg font-black">ุชุฃููุฏ</div>
            <div id="confirm-message" class="mt-1 text-sm font-bold" style="color: var(--muted);"></div>
          </div>
          <button onclick="closeConfirm()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
            style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="mt-5 grid grid-cols-2 gap-2">
          <button onclick="closeConfirm()" class="btn py-3"
            style="background: var(--surface-2); border: 1px solid var(--border);" data-i18n="cancel">ุฅูุบุงุก</button>
          <button id="confirm-action" class="btn py-3 text-white"
            style="background: linear-gradient(135deg, var(--danger), color-mix(in srgb, var(--danger) 70%, #7f1d1d));">ุญุฐู</button>
        </div>
      </div>
    </div>

    <!-- Auth modal (email/password + Google) -->
    <div id="auth-modal" class="fixed inset-0 z-[96] hidden items-center justify-center p-4"
      style="background: rgba(0,0,0,0.55); backdrop-filter: blur(10px);">
      <div class="w-full max-w-sm card p-5 animate-pop" style="border-radius: 26px;">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-black" data-i18n="authTitle">ุชุณุฌูู ุงูุฏุฎูู</div>
            <div id="auth-sub" class="mt-1 text-xs font-bold" style="color: var(--muted);"></div>
          </div>
          <button onclick="closeAuthModal()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
            style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="mt-4 space-y-3">
          <div>
            <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
            <input id="auth-email" type="email" class="input" placeholder="name@email.com" autocomplete="email" />
          </div>
          <div>
            <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="password">ูููุฉ ุงููุฑูุฑ</label>
            <input id="auth-password" type="password" class="input" placeholder="โขโขโขโขโขโขโขโข" autocomplete="current-password" />
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button onclick="authEmailSignIn()" class="btn py-3 text-white"
              style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
              <span class="font-black" data-i18n="signIn">ุฏุฎูู</span>
            </button>
            <button onclick="authEmailSignUp()" class="btn py-3"
              style="background: var(--surface-2); border: 1px solid var(--border);">
              <span class="font-black" data-i18n="signUp">ุญุณุงุจ ุฌุฏูุฏ</span>
            </button>
          </div>

          <button onclick="authResetPassword()" class="btn py-3"
            style="background: transparent; border: 1px solid transparent; color: var(--muted);">
            <span class="font-black" data-i18n="resetPassword">ูุณูุช ูููุฉ ุงููุฑูุฑุ</span>
          </button>

          <div class="flex items-center gap-3 my-2" style="color: var(--muted);">
            <div class="h-px flex-1" style="background: var(--border);"></div>
            <div class="text-[11px] font-extrabold">OR</div>
            <div class="h-px flex-1" style="background: var(--border);"></div>
          </div>

          <button onclick="authGoogleSignIn()" class="btn py-3"
            style="background: color-mix(in srgb, #3b82f6 10%, var(--surface)); border: 1px solid color-mix(in srgb, #3b82f6 18%, var(--border)); color: color-mix(in srgb, #3b82f6 92%, var(--fg));">
            <div class="flex items-center justify-center gap-2">
              <i data-lucide="chrome" class="w-4 h-4"></i>
              <span class="font-black" data-i18n="continueWithGoogle">ุชุงุจุน ุนุจุฑ Google</span>
            </div>
          </button>
        </div>
      </div>
    </div>

    <!-- Debt details modal -->
    <div id="debt-details-modal" class="fixed inset-0 z-[94] hidden items-center justify-center p-4"
      style="background: rgba(0,0,0,0.55); backdrop-filter: blur(10px); padding-top: calc(16px + env(safe-area-inset-top)); padding-bottom: calc(16px + env(safe-area-inset-bottom));">
      <div class="w-full max-w-md card p-5 animate-pop" style="border-radius: 26px; max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 32px); overflow-y: auto; -webkit-overflow-scrolling: touch;">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-black" data-i18n="debtDetailsTitle">ุชูุงุตูู ุงูุฏูู</div>
          </div>
          <button onclick="closeDebtDetails()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
            style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="mt-4 space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="clientName">ุดูููุ (ุงูุณููุฉ)</div>
            <div id="debt-details-client" class="text-sm font-black text-right truncate"></div>
          </div>
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="itemName">ุดูู ูุงุฏ ุงูุณูุนุฉุ</div>
            <div id="debt-details-item" class="text-sm font-black text-right truncate"></div>
          </div>
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="debtTypeLabel">ุงูููุน</div>
            <div id="debt-details-type" class="text-sm font-black text-right truncate"></div>
          </div>
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="date">ุงูุชุงุฑูุฎ</div>
            <div id="debt-details-date" class="text-sm font-black text-right truncate"></div>
          </div>

          <div class="mt-2 grid grid-cols-3 gap-2">
            <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="total">ุงููุฌููุน</div>
              <div id="debt-details-total" class="mt-1 text-sm font-black"></div>
            </div>
            <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="amountPaid">ุดุญุงู ุนุทู ุฏุงุจุงุ</div>
              <div id="debt-details-paid" class="mt-1 text-sm font-black"></div>
            </div>
            <div class="p-3 rounded-2xl" style="background: color-mix(in srgb, var(--warn) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border));">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="remaining">ุงูุจุงูู</div>
              <div id="debt-details-remaining" class="mt-1 text-sm font-black" style="color: var(--warn);"></div>
            </div>
          </div>

          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="debtDueDate">ุชุงุฑูุฎ ุงูุชุฐููุฑ</div>
            <div id="debt-details-reminder" class="text-sm font-black text-right truncate"></div>
          </div>

          <!-- Installments section -->
          <div class="mt-3 rounded-2xl p-4" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="installments">ุงูุชูุณูุท</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="installmentsHint">ุฅุฐุง ูุงู ุงูุณุฏุงุฏ ุนูู ุฏูุนุงุช</div>
              </div>
              <label class="flex items-center gap-2">
                <input id="debt-installments-enabled" type="checkbox" class="w-5 h-5" onchange="toggleDebtInstallments()" />
              </label>
            </div>

            <div id="debt-installments-section" class="hidden mt-4 space-y-3 animate-in">
              <div id="debt-installments-list" class="space-y-2"></div>

              <div class="grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="paymentAmount">ูููุฉ ุงูุฏูุนุฉ</label>
                  <div class="relative">
                    <input id="debt-payment-amount" type="number" inputmode="decimal" class="input money-input" placeholder="0" />
                    <div class="money-currency"><span class="currency-symbol">DH</span></div>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="paymentDate">ุชุงุฑูุฎ ุงูุฏูุนุฉ</label>
                  <input id="debt-payment-date" type="date" class="input" />
                </div>
              </div>

              <button onclick="addDebtInstallmentPayment()" class="btn w-full py-3"
                style="background: color-mix(in srgb, var(--warn) 12%, var(--surface)); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border)); color: color-mix(in srgb, var(--warn) 92%, var(--fg));">
                <span class="font-black" data-i18n="addPayment">ุฅุถุงูุฉ ุฏูุนุฉ</span>
              </button>
            </div>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-2 gap-2">
          <button id="debt-details-set-reminder" class="btn py-3"
            style="background: var(--surface-2); border: 1px solid var(--border);" data-i18n="reminderSet">ุญุฏุฏ ุชุฐููุฑ</button>
          <button id="debt-details-clear-reminder" class="btn py-3 hidden"
            style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border));" data-i18n="reminderClear">ุญูุฏ ุงูุชุฐููุฑ</button>
        </div>

        <div class="mt-2 grid grid-cols-2 gap-2">
          <button onclick="closeDebtDetails()" class="btn py-3"
            style="background: var(--surface-2); border: 1px solid var(--border);" data-i18n="cancel">ุฅูุบุงุก</button>
          <button id="debt-details-settle" class="btn py-3 text-white"
            style="background: linear-gradient(135deg, var(--primary), var(--primary-2));" data-i18n="settled">ุชุฎูุตุช</button>
        </div>
      </div>
    </div>

    <!-- Partner details modal -->
    <div id="partner-details-modal" class="fixed inset-0 z-[94] hidden items-center justify-center p-4"
      style="background: rgba(0,0,0,0.55); backdrop-filter: blur(10px); padding-top: calc(16px + env(safe-area-inset-top)); padding-bottom: calc(16px + env(safe-area-inset-bottom));">
      <div class="w-full max-w-md card p-5 animate-pop" style="border-radius: 26px; max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 32px); overflow-y: auto; -webkit-overflow-scrolling: touch;">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-black" data-i18n="partnerDetails">ุชูุงุตูู ุงูุดุฑูู</div>
            <div id="partner-details-name" class="mt-1 text-sm font-black" style="color: var(--primary-2);"></div>
          </div>
          <button onclick="closePartnerDetails()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
            style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="mt-4 space-y-3">
          <div class="grid grid-cols-2 gap-2">
            <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="share">ุงููุตูุจ</div>
              <div id="partner-details-share" class="mt-1 text-sm font-black"></div>
            </div>
            <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="partnerDue">ุงููุณุชุญู</div>
              <div id="partner-details-due" class="mt-1 text-sm font-black"></div>
            </div>
          </div>

          <div class="p-4 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-sm font-black">ุงููุนูููุงุช</div>
                <div class="text-xs font-bold" style="color: var(--muted);">ุงูุงุณู โข ุงููุณุจุฉ โข ุงูุงุณุชุซูุงุฑ</div>
              </div>
              <button onclick="savePartnerDetailsCore()" class="btn px-4 py-2 rounded-2xl"
                style="background: color-mix(in srgb, var(--success) 12%, var(--surface)); border: 1px solid color-mix(in srgb, var(--success) 18%, var(--border)); color: color-mix(in srgb, var(--success) 92%, var(--fg));">
                <div class="flex items-center gap-2">
                  <i data-lucide="save" class="w-4 h-4"></i>
                  <span class="text-xs font-black">ุญูุธ</span>
                </div>
              </button>
            </div>

            <div class="mt-3 grid grid-cols-6 gap-2">
              <input id="partner-details-name-input" class="input col-span-4" type="text" placeholder="ุงูุงุณูโฆ" autocomplete="off" />
              <input id="partner-details-percent-input" class="input col-span-2 text-center" type="number" placeholder="%" min="0" max="100" inputmode="decimal" />
            </div>
            <div class="mt-2 grid grid-cols-6 gap-2">
              <input id="partner-details-invested-input" class="input col-span-3 text-center" type="number" placeholder="ุงุณุชุซูุงุฑ" min="0" inputmode="decimal" />
              <input id="partner-details-invested-at-input" class="input col-span-3" type="date" />
            </div>
            <div id="partner-details-core-msg" class="mt-2 text-[11px] font-bold" style="color: var(--muted);"></div>
          </div>

          <div class="p-4 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="profitSchedule">ููุนุฏ ุงูุฃุฑุจุงุญ</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="profitScheduleHint">ูุซูุงู ุดูุฑูุงู ุฃู ุฃุณุจูุนูุงู</div>
              </div>
            </div>
            <select id="partner-details-schedule" class="input mt-3" onchange="savePartnerDetailsMeta()">
              <option value="">โ</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="custom">Custom</option>
            </select>
            <textarea id="partner-details-notes" class="input mt-3" style="min-height: 84px;" placeholder="Notesโฆ" oninput="savePartnerDetailsMeta()"></textarea>
          </div>

          <div class="p-4 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-black" data-i18n="payouts">ุฏูุนุงุช ุงูุฃุฑุจุงุญ</div>
                <div class="text-xs font-bold" style="color: var(--muted);" data-i18n="payoutsHint">ุณุฌู ุดุญุงู ุชุฎูุต</div>
              </div>
              <div id="partner-details-paid" class="text-sm font-black"></div>
            </div>

            <div id="partner-payouts-list" class="mt-3 space-y-2"></div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="paymentAmount">ูููุฉ ุงูุฏูุนุฉ</label>
                <div class="relative">
                  <input id="partner-payout-amount" type="number" inputmode="decimal" class="input money-input" placeholder="0" />
                  <div class="money-currency"><span class="currency-symbol">DH</span></div>
                </div>
              </div>
              <div>
                <label class="block text-xs font-extrabold mb-2" style="color: var(--muted);" data-i18n="paymentDate">ุชุงุฑูุฎ ุงูุฏูุนุฉ</label>
                <input id="partner-payout-date" type="date" class="input" />
              </div>
            </div>

            <button onclick="addPartnerPayout()" class="btn w-full mt-3 py-3"
              style="background: color-mix(in srgb, var(--success) 12%, var(--surface)); border: 1px solid color-mix(in srgb, var(--success) 18%, var(--border)); color: color-mix(in srgb, var(--success) 92%, var(--fg));">
              <span class="font-black" data-i18n="addPayment">ุฅุถุงูุฉ ุฏูุนุฉ</span>
            </button>

            <button onclick="addPartnerPayoutDue()" class="btn w-full mt-2 py-3"
              style="background: linear-gradient(135deg, var(--primary), var(--primary-2)); color: white;">
              <div class="flex items-center justify-center gap-2">
                <i data-lucide="banknote" class="w-4 h-4"></i>
                <span class="font-black">ุฏูุน ุงููุณุชุญู</span>
              </div>
            </button>
          </div>
        </div>

        <div class="mt-4">
          <button onclick="closePartnerDetails()" class="btn w-full py-3"
            style="background: var(--surface-2); border: 1px solid var(--border);" data-i18n="close">ุฅุบูุงู</button>
        </div>
      </div>
    </div>

    <!-- Transaction details modal -->
    <div id="transaction-details-modal" class="fixed inset-0 z-[93] hidden items-center justify-center p-4"
      style="background: rgba(0,0,0,0.55); backdrop-filter: blur(10px); padding-top: calc(16px + env(safe-area-inset-top)); padding-bottom: calc(16px + env(safe-area-inset-bottom));">
      <div class="w-full max-w-md card p-5 animate-pop" style="border-radius: 26px; max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 32px); overflow-y: auto; -webkit-overflow-scrolling: touch;">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-black" data-i18n="transactionDetailsTitle">ุชูุงุตูู ุงูุนูููุฉ</div>
          </div>
          <button onclick="closeTransactionDetails()" class="w-10 h-10 rounded-2xl flex items-center justify-center"
            style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Close">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="mt-4 space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="itemName">ุดูู ูุงุฏ ุงูุณูุนุฉุ</div>
            <div id="txd-item" class="text-sm font-black text-right truncate"></div>
          </div>
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="debtTypeLabel">ุงูููุน</div>
            <div id="txd-type" class="text-sm font-black text-right truncate"></div>
          </div>
          <div class="flex items-center justify-between gap-3">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="date">ุงูุชุงุฑูุฎ</div>
            <div id="txd-date" class="text-sm font-black text-right truncate"></div>
          </div>
          <div id="txd-client-row" class="flex items-center justify-between gap-3 hidden">
            <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="clientName">ุดูููุ (ุงูุณููุฉ)</div>
            <div id="txd-client" class="text-sm font-black text-right truncate"></div>
          </div>

          <div class="mt-2 grid grid-cols-3 gap-2">
            <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="quantity">ุงูุนุฏุฏ</div>
              <div id="txd-qty" class="mt-1 text-sm font-black"></div>
            </div>
            <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="price">ุงูุซูู (ูููุญุฏุฉ)</div>
              <div id="txd-unit" class="mt-1 text-sm font-black"></div>
            </div>
            <div class="p-3 rounded-2xl" style="background: color-mix(in srgb, var(--primary) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--primary) 18%, var(--border));">
              <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="total">ุงููุฌููุน</div>
              <div id="txd-total" class="mt-1 text-sm font-black" style="color: var(--primary-2);"></div>
            </div>
          </div>

          <div id="txd-credit-box" class="hidden mt-2">
            <div class="grid grid-cols-2 gap-2">
              <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
                <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="amountPaid">ุดุญุงู ุนุทู ุฏุงุจุงุ</div>
                <div id="txd-paid" class="mt-1 text-sm font-black"></div>
              </div>
              <div class="p-3 rounded-2xl" style="background: color-mix(in srgb, var(--warn) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border));">
                <div class="text-[11px] font-extrabold" style="color: var(--muted);" data-i18n="remaining">ุงูุจุงูู</div>
                <div id="txd-remaining" class="mt-1 text-sm font-black" style="color: var(--warn);"></div>
              </div>
            </div>
            <div class="mt-2 flex items-center justify-between gap-3">
              <div class="text-xs font-extrabold" style="color: var(--muted);" data-i18n="debtDueDate">ุชุงุฑูุฎ ุงูุชุฐููุฑ</div>
              <div id="txd-reminder" class="text-sm font-black text-right truncate"></div>
            </div>
          </div>

          <div class="mt-3 p-3 rounded-2xl" style="background: color-mix(in srgb, var(--surface) 88%, transparent); border: 1px solid var(--border);">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2" style="color: var(--muted);">
                <i data-lucide="receipt" class="w-4 h-4"></i>
                <div class="text-xs font-extrabold" data-i18n="receipt">ูุตู</div>
              </div>
            </div>
            <pre id="txd-receipt" dir="rtl" class="mt-2 whitespace-pre-wrap text-base font-bold" style="color: var(--fg);"></pre>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-2 gap-2">
          <button id="txd-share" class="btn py-3" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-center gap-2"><i data-lucide="share-2" class="w-4 h-4"></i><span data-i18n="share">ุดุงุฑู</span></div>
          </button>
          <button id="txd-download" class="btn py-3" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i><span data-i18n="download">ุชุญููู</span></div>
          </button>
        </div>

        <div id="txd-credit-actions" class="mt-2 grid grid-cols-2 gap-2 hidden">
          <button id="txd-set-reminder" class="btn py-3"
            style="background: var(--surface-2); border: 1px solid var(--border);" data-i18n="reminderSet">ุญุฏุฏ ุชุฐููุฑ</button>
          <button id="txd-clear-reminder" class="btn py-3 hidden"
            style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border));" data-i18n="reminderClear">ุญูุฏ ุงูุชุฐููุฑ</button>
        </div>

        <div class="mt-2 grid grid-cols-2 gap-2">
          <button id="txd-delete" class="btn py-3"
            style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border));">
            <div class="flex items-center justify-center gap-2" style="color: color-mix(in srgb, var(--danger) 90%, var(--fg));">
              <i data-lucide="trash" class="w-4 h-4"></i>
              <span data-i18n="delete">ุญุฐู</span>
            </div>
          </button>
          <button id="txd-settle" class="btn py-3 text-white hidden" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));" data-i18n="settled">ุชุฎูุตุช</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast"
      class="fixed top-5 left-1/2 -translate-x-1/2 z-[100] opacity-0 -translate-y-6 transition-all duration-200">
      <div class="px-4 py-3 rounded-2xl flex items-center gap-3"
        style="background: color-mix(in srgb, var(--fg) 92%, #000); color: var(--bg); box-shadow: var(--shadow);">
        <span id="toast-icon" style="color: var(--success);"></span>
        <div id="toast-message" class="text-sm font-black">โฆ</div>
      </div>
    </div>

    <!-- Hidden debt reminder date picker -->
    <input id="debt-reminder-picker" type="date" class="hidden" />

  </div>

  <!-- Firebase (Compat) for in-app cloud backup/restore + Google sign-in -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>

  <script>
    // Make the app resilient when CDN scripts (lucide/tailwind) are unavailable in mobile WebView.
    // If lucide fails to load, we still want the app to boot and remove the loader.
    window.lucide = window.lucide || { createIcons: () => {} };

    // ==========================
    // Firebase (Google sign-in + Storage)
    // ==========================
    const FIREBASE_CONFIG = {
      apiKey: 'AIzaSyBXkU7WA5g2RJjBHN07V_TbNDmcL98LFjA',
      authDomain: 'tijarati-ec23b.firebaseapp.com',
      projectId: 'tijarati-ec23b',
      storageBucket: 'tijarati-ec23b.firebasestorage.app',
      messagingSenderId: '796219379032'
      // appId not strictly required with compat for this usage
    };

    function isNativeCloudMode() {
      const proto = (window.location && window.location.protocol) ? window.location.protocol : '';
      return proto === 'file:' && !!window.isNativeApp;
    }

    const Cloud = {
      user: null,
      init: async () => {
        try {
          const proto = (window.location && window.location.protocol) ? window.location.protocol : '';

          // Web mode: Firebase web compat.
          if (proto === 'http:' || proto === 'https:') {
            if (!window.firebase || !firebase.initializeApp) return;
            if (!firebase.apps || firebase.apps.length === 0) {
              firebase.initializeApp(FIREBASE_CONFIG);
            }

            firebase.auth().onAuthStateChanged((u) => {
              Cloud.user = u || null;
              Cloud.updateUi();
            });

            // If a redirect sign-in happened, finalize it (no-op otherwise)
            try { firebase.auth().getRedirectResult().catch(() => {}); } catch { }
            return;
          }

          // Native (mobile WebView under file://): use native Firebase bridge.
          if (isNativeCloudMode()) {
            const res = await nativeRequest('CLOUD_GET_USER', {});
            Cloud.user = res?.user || null;
            Cloud.updateUi();
            return;
          }

          // Unsupported origin.
          Cloud.user = null;
          Cloud.updateUi();
        } catch { }
      },
      updateUi: () => {
        const el = document.getElementById('cloud-user');
        const btnIn = document.getElementById('cloud-signin');
        const btnOut = document.getElementById('cloud-signout');

        if (el) {
          if (Cloud.user) el.textContent = `${Cloud.user.displayName || ''} ${Cloud.user.email ? '(' + Cloud.user.email + ')' : ''}`.trim();
          else el.textContent = '';
        }
        if (btnIn) btnIn.style.opacity = Cloud.user ? '0.55' : '1';
        if (btnOut) btnOut.style.opacity = Cloud.user ? '1' : '0.55';
      }
    };

    async function cloudSignIn() {
      try {
        const proto = (window.location && window.location.protocol) ? window.location.protocol : '';
        if (proto === 'http:' || proto === 'https:') {
          if (!window.firebase || !firebase.auth) throw new Error('Firebase not available');
          if (Cloud.user) return;
          const provider = new firebase.auth.GoogleAuthProvider();
          provider.setCustomParameters({ prompt: 'select_account' });
          // WebView friendly: redirect
          await firebase.auth().signInWithRedirect(provider);
          return;
        }

        if (isNativeCloudMode()) {
          const res = await nativeRequest('CLOUD_SIGNIN', {});
          if (res && res.success === false) throw new Error(res.error || 'Sign-in failed');
          Cloud.user = res?.user || null;
          Cloud.updateUi();
          showToast(t('signedIn') || 'Signed in', 'success');
          try { await cloudRefreshStatus({ skipSync: true }); } catch { }
          return;
        }

        showToast(t('cloudNotSupported') || 'Cloud requires http/https or the mobile app.', 'info');
      } catch (e) {
        showToast(String(e?.message || e || 'Auth error'), 'error');
      }
    }

    function openAuthModal() {
      try {
        const modal = document.getElementById('auth-modal');
        if (!modal) return;

        const sub = document.getElementById('auth-sub');
        if (sub) {
          if (Cloud.user) sub.textContent = `${t('cloudStatusSignedIn') || ''} ${Cloud.user.email ? 'โข ' + Cloud.user.email : ''}`.trim();
          else sub.textContent = t('cloudStatusSignedOut');
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        try { lucide.createIcons(); } catch { }

        setTimeout(() => {
          const email = document.getElementById('auth-email');
          if (email) email.focus();
        }, 60);
      } catch { }
    }

    function closeAuthModal() {
      const modal = document.getElementById('auth-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    async function authEmailSignIn() {
      try {
        if (!window.firebase || !firebase.auth) throw new Error('Firebase not available');
        const email = (document.getElementById('auth-email')?.value || '').trim();
        const pass = (document.getElementById('auth-password')?.value || '').trim();
        if (!email || !pass) {
          showToast(t('fillAll'), 'error');
          return;
        }
        await firebase.auth().signInWithEmailAndPassword(email, pass);
        closeAuthModal();
        showToast(t('signedIn') || 'Signed in', 'success');
      } catch (e) {
        showToast(String(e?.message || e || 'Sign in failed'), 'error');
      }
    }

    async function authEmailSignUp() {
      try {
        if (!window.firebase || !firebase.auth) throw new Error('Firebase not available');
        const email = (document.getElementById('auth-email')?.value || '').trim();
        const pass = (document.getElementById('auth-password')?.value || '').trim();
        if (!email || !pass) {
          showToast(t('fillAll'), 'error');
          return;
        }
        if (pass.length < 6) {
          showToast(t('passwordMin') || 'Password must be at least 6 characters', 'error');
          return;
        }
        await firebase.auth().createUserWithEmailAndPassword(email, pass);
        closeAuthModal();
        showToast(t('accountCreated') || 'Account created', 'success');
      } catch (e) {
        showToast(String(e?.message || e || 'Sign up failed'), 'error');
      }
    }

    async function authResetPassword() {
      try {
        if (!window.firebase || !firebase.auth) throw new Error('Firebase not available');
        const email = (document.getElementById('auth-email')?.value || '').trim();
        if (!email) {
          showToast(t('emailRequired') || 'Email is required', 'error');
          return;
        }
        await firebase.auth().sendPasswordResetEmail(email);
        showToast(t('resetSent') || 'Password reset email sent', 'success');
      } catch (e) {
        showToast(String(e?.message || e || 'Reset failed'), 'error');
      }
    }

    function authGoogleSignIn() {
      closeAuthModal();
      cloudSignIn();
    }

    async function cloudSignOut() {
      try {
        const proto = (window.location && window.location.protocol) ? window.location.protocol : '';
        if (proto === 'http:' || proto === 'https:') {
          if (!window.firebase || !firebase.auth) return;
          await firebase.auth().signOut();
          showToast(t('cloudSignOut') || 'Signed out', 'success');
          return;
        }

        if (isNativeCloudMode()) {
          const res = await nativeRequest('CLOUD_SIGNOUT', {});
          if (res && res.success === false) throw new Error(res.error || 'Sign out failed');
          Cloud.user = null;
          Cloud.updateUi();
          showToast(t('cloudSignOut') || 'Signed out', 'success');
        }
      } catch (e) {
        showToast(String(e?.message || e || 'Sign out failed'), 'error');
      }
    }

    async function cloudBackup() {
      try {
        const proto = (window.location && window.location.protocol) ? window.location.protocol : '';
        if (isNativeCloudMode()) {
          showBlockingOverlay(t('cloudBackup'), '...');
          await syncFromNative();

          const snapshot = {
            version: 3,
            createdAt: Date.now(),
            language: state.language,
            currency: state.currency,
            transactions: state.transactions || [],
            partners: state.partners || []
          };

          const txCount = Array.isArray(snapshot.transactions) ? snapshot.transactions.length : 0;
          const partnerCount = Array.isArray(snapshot.partners) ? snapshot.partners.length : 0;
          const manifest = {
            version: 1,
            createdAt: Date.now(),
            txCount,
            partnerCount,
            localRevision: typeof state.localRevision === 'number' ? state.localRevision : 0,
            lastLocalChangeAt: typeof state.lastLocalChangeAt === 'number' ? state.lastLocalChangeAt : 0
          };

          const res = await nativeRequest('CLOUD_BACKUP', { snapshot, manifest });
          if (res && res.success === false) throw new Error(res.error || 'Backup failed');
          const mf = res?.manifest || manifest;
          state.lastBackup = {
            cloudCreatedAt: Number(mf.createdAt || manifest.createdAt),
            txCount: Number(mf.txCount || manifest.txCount),
            partnerCount: Number(mf.partnerCount || manifest.partnerCount),
            localRevision: Number(mf.localRevision || manifest.localRevision)
          };
          saveState();
          showToast(t('cloudBackupDone'), 'success');
          try { await cloudRefreshStatus({ skipSync: true }); } catch { }
          return;
        }

        if (proto !== 'http:' && proto !== 'https:') {
          showToast(t('cloudNotSupported') || 'Cloud requires http/https or the mobile app.', 'info');
          return;
        }
        if (!Cloud.user) {
          showToast(t('cloudNeedLogin'), 'info');
          return;
        }
        if (!firebase.storage) throw new Error('Storage not available');

        showBlockingOverlay(t('cloudBackup'), '...');
        await syncFromNative();

        const snapshot = {
          version: 3,
          createdAt: Date.now(),
          language: state.language,
          currency: state.currency,
          transactions: state.transactions || [],
          partners: state.partners || []
        };

        const uid = Cloud.user.uid;
        const basePath = `tijarati_backups/${uid}`;
        const ref = firebase.storage().ref().child(`${basePath}/latest.json`);
        const manifestRef = firebase.storage().ref().child(`${basePath}/latest_manifest.json`);

        const txCount = Array.isArray(snapshot.transactions) ? snapshot.transactions.length : 0;
        const partnerCount = Array.isArray(snapshot.partners) ? snapshot.partners.length : 0;

        const manifest = {
          version: 1,
          createdAt: Date.now(),
          txCount,
          partnerCount,
          localRevision: typeof state.localRevision === 'number' ? state.localRevision : 0,
          lastLocalChangeAt: typeof state.lastLocalChangeAt === 'number' ? state.lastLocalChangeAt : 0
        };

        await ref.putString(JSON.stringify(snapshot), 'raw', { contentType: 'application/json' });
        await manifestRef.putString(JSON.stringify(manifest), 'raw', { contentType: 'application/json' });

        state.lastBackup = {
          cloudCreatedAt: manifest.createdAt,
          txCount: manifest.txCount,
          partnerCount: manifest.partnerCount,
          localRevision: manifest.localRevision
        };
        saveState();

        showToast(t('cloudBackupDone'), 'success');
        try { await cloudRefreshStatus({ skipSync: true }); } catch { }
      } catch (e) {
        showToast(String(e?.message || e || 'Backup failed'), 'error');
      } finally {
        try { hideBlockingOverlay(); } catch { }
      }
    }

    async function cloudRefreshStatus(opts = {}) {
      const statusEl = document.getElementById('cloud-status');
      if (!statusEl) return;

      if (isNativeCloudMode()) {
        try {
          statusEl.textContent = t('cloudStatusLoading');
          if (!opts.skipSync) await syncFromNative();

          const res = await nativeRequest('CLOUD_STATUS', {});
          Cloud.user = res?.user || null;
          Cloud.updateUi();

          const manifest = res?.manifest || null;
          const localTx = Array.isArray(state.transactions) ? state.transactions.length : 0;
          const localPartners = Array.isArray(state.partners) ? state.partners.length : 0;
          const localRev = typeof state.localRevision === 'number' ? state.localRevision : 0;

          if (!Cloud.user) {
            statusEl.textContent = t('cloudStatusSignedOut');
            return;
          }

          if (!manifest) {
            statusEl.textContent = `${t('cloudStatusNever')} โข ${t('cloudStatusLocalItems')}: ${localTx} tx, ${localPartners} partners โข ${t('cloudStatusPendingItems')}: ${localTx} tx, ${localPartners} partners`;
            return;
          }

          const cloudTx = Number(manifest.txCount || 0);
          const cloudPartners = Number(manifest.partnerCount || 0);
          const cloudAt = Number(manifest.createdAt || 0);
          const cloudRev = Number(manifest.localRevision || 0);

          const dateStr = cloudAt ? new Date(cloudAt).toLocaleString() : '';
          const inSync = cloudRev === localRev;
          const pendingTx = inSync ? 0 : localTx;
          const pendingPartners = inSync ? 0 : localPartners;

          statusEl.textContent = `${t('cloudStatusLast')}: ${dateStr || '-'} โข ${t('cloudStatusCloudItems')}: ${cloudTx} tx, ${cloudPartners} partners โข ${t('cloudStatusLocalItems')}: ${localTx} tx, ${localPartners} partners โข ${t('cloudStatusPendingItems')}: ${pendingTx} tx, ${pendingPartners} partners`;

          state.lastBackup = {
            cloudCreatedAt: cloudAt || Date.now(),
            txCount: cloudTx,
            partnerCount: cloudPartners,
            localRevision: cloudRev
          };
          saveState();
        } catch {
          statusEl.textContent = t('cloudStatusError');
        }
        return;
      }

      if (!Cloud.user) {
        statusEl.textContent = t('cloudStatusSignedOut');
        return;
      }

      try {
        if (!firebase.storage) throw new Error('Storage not available');
        statusEl.textContent = t('cloudStatusLoading');
        if (!opts.skipSync) await syncFromNative();

        const uid = Cloud.user.uid;
        const basePath = `tijarati_backups/${uid}`;
        const manifestRef = firebase.storage().ref().child(`${basePath}/latest_manifest.json`);

        let manifest = null;
        try {
          const url = await manifestRef.getDownloadURL();
          const res = await fetch(url);
          if (res.ok) manifest = await res.json();
        } catch {
          manifest = null;
        }

        const localTx = Array.isArray(state.transactions) ? state.transactions.length : 0;
        const localPartners = Array.isArray(state.partners) ? state.partners.length : 0;
        const localRev = typeof state.localRevision === 'number' ? state.localRevision : 0;

        if (!manifest) {
          statusEl.textContent = `${t('cloudStatusNever')} โข ${t('cloudStatusLocalItems')}: ${localTx} tx, ${localPartners} partners โข ${t('cloudStatusPendingItems')}: ${localTx} tx, ${localPartners} partners`;
          return;
        }

        const cloudTx = Number(manifest.txCount || 0);
        const cloudPartners = Number(manifest.partnerCount || 0);
        const cloudAt = Number(manifest.createdAt || 0);
        const cloudRev = Number(manifest.localRevision || 0);

        const dateStr = cloudAt ? new Date(cloudAt).toLocaleString() : '';
        const inSync = cloudRev === localRev;
        const pendingTx = inSync ? 0 : localTx;
        const pendingPartners = inSync ? 0 : localPartners;

        statusEl.textContent = `${t('cloudStatusLast')}: ${dateStr || '-'} โข ${t('cloudStatusCloudItems')}: ${cloudTx} tx, ${cloudPartners} partners โข ${t('cloudStatusLocalItems')}: ${localTx} tx, ${localPartners} partners โข ${t('cloudStatusPendingItems')}: ${pendingTx} tx, ${pendingPartners} partners`;

        state.lastBackup = {
          cloudCreatedAt: cloudAt || Date.now(),
          txCount: cloudTx,
          partnerCount: cloudPartners,
          localRevision: cloudRev
        };
        saveState();
      } catch {
        statusEl.textContent = t('cloudStatusError');
      }
    }

    async function cloudRestore() {
      try {
        const proto = (window.location && window.location.protocol) ? window.location.protocol : '';
        if (isNativeCloudMode()) {
          if (!confirm(t('cloudRestoreConfirm'))) return;
          showBlockingOverlay(t('cloudRestore'), '...');

          const res = await nativeRequest('CLOUD_RESTORE', {});
          if (res && res.success === false) throw new Error(res.error || 'Restore failed');
          const snapshot = res?.snapshot;
          const manifest = res?.manifest || null;
          if (!snapshot) {
            showToast(t('cloudNoBackup'), 'info');
            return;
          }

          // Overwrite local DB (native)
          await API.clearAllData();

          const txs = Array.isArray(snapshot.transactions) ? snapshot.transactions : [];
          const parts = Array.isArray(snapshot.partners) ? snapshot.partners : [];

          for (const tx of txs) await API.saveTransaction(tx);
          for (const p of parts) await API.savePartner(p);

          state.language = snapshot.language || state.language;
          state.currency = snapshot.currency || state.currency;

          if (manifest && typeof manifest.localRevision === 'number') {
            state.localRevision = manifest.localRevision;
            state.lastLocalChangeAt = typeof manifest.lastLocalChangeAt === 'number' ? manifest.lastLocalChangeAt : Date.now();
            state.lastBackup = {
              cloudCreatedAt: Number(manifest.createdAt || Date.now()),
              txCount: Number(manifest.txCount || 0),
              partnerCount: Number(manifest.partnerCount || 0),
              localRevision: Number(manifest.localRevision || 0)
            };
          } else {
            state.localRevision = (typeof state.localRevision === 'number' ? state.localRevision : 0) + 1;
            state.lastLocalChangeAt = Date.now();
            state.lastBackup = {
              cloudCreatedAt: Date.now(),
              txCount: Array.isArray(snapshot.transactions) ? snapshot.transactions.length : 0,
              partnerCount: Array.isArray(snapshot.partners) ? snapshot.partners.length : 0,
              localRevision: state.localRevision
            };
          }
          saveState();

          await syncFromNative();
          renderAll();
          showToast(t('cloudRestoreDone'), 'success');
          try { await cloudRefreshStatus({ skipSync: true }); } catch { }
          return;
        }

        if (proto !== 'http:' && proto !== 'https:') {
          showToast(t('cloudNotSupported') || 'Cloud requires http/https or the mobile app.', 'info');
          return;
        }
        if (!Cloud.user) {
          showToast(t('cloudNeedLogin'), 'info');
          return;
        }
        if (!confirm(t('cloudRestoreConfirm'))) return;
        if (!firebase.storage) throw new Error('Storage not available');

        showBlockingOverlay(t('cloudRestore'), '...');
        const uid = Cloud.user.uid;
        const basePath = `tijarati_backups/${uid}`;
        const ref = firebase.storage().ref().child(`${basePath}/latest.json`);
        const manifestRef = firebase.storage().ref().child(`${basePath}/latest_manifest.json`);

        // Read manifest if present (for status + revision alignment)
        let manifest = null;
        try {
          const mUrl = await manifestRef.getDownloadURL();
          const mRes = await fetch(mUrl);
          if (mRes.ok) manifest = await mRes.json();
        } catch {
          manifest = null;
        }

        let url = null;
        try {
          url = await ref.getDownloadURL();
        } catch {
          showToast(t('cloudNoBackup'), 'info');
          return;
        }

        const res = await fetch(url);
        if (!res.ok) throw new Error('Download failed');
        const snapshot = await res.json();

        // Overwrite local DB (native)
        await API.clearAllData();

        const txs = Array.isArray(snapshot.transactions) ? snapshot.transactions : [];
        const parts = Array.isArray(snapshot.partners) ? snapshot.partners : [];

        for (const tx of txs) {
          await API.saveTransaction(tx);
        }
        for (const p of parts) {
          await API.savePartner(p);
        }

        state.language = snapshot.language || state.language;
        state.currency = snapshot.currency || state.currency;

        // After restore, align local revision to the cloud snapshot's revision if available
        if (manifest && typeof manifest.localRevision === 'number') {
          state.localRevision = manifest.localRevision;
          state.lastLocalChangeAt = typeof manifest.lastLocalChangeAt === 'number' ? manifest.lastLocalChangeAt : Date.now();
          state.lastBackup = {
            cloudCreatedAt: Number(manifest.createdAt || Date.now()),
            txCount: Number(manifest.txCount || 0),
            partnerCount: Number(manifest.partnerCount || 0),
            localRevision: Number(manifest.localRevision || 0)
          };
        } else {
          // fallback: consider restored state as backed up (unknown revision)
          state.localRevision = (typeof state.localRevision === 'number' ? state.localRevision : 0) + 1;
          state.lastLocalChangeAt = Date.now();
          state.lastBackup = {
            cloudCreatedAt: Date.now(),
            txCount: Array.isArray(snapshot.transactions) ? snapshot.transactions.length : 0,
            partnerCount: Array.isArray(snapshot.partners) ? snapshot.partners.length : 0,
            localRevision: state.localRevision
          };
        }
        saveState();

        await syncFromNative();
        renderAll();
        showToast(t('cloudRestoreDone'), 'success');
        try { await cloudRefreshStatus({ skipSync: true }); } catch { }
      } catch (e) {
        showToast(String(e?.message || e || 'Restore failed'), 'error');
      } finally {
        try { hideBlockingOverlay(); } catch { }
      }
    }

    // ==========================
    // Native Security Bridge
    // ==========================
    function nativeRequest(type, payload) {
      return new Promise((resolve) => {
        const id = Date.now() + Math.random().toString();
        const handler = (event) => {
          let data = event && event.data;
          try { if (typeof data === 'string') data = JSON.parse(data); } catch { }
          if (data && data.id === id) {
            document.removeEventListener('message', handler);
            window.removeEventListener('message', handler);
            resolve(data.result);
          }
        };
        document.addEventListener('message', handler);
        window.addEventListener('message', handler);
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ id, type, payload }));
        } else {
          resolve({ success: false, error: 'Not supported' });
        }
      });
    }

    async function securityRefreshUi() {
      if (!window.isNativeApp) return;
      const status = await nativeRequest('SECURITY_GET', {});
      const el = document.getElementById('security-status');
      const label = document.getElementById('bio-label');

      if (el) {
        const pin = status?.pinEnabled ? t('pinEnabled') : t('pinDisabled');
        const bio = status?.biometricsAvailable
          ? (status?.biometricEnabled ? t('disableBiometric') : t('enableBiometric'))
          : t('biometricNotAvailable');
        el.textContent = `${pin} โข ${bio}`;
      }

      if (label) {
        if (!status?.biometricsAvailable) label.textContent = t('biometricNotAvailable');
        else label.textContent = status?.biometricEnabled ? t('disableBiometric') : t('enableBiometric');
      }
    }

    async function securitySetPin() {
      if (!window.isNativeApp) return;
      const pin = prompt(t('enterPin'));
      if (pin === null) return;
      const res = await nativeRequest('SECURITY_SET_PIN', { pin: String(pin) });
      if (res && res.success === false) {
        showToast(res.error || 'Failed', 'error');
      } else {
        showToast(t('pinEnabled'), 'success');
      }
      securityRefreshUi();
    }

    async function securityDisablePin() {
      if (!window.isNativeApp) return;
      const res = await nativeRequest('SECURITY_DISABLE_PIN', {});
      if (res && res.success === false) {
        showToast(res.error || 'Failed', 'error');
      } else {
        showToast(t('pinDisabled'), 'success');
      }
      securityRefreshUi();
    }

    async function securityToggleBiometric() {
      if (!window.isNativeApp) return;
      const status = await nativeRequest('SECURITY_GET', {});
      if (!status?.biometricsAvailable) {
        showToast(t('biometricNotAvailable'), 'info');
        return;
      }
      const next = !status?.biometricEnabled;
      const res = await nativeRequest('SECURITY_SET_BIOMETRIC', { enabled: next });
      if (res && res.success === false) {
        showToast(res.error || 'Failed', 'error');
      } else {
        showToast(next ? t('enableBiometric') : t('disableBiometric'), 'success');
      }
      securityRefreshUi();
    }

    // ==========================
    // Native Bridge
    // ==========================
    const API = {
      fetch: async (endpoint, options = {}) => {
        if (window.isNativeApp) {
          return API.bridgeCall(endpoint, options);
        }
        return null;
      },
      bridgeCall: (endpoint, options) => {
        return new Promise((resolve) => {
          const id = Date.now() + Math.random().toString();
          let type = '';
          let payload = null;

          if (endpoint === '/transactions' && options.method === 'POST') {
            type = 'SAVE_TRANSACTION';
            payload = JSON.parse(options.body);
          } else if (endpoint === '/transactions') {
            type = 'GET_TRANSACTIONS';
          } else if (endpoint === '/partners' && options.method === 'POST') {
            type = 'SAVE_PARTNER';
            payload = JSON.parse(options.body);
          } else if (endpoint === '/partners') {
            type = 'GET_PARTNERS';
          } else if (endpoint.startsWith('/partners/') && options.method === 'DELETE') {
            type = 'DELETE_PARTNER';
            const parts = endpoint.split('/');
            payload = { id: parts[parts.length - 1] };
          } else if (endpoint.startsWith('/transactions/') && options.method === 'DELETE') {
            type = 'DELETE_TRANSACTION';
            const parts = endpoint.split('/');
            payload = { id: parts[parts.length - 1] };
          } else if (endpoint === '/debt-reminders' && options.method === 'POST') {
            type = 'SCHEDULE_DEBT_REMINDER';
            payload = JSON.parse(options.body);
          } else if (endpoint.startsWith('/debt-reminders/') && options.method === 'DELETE') {
            type = 'CANCEL_DEBT_REMINDER';
            const parts = endpoint.split('/');
            payload = { id: decodeURIComponent(parts[parts.length - 1]) };
          } else if (endpoint === '/clear-all' && options.method === 'POST') {
            type = 'CLEAR_ALL_DATA';
            payload = null;
          } else if (endpoint === '/mock-data' && options.method === 'POST') {
            type = 'SET_MOCK_DATA';
            payload = JSON.parse(options.body);
          }

          const handler = (event) => {
            let data = event.data;
            try {
              if (typeof data === 'string') data = JSON.parse(data);
            } catch (e) { }

            if (data && data.id === id) {
              document.removeEventListener('message', handler);
              window.removeEventListener('message', handler);
              resolve(data.result);
            }
          };

          document.addEventListener('message', handler);
          window.addEventListener('message', handler);

          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({ id, type, payload }));
          }
        });
      },
      init: () => {
        const backHandler = (event) => {
          try {
            let data = event.data;
            if (typeof data === 'string') data = JSON.parse(data);
            if (data.type === 'GO_BACK') {
              handleBack();
            } else if (data.type === 'THEME_CHANGED') {
              window.systemTheme = data.payload;
              if (state.theme === 'system') applyTheme();
            }
          } catch (e) { }
        };
        document.addEventListener('message', backHandler);
        window.addEventListener('message', backHandler);
      },
      getTransactions: () => API.fetch('/transactions'),
      saveTransaction: (tx) => API.fetch('/transactions', { method: 'POST', body: JSON.stringify(tx) }),
      getPartners: () => API.fetch('/partners'),
      savePartner: (p) => API.fetch('/partners', { method: 'POST', body: JSON.stringify(p) }),
      deletePartner: (id) => API.fetch('/partners/' + id, { method: 'DELETE' }),
      deleteTransaction: (id) => API.fetch('/transactions/' + id, { method: 'DELETE' }),
      scheduleDebtReminder: (data) => API.fetch('/debt-reminders', { method: 'POST', body: JSON.stringify(data) }),
      cancelDebtReminder: (id) => API.fetch('/debt-reminders/' + encodeURIComponent(String(id)), { method: 'DELETE' }),
      clearAllData: () => API.fetch('/clear-all', { method: 'POST' }),
      setMockData: (enabled) => API.fetch('/mock-data', { method: 'POST', body: JSON.stringify({ enabled: !!enabled }) }),
      openExternal: (url) => {
        if (window.isNativeApp && window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'OPEN_EXTERNAL', payload: { url } }));
        } else {
          window.open(url, '_blank');
        }
      },
      saveFile: (fileName, content) => {
        return API.saveFileWithType(fileName, content, null);
      },
      saveFileWithType: (fileName, content, mimeType) => {
        return new Promise((resolve) => {
          if (window.isNativeApp && window.ReactNativeWebView) {
            const id = Date.now() + Math.random().toString();
            const handler = (event) => {
              let data = event.data;
              try { if (typeof data === 'string') data = JSON.parse(data); } catch (e) { }
              if (data && data.id === id) {
                document.removeEventListener('message', handler);
                window.removeEventListener('message', handler);
                resolve(data.result);
              }
            };
            document.addEventListener('message', handler);
            window.addEventListener('message', handler);
            window.ReactNativeWebView.postMessage(JSON.stringify({ id, type: 'SAVE_FILE', payload: { fileName, content, mimeType } }));
          } else {
            const mt = mimeType || (String(fileName || '').toLowerCase().endsWith('.txt') ? 'text/plain' : 'application/json');
            const dataStr = 'data:' + mt + ';charset=utf-8,' + encodeURIComponent(content);
            const a = document.createElement('a');
            a.setAttribute('href', dataStr);
            a.setAttribute('download', fileName);
            document.body.appendChild(a);
            a.click();
            a.remove();
            resolve({ success: true });
          }
        });
      },
      pickFile: () => {
        return new Promise((resolve) => {
          if (window.isNativeApp && window.ReactNativeWebView) {
            const id = Date.now() + Math.random().toString();
            const handler = (event) => {
              let data = event.data;
              try { if (typeof data === 'string') data = JSON.parse(data); } catch (e) { }
              if (data && data.id === id) {
                document.removeEventListener('message', handler);
                window.removeEventListener('message', handler);
                resolve(data.result);
              }
            };
            document.addEventListener('message', handler);
            window.addEventListener('message', handler);
            window.ReactNativeWebView.postMessage(JSON.stringify({ id, type: 'PICK_FILE', payload: {} }));
          } else {
            resolve({ success: false });
          }
        });
      }
    };

    function handleBack() {
      if (document.getElementById('confirm-modal') && !document.getElementById('confirm-modal').classList.contains('hidden')) { closeConfirm(); return; }
      if (document.getElementById('auth-modal') && !document.getElementById('auth-modal').classList.contains('hidden')) { closeAuthModal(); return; }
      if (document.getElementById('debt-details-modal') && !document.getElementById('debt-details-modal').classList.contains('hidden')) { closeDebtDetails(); return; }
      if (document.getElementById('transaction-details-modal') && !document.getElementById('transaction-details-modal').classList.contains('hidden')) { closeTransactionDetails(); return; }
      if (document.getElementById('transaction-modal') && !document.getElementById('transaction-modal').classList.contains('hidden')) { closeModal(); return; }
      if (document.getElementById('quick-add') && !document.getElementById('quick-add').classList.contains('hidden')) { closeQuickAdd(); return; }

      const authScreen = document.getElementById('auth-screen');
      if (authScreen && authScreen.classList.contains('active')) {
        goBack();
        return;
      }

      const settings = document.getElementById('settings-screen');
      if (settings && settings.classList.contains('active')) {
        closeSettings();
        return;
      }

      if (state.lastScreen && state.lastScreen !== 'home-screen') {
        goBack();
      } else {
        if (window.isNativeApp && window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'EXIT_APP' }));
        }
      }
    }

    // ==========================
    // State & config (v3)
    // ==========================
    const STORAGE_KEY = 'tijarati_pro_state_v3';

    let state = {
      language: 'darija',
      currency: 'MAD',
      theme: 'system', // 'light' | 'dark' | 'system'
      mockDataEnabled: false,
      pricingMode: 'unit',
      editingTxId: null,
      aiChat: [],
      aiConversations: [],
      aiActiveConversationId: null,
      stockSearch: '',
      stockSort: 'qty-desc',
      stockFilter: 'all',
      stockLowThreshold: 3,
      stockExpanded: {},
      partnerSearch: '',
      partnerSort: 'share-desc',
      partnerAddOpen: false,
      transactions: [],
      partners: [],
      localRevision: 0,
      lastLocalChangeAt: 0,
      lastBackup: null,
      currentFlow: null,
      paymentType: 'paid',
      lastScreen: 'home-screen'
    };

    // Base currency: MAD (store everything internally in MAD)
    const exchangeRates = { MAD: 1, EUR: 0.092, USD: 0.099 }; // 1 MAD -> X currency
    const currencySymbols = { MAD: 'DH', EUR: 'โฌ', USD: '$' };

    const translations = {
      darija: {
        appName: 'ุชุฌุงุฑุชู',
        loading: 'ูุชู ุงูุชุญุถูุฑโฆ',
        clearingData: 'ูุงููุณุญู ุงูุจูุงูุงุชโฆ',
        clearedDone: 'ุชู ุงููุณุญ!',
        clearFailed: 'ููุน ูุดูู ูุงููุณุญ',
        home: 'ุงูุฑุฆูุณูุฉ',
        history: 'ุงูุณุฌู',
        credit: 'ุงููุฑูุฏู',
        partners: 'ุงูุดุฑูุงุก',
        settings: 'ุงูุฅุนุฏุงุฏุงุช',
        appearance: 'ุงููุธูุฑ',
        appearanceHint: 'Light / Dark',
        language: 'ุงููุบุฉ',
        languageHint: 'ุจุฏูู ูุบุฉ ุงููุงุฌูุฉ',
        currency: 'ุงูุนููุฉ',
        currencyHint: 'ุงูุชุญููู ููููู ุชููุงุฆู',
        data: 'ุงูุจูุงูุงุช',
        dataHint: 'ุชุตุฏูุฑ/ุงุณุชูุฑุงุฏ ุฃู ูุณุญ',
        exportData: 'ุญูุธ ูุณุฎุฉ',
        importData: 'ุงุณุชูุฑุงุฏ',
        clearData: 'ูุณุญ ููุดู',
        enableMockData: 'ุฒูุฏ ุจูุงูุงุช ุชุฌุฑูุจูุฉ',
        disableMockData: 'ุญูุฏ ุจูุงูุงุช ุชุฌุฑูุจูุฉ',
        mockEnableConfirm: 'ุบุงุฏู ูุฒูุฏู ุจูุงูุงุช ุชุฌุฑูุจูุฉ ุจุงุด ุชุฌุฑูุจ ุงูุชุทุจูู. ุชูุฏุฑ ุชุญูุฏูู ูู ููุณ ุงูุฒุฑ.',
        mockDisableConfirm: 'ุบุงุฏู ูุญูุฏู ุบูุฑ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ูู ุชุฒุงุฏุช.',
        mockAdded: 'ุชุฒุงุฏู ุจูุงูุงุช ุชุฌุฑูุจูุฉ',
        mockRemoved: 'ุชุญูุฏู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ',
        mockNotAvailable: 'Mock data ูุงุชุฎุฏู ุบูุฑ ูุงูุชุทุจูู (Mobile)',
        yesDelete: 'ูุนูุ ุงูุณุญ',
        delete: 'ุญุฐู',
        cancel: 'ูุงุ ุฑุฌุน',
        income: 'ูููุณ ุฏุฎูู',
        expenses: 'ูููุณ ุฎุฑุฌู',
        netProfit: 'ุงูุฑุจุญ ุงูุตุงูู',
        cashFlow: 'ุชุฏูู ููุฏู',
        today: 'ุงูููู',
        allTime: 'ุงูุฅุฌูุงูู',
        quickActions: 'ุนูููุงุช ุณุฑูุนุฉ',
        tips: 'ูุตูุญุฉ: ุงุถุบุท (+) ููุฅุถุงูุฉ ุงูุณุฑูุนุฉ',
        newSale: 'ุจุนุช ุณูุนุฉ',
        newPurchase: 'ุดุฑูุช ุณูุนุฉ',
        saleHint: 'ุฏุฎู ูููุณ',
        purchaseHint: 'ุฎุฑุฌ ูููุณ',
        pendingDebts: 'ูููุณู ุนูุฏ ุงููุงุณ',
        recentActivity: 'ุขุฎุฑ ุงููุนุงููุงุช ุฏูุงูู',
        seeAll: 'ุดูู ุงููู',
        transactions: 'ุฌููุน ุงูุนูููุงุช',
        transaction: 'ุนูููุฉ',
        total: 'ุงููุฌููุน',
        itemName: 'ุดูู ูุงุฏ ุงูุณูุนุฉุ',
        price: 'ุงูุซูู (ูููุญุฏุฉ)',
        quantity: 'ุงูุนุฏุฏ',
        paymentStatus: 'ูุงุด ุชุฎูุตุชูุ',
        paymentHint: 'ุฎุงูุต ุฃู ูุฑูุฏู',
        paidLabel: 'ุฎุงูุต',
        creditLabel: 'ูุฑูุฏู',
        paidShort: 'ุฎุงูุต',
        creditShort: 'ูุฑูุฏู',
        clientName: 'ุดูููุ (ุงูุณููุฉ)',
        amountPaid: 'ุดุญุงู ุนุทู ุฏุงุจุงุ',
        remaining: 'ุงูุจุงูู',
        settled: 'ุชุฎูุตุช',
        debtDueDate: 'ุชุงุฑูุฎ ุงูุชุฐููุฑ',
        debtDueHint: 'ุฎูููุง ุฎุงููุฉ ุฅูุง ูุง ุจุบูุชูุด ุชุฐููุฑ',
        reminderSet: 'ุญุฏุฏ ุชุฐููุฑ',
        reminderClear: 'ุญูุฏ ุงูุชุฐููุฑ',
        noReminder: 'ุจูุง ุชุฐููุฑ',
        date: 'ุงูุชุงุฑูุฎ',
        save: 'ุณุฌู ุงูุนูููุฉ',
        quickAdd: 'ุฅุถุงูุฉ ุณุฑูุนุฉ',
        refresh: 'ุชุญุฏูุซ',
        creditBook: 'ุฏูุชุฑ ุงููุฑูุฏู',
        peopleOweYou: 'ูุงุณ ููุชุณุงููู ุฃู ูุชุง ูุงุชุณุงูููู',
        stock: 'ุงูุณูุนุฉ',
        stockAvailable: 'ูุชููุฑ',
        stockLow: 'ูููู',
        stockOut: 'ููุฐ',
        stockNegative: 'ูุงูุต',
        stockItems: 'ุณูุน',
        stockViewHistory: 'ุดูู ูุงูุณุฌู',
        stockQuickSale: 'ุจูุน',
        stockQuickPurchase: 'ุดุฑุง',
        stockLast: 'ุขุฎุฑ',
        stockInShort: 'IN',
        stockOutShort: 'OUT',
        stockNet: 'ุงูุตุงูู',
        avg: 'ูุชูุณุท',
        addPartner: 'ุฒูุฏ ุดุฑูู',
        partnerHint: 'ุงููุณุจุฉ ูู ุงูุฑุจุญ',
        add: 'ุฅุถุงูุฉ',
        deleteWarning: 'ุบุงุฏู ููุดู ููุดู!',
        confirmTitle: 'ุชุฃููุฏ',
        confirmAction: 'ูุนู',
        settleDebtConfirmMessage: 'ููุณุฌูู ูุงุฏ ุงูุฏูู ุจูู ุชูุฎููุตุ',
        debtDetailsTitle: 'ุชูุงุตูู ุงูุฏูู',
        debtTypeLabel: 'ุงูููุน',
        transactionDetailsTitle: 'ุชูุงุตูู ุงูุนูููุฉ',
        receipt: 'ูุตู',
        share: 'ุดุงุฑู',
        download: 'ุชุญููู',
        deleteTransactionTitle: 'ุญุฐู ุงูุนูููุฉ',
        deleted: 'ุชุญูุฏุงุช',
        search: 'ุจุญุซโฆ',
        searchDebts: 'ุจุญุซ ุจุงูุงุณู ุฃู ุงูุณูุนุฉโฆ',
        filterAll: 'ุงููู',
        filterSales: 'ุจูุน',
        filterPurchases: 'ุดุฑุง',
        filterCredits: 'ูุฑูุฏู',
        emptyToday: 'ูุงุฒุงู ูุง ุฏุฑุชู ูุงูู.',
        emptyHistory: 'ูุง ูุงููุงุด ุนูููุงุช ุญุชู ุฏุงุจุง.',
        emptyDebts: 'ูุง ูุงูู ุญุชู ุฏูู ูุนูู.',
        copied: 'ุชูุณุฎ ุงููุตู!',
        saved: 'ุชุณุฌูุงุช ุงูุนูููุฉ!',
        fillAll: 'ุนูุฑ ุงููุนูููุงุช ูุงููุฉ ุนุงูุงู',
        needClient: 'ูุชุจ ุณููุฉ ุงูุณูุฏ ูู ุฎุฏุง ุงููุฑูุฏู',

        // Pricing mode
        pricingMode: 'ุทุฑููุฉ ุงูุญุณุงุจ',
        pricingHint: 'ุฏุฎู ุงูุซูู ูุงูุนุฏุฏ ูุฎูู ุงูุชุทุจูู ูุญุณุจ',
        unitPriceMode: 'ุซูู ุงููุญุฏุฉ',
        totalPriceMode: 'ุงูุซูู ุงูุฅุฌูุงูู',
        unitPrice: 'ุงูุซูู (ูููุญุฏุฉ)',
        totalPrice: 'ุงูุซูู ุงูุฅุฌูุงูู',
        unitModeHint: 'ุฏุฎู ุซูู ุงููุญุฏุฉ ูุงูุนุฏุฏุ ูุงููุฌููุน ููุชุญุณุจ ุจูุญุฏู.',
        totalModeHint: 'ุฏุฎู ุงููุฌููุน ูุงูุนุฏุฏุ ูุซูู ุงููุญุฏุฉ ููุชุญุณุจ ุจูุญุฏู.',
        quantityRequired: 'ุฏุฎู ุงูุนุฏุฏ ุนุงูุงู',
        unitPriceRequired: 'ุฏุฎู ุซูู ุงููุญุฏุฉ ุนุงูุงู',
        totalPriceRequired: 'ุฏุฎู ุงููุฌููุน ุนุงูุงู',

        // AI
        ai: 'AI',
        aiAssistant: 'ูุณุงุนุฏ ุฐูู',
        aiToggleHint: 'ูุนูู/ููู ุงููุณุงุนุฏ (ููุฎุฏู ุบูุฑ ุนูู ุจูุงูุงุชู)',
        aiDisclaimer: 'ููุฌุงูุจ ุบูุฑ ุนูู ุจูุงูุงุชู ุฏุงุฎู ุงูุชุทุจูู ูุจุฃุฌูุจุฉ ูุตูุฑุฉ.',
        aiEmpty: 'ุณูููู ุนูู ุงูุฑุจุญุ ุงููุจูุนุงุชุ ุงููุตุงุฑููุ ุฃู ุงูุฏูููโฆ',
        aiDisabled: 'ูุนูู ุงููุณุงุนุฏ ูู ุงูุฅุนุฏุงุฏุงุช',
        aiDisabledShort: 'AI ุชููู',
        aiEnabled: 'AI ุฎุฏุงู',
        aiHelp: 'ุณูููู: ุงูุฑุจุญุ ุงููุจูุนุงุชุ ุงููุตุงุฑููุ ุงูุฏูููุ',
        aiExamples: 'ุฃูุซูุฉ',
        aiExamplesHint: 'ุถุบุท ุนูู ูุซุงู ุจุงุด ูุชูุชุจ',
        aiReviewAndApply: 'โ ูุงูู ุงูุชุฑุงุญ ููุชุบููุฑุงุช. ุฑุงุฌุนู ููู ุจุนุฏ ุถุบุท "ุชุทุจูู".',
        aiProposedChanges: 'ุงูุชุบููุฑุงุช ุงูููุชุฑุญุฉ',
        aiApply: 'ุชุทุจูู',
        aiPlanCanceled: 'ุชูุบู ุงูุงูุชุฑุงุญ',
        aiNoPlan: 'ูุง ูุงูู ุญุชู ุงูุชุฑุงุญ',
        aiNothingApplied: 'ูุง ุชุทุจู ุญุชู ุชุบููุฑ',
        aiAppliedTitle: 'ุทุจููุช ุงูุชุบููุฑุงุช',
        aiSomeSkipped: 'ุจุนุถ ุงูุฎุทูุงุช ูุง ุชุทุจูุงุชุด',
        aiOnline: 'Online',
        aiOffline: 'Offline',
        aiLocal: 'ูุถุน ูุญูู',
        aiServerOffline: 'ุงูุณูุฑูุฑ ุบูุฑ ูุชุตู',
        aiKeyMissing: 'ููุชุงุญ AI ูุง ูุงููุด',
        aiEndpointMissing: 'ุฎุฏูุฉ AI ูุง ุฎุฏุงูุงุด',
        aiHistory: 'ุงููุญุงุฏุซุงุช',
        aiHistoryHint: 'ุจุฏูู ุงููุญุงุฏุซุฉ ููุง ุจุฏุง ูุญุฏุฉ ุฌุฏูุฏุฉ',
        aiNewChat: 'ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ',
        aiDefaultChatTitle: 'ูุญุงุฏุซุฉ',
        aiExample1Label: 'ุฑุจุญ ุงูููู',
        aiExample1Prompt: 'ุดุญุงู ูู ุงูุฑุจุญ ุฏูุงูู ุงููููุ',
        aiExample2Label: 'ุฃูุซุฑ ุงูุณูุน ูุจููุนุฉ',
        aiExample2Prompt: 'ุดูู ููุง ุฃูุซุฑ ุงูุณูุน ูุจููุนุฉ ูุงุฏ ุงูุดูุฑุ',
        aiExample3Label: 'ุทุจูู ุงููุตุฉ',
        aiExample3Prompt: 'ุจุบูุช ูุฏูุฑ: ุดุฑูุช ุฎุฑูู ุจ 2000ุ ุฒุงุฏ ุฎุฑูู ุตุบูุฑุ ุจุนุช ุงูุฎุฑูู ุงููุจูุฑ ุจ 2500 ู ุฎููุช ุงูุตุบูุฑ. ุทุจูู ูุงุฏ ุงูุดู ูุงูุชุทุจูู.',
        aiIntroTitle: 'ุฃูุง ูุณุงุนุฏ TIJARATI',
        aiIntroBody: 'ุฎุฏูุชู ูุนุงููู ุชููู ุงูุฃุฑูุงู ุฏูุงูู ููุณุฌู ุชุบููุฑุงุช ุจุดูู ููุธู.',
        aiIntroCan1: 'ูุญุณุจ ุงูุฑุจุญ/ุงููุจูุนุงุช/ุงููุตุงุฑูู/ุงูุฏููู',
        aiIntroCan2: 'ููุชุฑุญ ุฎุทุฉ ุจุงุด ูุถูู ุนูููุงุช (ููู ุจุนุฏ ูุชุฃููุฏ ุจูู "ุชุทุจูู")',
        aiIntroCan3: 'ูุนุทูู ุงูุชุฑุงุญุงุช ุจุงุด ุชูุธู ุงูุณุฌู ูุงูุณูุน',
        aiHintSales: 'ุงููุจูุนุงุช',
        aiHintPurchases: 'ุงููุตุงุฑูู',
        aiHintAsk: 'ุชูุฏุฑ ุชุณูููู:',
        aiHintApply: 'ุฅูู ุจุบูุชู ูุทุจูู ุชุบููุฑุงุชุ ููู: "ุทุจูู" ููุง "apply".',

        // Installments
        installments: 'ุงูุชูุณูุท',
        installmentsHint: 'ุฅุฐุง ูุงู ุงูุณุฏุงุฏ ุนูู ุฏูุนุงุช',
        payment: 'ุฏูุนุฉ',
        noPayments: 'ูุงุฒุงู ูุง ูุงููุงุด ุฏูุนุงุช.',
        paymentAmount: 'ูููุฉ ุงูุฏูุนุฉ',
        paymentDate: 'ุชุงุฑูุฎ ุงูุฏูุนุฉ',
        addPayment: 'ุฅุถุงูุฉ ุฏูุนุฉ',
        paymentAmountRequired: 'ุฏุฎู ูููุฉ ุงูุฏูุนุฉ ุนุงูุงู',

        // Common
        clear: 'ูุณุญ',
        send: 'ุฅุฑุณุงู',
        editSale: 'ุชุนุฏูู ุงูุจูุน',
        editPurchase: 'ุชุนุฏูู ุงูุดุฑุงุก',

        // Partners
        invested: 'ุงูุงุณุชุซูุงุฑ',
        investedAt: 'ุชุงุฑูุฎ ุงูุงุณุชุซูุงุฑ',
        roi: 'ุงูุนุงุฆุฏ',
        whySplit: 'ุนูุงุด',
        profitTimesPercent: 'ุงูุฑุจุญ ร ุงููุณุจุฉ',
        partnerDetails: 'ุชูุงุตูู ุงูุดุฑูู',
        partnerDue: 'ุงููุณุชุญู',
        profitSchedule: 'ููุนุฏ ุงูุฃุฑุจุงุญ',
        profitScheduleHint: 'ูุซูุงู ุดูุฑูุงู ุฃู ุฃุณุจูุนูุงู',
        payouts: 'ุฏูุนุงุช ุงูุฃุฑุจุงุญ',
        payoutsHint: 'ุณุฌู ุดุญุงู ุชุฎูุต',
        close: 'ุฅุบูุงู',

        // Cloud
        cloud: 'ุงูุณุญุงุจุฉ',
        cloudHint: 'ูุณุฎ ุงุญุชูุงุทู ุนุจุฑ Google',
        cloudNotSupported: 'ุงูุณุญุงุจุฉ ูุชุญุชุงุฌ ุชุดุบูู ุงูุชุทุจูู ูู http/https (ุงูุณูุฑูุฑ).',
        cloudModeServer: 'ูุณุฎ ุงุญุชูุงุทู ุจุงูุณูุฑูุฑ',
        cloudModeServerHint: 'ูุงูููุจุงูู: ุงูุณุญุงุจุฉ ุฎุฏุงูุฉ ุนุจุฑ ุงูุณูุฑูุฑ. ุฏุฎูู Server URL ููู ุจุนุฏ ุฏูุฑ Backup/Restore.',
        serverUrl: 'Server URL',
        serverTest: 'Test',
        serverStatusNotSet: 'ุฎุงุตู ุชุนููุฑ Server URL.',
        serverStatusOk: 'ูุชุตู ุจุงูุณูุฑูุฑ',
        serverStatusFail: 'ูุงูุฏุฑูุงุด ููุตูู ููุณูุฑูุฑ',
        testing: 'ููุฌุฑุจูโฆ',
        cloudSignIn: 'ุชุณุฌูู ุงูุฏุฎูู',
        cloudSignOut: 'ุฎุฑูุฌ',
        cloudBackup: 'ูุณุฎ ุงุญุชูุงุทู ุงูุขู',
        cloudRestore: 'ุงุณุชุฑุฌุงุน ูู ุงูุณุญุงุจุฉ',
        cloudNeedLogin: 'ุณุฌูู ุงูุฏุฎูู ุงูุฃูู',
        cloudBackupDone: 'ุชุฏุงุฑ ุงููุณุฎ ุงูุงุญุชูุงุทู',
        cloudRestoreDone: 'ุชุฏุงุฑ ุงูุงุณุชุฑุฌุงุน',
        cloudNoBackup: 'ูุง ูุงููุงุด ูุณุฎุฉ ูุงูุณุญุงุจุฉ',
        cloudRestoreConfirm: 'ุบุงุฏู ูุชุจุฏูู ุจูุงูุงุชู ุงูุญุงููุฉ. ููููููุ',
        cloudRefreshStatus: 'ุชุญุฏูุซ ุงูุญุงูุฉ',
        cloudStatusSignedOut: 'ุณุฌูู ุงูุฏุฎูู ุจุงุด ุชุดูู ุงูุญุงูุฉ',
        cloudStatusSignedIn: 'ูุณุฌู ุงูุฏุฎูู',
        cloudStatusLoading: 'ูุงูุดููู ุญุงูุฉ ุงููุณุฎโฆ',
        cloudStatusError: 'ูุง ูุฏุฑูุงุด ูุฌูุจู ุญุงูุฉ ุงูุณุญุงุจุฉ',
        cloudStatusNever: 'ูุงุฒุงู ูุง ูุงูู ุญุชู ูุณุฎ ูุงูุณุญุงุจุฉ',
        cloudStatusLast: 'ุขุฎุฑ ูุณุฎ ูุงูุณุญุงุจุฉ',
        cloudStatusCloudItems: 'ููุฌูุฏ ูุงูุณุญุงุจุฉ',
        cloudStatusLocalItems: 'ูุญููุงู',
        cloudStatusPendingItems: 'ูุงุฒุงู ูุง ุชุฏุงุฑุด ููู ุงููุณุฎ',

        // Auth
        authTitle: 'ุชุณุฌูู ุงูุฏุฎูู',
        email: 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู',
        password: 'ูููุฉ ุงููุฑูุฑ',
        signIn: 'ุฏุฎูู',
        signUp: 'ุญุณุงุจ ุฌุฏูุฏ',
        resetPassword: 'ูุณูุช ูููุฉ ุงููุฑูุฑุ',
        continueWithGoogle: 'ุชุงุจุน ุนุจุฑ Google',
        signedIn: 'ุชู ุชุณุฌูู ุงูุฏุฎูู',
        accountCreated: 'ุชุฏุงุฑ ุงูุญุณุงุจ',
        passwordMin: 'ูููุฉ ุงููุฑูุฑ ุฎุงุตูุง ุชููู 6 ุญุฑูู ุนูู ุงูุฃูู',
        emailRequired: 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุถุฑูุฑู',
        resetSent: 'ุชุตููุท ุฅูููู ุฏูุงู ุงูุงุณุชุฑุฌุงุน',
        confirmPassword: 'ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ',
        passwordsDontMatch: 'ูููุฉ ุงููุฑูุฑ ูุงุดู ุจุญุงู ุจุญุงู'
      },
      arabic: {
        appName: 'ุชุฌุงุฑุชู',
        loading: 'ูุชู ุงูุชุญุถูุฑโฆ',
        clearingData: 'ุฌุงุฑู ูุณุญ ุงูุจูุงูุงุชโฆ',
        clearedDone: 'ุชู ุงููุณุญ!',
        clearFailed: 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุณุญ',
        home: 'ุงูุฑุฆูุณูุฉ',
        history: 'ุงูุณุฌู',
        credit: 'ุงูุฏููู',
        partners: 'ุงูุดุฑูุงุก',
        settings: 'ุงูุฅุนุฏุงุฏุงุช',
        appearance: 'ุงููุธูุฑ',
        appearanceHint: 'ูุงุชุญ / ุฏุงูู',
        language: 'ุงููุบุฉ',
        languageHint: 'ุชุบููุฑ ูุบุฉ ุงููุงุฌูุฉ',
        currency: 'ุงูุนููุฉ',
        currencyHint: 'ูุชู ุงูุชุญููู ุชููุงุฆูุงู',
        data: 'ุงูุจูุงูุงุช',
        dataHint: 'ุชุตุฏูุฑ/ุงุณุชูุฑุงุฏ ุฃู ูุณุญ',
        exportData: 'ุชุตุฏูุฑ',
        importData: 'ุงุณุชูุฑุงุฏ',
        clearData: 'ูุณุญ ุงูุจูุงูุงุช',
        enableMockData: 'ุฅุถุงูุฉ ุจูุงูุงุช ุชุฌุฑูุจูุฉ',
        disableMockData: 'ุญุฐู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ',
        mockEnableConfirm: 'ุณูุชู ุฅุถุงูุฉ ุจูุงูุงุช ุชุฌุฑูุจูุฉ ูุงุฎุชุจุงุฑ ุงูุชุทุจูู. ููููู ุญุฐููุง ูู ููุณ ุงูุฒุฑ.',
        mockDisableConfirm: 'ุณูุชู ุญุฐู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ููุท.',
        mockAdded: 'ุชูุช ุฅุถุงูุฉ ุจูุงูุงุช ุชุฌุฑูุจูุฉ',
        mockRemoved: 'ุชู ุญุฐู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ',
        mockNotAvailable: 'ุชุนูู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ ูู ุชุทุจูู ุงููุงุชู ููุท',
        yesDelete: 'ูุนูุ ุงุญุฐู',
        delete: 'ุญุฐู',
        cancel: 'ุฅูุบุงุก',
        income: 'ุงูุฅูุฑุงุฏุงุช',
        expenses: 'ุงููุตุฑููุงุช',
        netProfit: 'ุตุงูู ุงูุฑุจุญ',
        cashFlow: 'ุชุฏูู ููุฏู',
        today: 'ุงูููู',
        allTime: 'ุงูุฅุฌูุงูู',
        quickActions: 'ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ',
        tips: 'ูุตูุญุฉ: ุงุถุบุท (+) ููุฅุถุงูุฉ ุงูุณุฑูุนุฉ',
        newSale: 'ุจูุน ุฌุฏูุฏ',
        newPurchase: 'ุดุฑุงุก ุฌุฏูุฏ',
        saleHint: 'ุฅูุฑุงุฏ',
        purchaseHint: 'ูุตุฑูู',
        pendingDebts: 'ุฏููู ูุนููุฉ',
        recentActivity: 'ุงููุดุงุท ุงูุฃุฎูุฑ',
        seeAll: 'ุนุฑุถ ุงููู',
        transactions: 'ุงููุนุงููุงุช',
        transaction: 'ุนูููุฉ',
        total: 'ุงููุฌููุน',
        itemName: 'ุงุณู ุงูุตูู',
        price: 'ุงูุณุนุฑ (ูููุญุฏุฉ)',
        quantity: 'ุงููููุฉ',
        paymentStatus: 'ุญุงูุฉ ุงูุฏูุน',
        paymentHint: 'ูุฏููุน ุฃู ุฏูู',
        paidLabel: 'ุฎุงูุต',
        creditLabel: 'ูุฑูุฏู',
        paidShort: 'ูุฏููุน',
        creditShort: 'ุฏูู',
        clientName: 'ุงุณู ุงูุนููู',
        amountPaid: 'ุงููุจูุบ ุงููุฏููุน',
        remaining: 'ุงููุชุจูู',
        settled: 'ุชู ุงูุณุฏุงุฏ',
        debtDueDate: 'ุชุงุฑูุฎ ุงูุชุฐููุฑ',
        debtDueHint: 'ุงุชุฑูู ูุงุฑุบุงู ุฅุฐุง ูุง ุชุฑูุฏ ุชุฐููุฑุงู',
        reminderSet: 'ุชุญุฏูุฏ ุชุฐููุฑ',
        reminderClear: 'ุญุฐู ุงูุชุฐููุฑ',
        noReminder: 'ุจุฏูู ุชุฐููุฑ',
        date: 'ุงูุชุงุฑูุฎ',
        save: 'ุญูุธ',
        quickAdd: 'ุฅุถุงูุฉ ุณุฑูุนุฉ',
        refresh: 'ุชุญุฏูุซ',
        creditBook: 'ุฏูุชุฑ ุงูุฏููู',
        peopleOweYou: 'ุงูุงุณ ูุฏูููู ูู ุฃู ุฃูุช ูุฏูู ููู',
        stock: 'ุงูุณูุนุฉ',
        addPartner: 'ุฅุถุงูุฉ ุดุฑูู',
        partnerHint: 'ุงููุณุจุฉ ูู ุงูุฃุฑุจุงุญ',
        add: 'ุฅุถุงูุฉ',
        deleteWarning: 'ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช',
        confirmTitle: 'ุชุฃููุฏ',
        confirmAction: 'ุชุฃููุฏ',
        settleDebtConfirmMessage: 'ูู ุชุฑูุฏ ุชุณุฌูู ูุฐุง ุงูุฏูู ูููุณุฏููุฏุ',
        debtDetailsTitle: 'ุชูุงุตูู ุงูุฏูู',
        debtTypeLabel: 'ุงูููุน',
        transactionDetailsTitle: 'ุชูุงุตูู ุงูุนูููุฉ',
        receipt: 'ุฅูุตุงู',
        share: 'ูุดุงุฑูุฉ',
        download: 'ุชุญููู',
        deleteTransactionTitle: 'ุญุฐู ุงูุนูููุฉ',
        deleted: 'ุชู ุงูุญุฐู',
        search: 'ุจุญุซโฆ',
        searchDebts: 'ุจุญุซ ุจุงูุงุณู ุฃู ุงูุณูุนุฉโฆ',
        filterAll: 'ุงููู',
        filterSales: 'ูุจูุนุงุช',
        filterPurchases: 'ูุดุชุฑูุงุช',
        filterCredits: 'ุฏููู',
        emptyToday: 'ูุง ุชูุฌุฏ ุนูููุงุช ุจุนุฏ.',
        emptyHistory: 'ูุง ุชูุฌุฏ ุนูููุงุช.',
        emptyDebts: 'ูุง ุชูุฌุฏ ุฏููู ูุนูููุฉ.',
        copied: 'ุชู ูุณุฎ ุงููุตู!',
        saved: 'ุชู ุญูุธ ุงูุนูููุฉ!',
        fillAll: 'ูุฑุฌู ุฅุฏุฎุงู ุงููุนูููุงุช ูุงููุฉ',
        needClient: 'ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุนููู',

        // Pricing mode
        pricingMode: 'ุทุฑููุฉ ุงูุญุณุงุจ',
        pricingHint: 'ุฃุฏุฎู ุงูุณุนุฑ ูุงููููุฉ ูุณูุญุณุจ ุงูุชุทุจูู',
        unitPriceMode: 'ุณุนุฑ ุงููุญุฏุฉ',
        totalPriceMode: 'ุงูุณุนุฑ ุงูุฅุฌูุงูู',
        unitPrice: 'ุงูุณุนุฑ (ูููุญุฏุฉ)',
        totalPrice: 'ุงูุณุนุฑ ุงูุฅุฌูุงูู',
        unitModeHint: 'ุฃุฏุฎู ุณุนุฑ ุงููุญุฏุฉ ูุงููููุฉุ ูุณููุญุณุจ ุงููุฌููุน ุชููุงุฆูุงู.',
        totalModeHint: 'ุฃุฏุฎู ุงููุฌููุน ูุงููููุฉุ ูุณููุญุณุจ ุณุนุฑ ุงููุญุฏุฉ ุชููุงุฆูุงู.',
        quantityRequired: 'ูุฑุฌู ุฅุฏุฎุงู ุงููููุฉ',
        unitPriceRequired: 'ูุฑุฌู ุฅุฏุฎุงู ุณุนุฑ ุงููุญุฏุฉ',
        totalPriceRequired: 'ูุฑุฌู ุฅุฏุฎุงู ุงูุณุนุฑ ุงูุฅุฌูุงูู',

        // AI
        ai: 'ุงูุฐูุงุก',
        aiAssistant: 'ูุณุงุนุฏ ุฐูู',
        aiToggleHint: 'ุชุดุบูู/ุฅููุงู ุงููุณุงุนุฏ (ูุณุชุฎุฏู ุจูุงูุงุชู ุฏุงุฎู ุงูุชุทุจูู ููุท)',
        aiDisclaimer: 'ูุฌูุจ ููุท ุนูู ุจูุงูุงุชู ุฏุงุฎู ุงูุชุทุจูู ูุจุฅุฌุงุจุงุช ูุตูุฑุฉ.',
        aiEmpty: 'ุงุณุฃููู ุนู ุงูุฑุจุญุ ุงููุจูุนุงุชุ ุงููุตุงุฑููุ ุฃู ุงูุฏูููโฆ',
        aiDisabled: 'ูุนูู ุงููุณุงุนุฏ ูู ุงูุฅุนุฏุงุฏุงุช',
        aiDisabledShort: 'ุชู ุฅููุงู AI',
        aiEnabled: 'ุชู ุชุดุบูู AI',
        aiHelp: 'ุงุณุฃููู: ุงูุฑุจุญุ ุงููุจูุนุงุชุ ุงููุตุงุฑููุ ุงูุฏูููุ',
        aiExamples: 'ุฃูุซูุฉ',
        aiExamplesHint: 'ุงุถุบุท ุนูู ูุซุงู ููุชุงุจุชู',
        aiReviewAndApply: 'โ ูุฏู ุงูุชุฑุงุญ ุชุบููุฑุงุช. ุฑุงุฌุนู ุซู ุงุถุบุท "ุชุทุจูู".',
        aiProposedChanges: 'ุงูุชุบููุฑุงุช ุงูููุชุฑุญุฉ',
        aiApply: 'ุชุทุจูู',
        aiPlanCanceled: 'ุชู ุฅูุบุงุก ุงูุงูุชุฑุงุญ',
        aiNoPlan: 'ูุง ููุฌุฏ ุงูุชุฑุงุญ',
        aiNothingApplied: 'ูู ูุชู ุชุทุจูู ุดูุก',
        aiAppliedTitle: 'ุชู ุชุทุจูู ุงูุชุบููุฑุงุช',
        aiSomeSkipped: 'ุชู ุชุฎุทู ุจุนุถ ุงูุฎุทูุงุช',
        aiOnline: 'ูุชุตู',
        aiOffline: 'ุบูุฑ ูุชุตู',
        aiLocal: 'ูุถุน ูุญูู',
        aiServerOffline: 'ุงูุฎุงุฏู ุบูุฑ ูุชุตู',
        aiKeyMissing: 'ููุชุงุญ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุบูุฑ ููุฌูุฏ',
        aiEndpointMissing: 'ููุทุฉ AI ุบูุฑ ููุฌูุฏุฉ',
        aiHistory: 'ุณุฌู ุงููุญุงุฏุซุงุช',
        aiHistoryHint: 'ุจุฏูู ุงููุญุงุฏุซุฉ ุฃู ุงุจุฏุฃ ูุงุญุฏุฉ ุฌุฏูุฏุฉ',
        aiNewChat: 'ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ',
        aiDefaultChatTitle: 'ูุญุงุฏุซุฉ',
        aiExample1Label: 'ุฑุจุญ ุงูููู',
        aiExample1Prompt: 'ูู ูู ุฑุจุญู ุงููููุ',
        aiExample2Label: 'ุฃูุซุฑ ุงูุณูุน ูุจูุนุงู',
        aiExample2Prompt: 'ูุง ูู ุฃูุซุฑ ุงูุณูุน ูุจูุนุงู ูุฐุง ุงูุดูุฑุ',
        aiExample3Label: 'ุชุทุจูู ูุตุฉ',
        aiExample3Prompt: 'ุฃุฑูุฏ: ุงุดุชุฑูุช ุฎุฑููุงู ุจู 2000ุ ููุฏ ุฎุฑูู ุตุบูุฑุ ุจุนุช ุงูุฎุฑูู ุงููุจูุฑ ุจู 2500 ูุงุญุชูุธุช ุจุงูุตุบูุฑ. ุทุจูู ูุฐุง ูู ุงูุชุทุจูู.',
        aiIntroTitle: 'ุฃูุง ูุณุงุนุฏ TIJARATI',
        aiIntroBody: 'ูููุชู ูุณุงุนุฏุชู ูู ููู ุฃุฑูุงูู ูุชูุธูู ุนูููุงุชู ุฏุงุฎู ุงูุชุทุจูู.',
        aiIntroCan1: 'ุฃุญุณุจ ุงูุฑุจุญ/ุงููุจูุนุงุช/ุงููุตุงุฑูู/ุงูุฏููู',
        aiIntroCan2: 'ุฃูุชุฑุญ ุฎุทุฉ ูุฅุถุงูุฉ ุนูููุงุช (ุซู ุฃูุช ุชุคูุฏ ุจู "ุชุทุจูู")',
        aiIntroCan3: 'ุฃุนุทูู ุฎุทูุงุช ุนูููุฉ ูุชุญุณูู ุณุฌููู',
        aiHintSales: 'ุงููุจูุนุงุช',
        aiHintPurchases: 'ุงููุตุงุฑูู',
        aiHintAsk: 'ููููู ุฃู ุชุณุฃู:',
        aiHintApply: 'ุฅุฐุง ุฃุฑุฏุช ุชุทุจูู ุชุบููุฑุงุช ูู: "ุทุจูู" ุฃู "apply".',

        // Installments
        installments: 'ุงูุชูุณูุท',
        installmentsHint: 'ุฅุฐุง ูุงู ุงูุณุฏุงุฏ ุนูู ุฏูุนุงุช',
        payment: 'ุฏูุนุฉ',
        noPayments: 'ูุง ุชูุฌุฏ ุฏูุนุงุช ุจุนุฏ.',
        paymentAmount: 'ูููุฉ ุงูุฏูุนุฉ',
        paymentDate: 'ุชุงุฑูุฎ ุงูุฏูุนุฉ',
        addPayment: 'ุฅุถุงูุฉ ุฏูุนุฉ',
        paymentAmountRequired: 'ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ุงูุฏูุนุฉ',

        // Common
        clear: 'ูุณุญ',
        send: 'ุฅุฑุณุงู',
        editSale: 'ุชุนุฏูู ุจูุน',
        editPurchase: 'ุชุนุฏูู ุดุฑุงุก',

        // Partners
        invested: 'ุงูุงุณุชุซูุงุฑ',
        investedAt: 'ุชุงุฑูุฎ ุงูุงุณุชุซูุงุฑ',
        roi: 'ุงูุนุงุฆุฏ',
        whySplit: 'ููุงุฐุง',
        profitTimesPercent: 'ุงูุฑุจุญ ร ุงููุณุจุฉ',
        partnerDetails: 'ุชูุงุตูู ุงูุดุฑูู',
        partnerDue: 'ุงููุณุชุญู',
        profitSchedule: 'ููุนุฏ ุงูุฃุฑุจุงุญ',
        profitScheduleHint: 'ูุซูุงู ุดูุฑูุงู ุฃู ุฃุณุจูุนูุงู',
        payouts: 'ุฏูุนุงุช ุงูุฃุฑุจุงุญ',
        payoutsHint: 'ุณุฌูู ุงููุฏููุนุงุช',
        close: 'ุฅุบูุงู',

        // Cloud
        cloud: 'ุงูุณุญุงุจุฉ',
        cloudHint: 'ูุณุฎ ุงุญุชูุงุทู ุนุจุฑ Google',
        cloudNotSupported: 'ููุฒุงุช ุงูุณุญุงุจุฉ ุชุชุทูุจ ุชุดุบูู ุงูุชุทุจูู ุนูู http/https (ุงูุฎุงุฏู).',
        cloudModeServer: 'ูุณุฎ ุงุญุชูุงุทู ุนุจุฑ ุงูุฎุงุฏู',
        cloudModeServerHint: 'ูู ุงููุงุชู: ุงูุณุญุงุจุฉ ุชุนูู ุนุจุฑ ุงูุฎุงุฏู. ุถุน Server URL ุซู ูู ุจู Backup/Restore.',
        serverUrl: 'Server URL',
        serverTest: 'Test',
        serverStatusNotSet: 'ูุฑุฌู ุฅุฏุฎุงู Server URL.',
        serverStatusOk: 'ุชู ุงูุงุชุตุงู ุจุงูุฎุงุฏู',
        serverStatusFail: 'ุชุนุฐุฑ ุงูุงุชุตุงู ุจุงูุฎุงุฏู',
        testing: 'ุฌุงุฑู ุงูุงุฎุชุจุงุฑโฆ',
        cloudSignIn: 'ุชุณุฌูู ุงูุฏุฎูู',
        cloudSignOut: 'ุชุณุฌูู ุงูุฎุฑูุฌ',
        cloudBackup: 'ูุณุฎ ุงุญุชูุงุทู ุงูุขู',
        cloudRestore: 'ุงุณุชุฑุฌุงุน ูู ุงูุณุญุงุจุฉ',
        cloudNeedLogin: 'ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู',
        cloudBackupDone: 'ุชู ุฑูุน ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ',
        cloudRestoreDone: 'ุชู ุงูุงุณุชุฑุฌุงุน',
        cloudNoBackup: 'ูุง ุชูุฌุฏ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุงูุณุญุงุจุฉ',
        cloudRestoreConfirm: 'ุณูุชู ุงุณุชุจุฏุงู ุจูุงูุงุชู ุงูุญุงููุฉ. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ',
        cloudRefreshStatus: 'ุชุญุฏูุซ ุงูุญุงูุฉ',
        cloudStatusSignedOut: 'ุณุฌูู ุงูุฏุฎูู ูุนุฑุถ ุญุงูุฉ ุงูุณุญุงุจุฉ',
        cloudStatusSignedIn: 'ุชู ุชุณุฌูู ุงูุฏุฎูู',
        cloudStatusLoading: 'ุฌุงุฑู ุงูุชุญูู ูู ุญุงูุฉ ุงููุณุฎโฆ',
        cloudStatusError: 'ุชุนุฐุฑ ุชุญููู ุญุงูุฉ ุงูุณุญุงุจุฉ',
        cloudStatusNever: 'ูุง ุชูุฌุฏ ูุณุฎุฉ ูู ุงูุณุญุงุจุฉ ุจุนุฏ',
        cloudStatusLast: 'ุขุฎุฑ ูุณุฎ ูู ุงูุณุญุงุจุฉ',
        cloudStatusCloudItems: 'ุชู ูุณุฎู',
        cloudStatusLocalItems: 'ูุญููุงู',
        cloudStatusPendingItems: 'ุบูุฑ ููุณูุฎ ุจุนุฏ',

        // Auth
        authTitle: 'ุชุณุฌูู ุงูุฏุฎูู',
        email: 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู',
        password: 'ูููุฉ ุงููุฑูุฑ',
        signIn: 'ุฏุฎูู',
        signUp: 'ุฅูุดุงุก ุญุณุงุจ',
        resetPassword: 'ูุณูุช ูููุฉ ุงููุฑูุฑุ',
        continueWithGoogle: 'ุชุงุจุน ุนุจุฑ Google',
        signedIn: 'ุชู ุชุณุฌูู ุงูุฏุฎูู',
        accountCreated: 'ุชู ุฅูุดุงุก ุงูุญุณุงุจ',
        passwordMin: 'ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู',
        emailRequired: 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุทููุจ',
        resetSent: 'ุชู ุฅุฑุณุงู ุฑุงุจุท ุงูุงุณุชุฑุฌุงุน',
        confirmPassword: 'ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ',
        passwordsDontMatch: 'ูููุชุง ุงููุฑูุฑ ุบูุฑ ูุชุทุงุจูุชูู'
      },
      french: {
        appName: 'TIJARATI',
        loading: 'Chargementโฆ',
        clearingData: 'Suppression des donnรฉesโฆ',
        clearedDone: 'Terminรฉ !',
        clearFailed: 'รchec de la suppression',
        home: 'Accueil',
        history: 'Historique',
        credit: 'Crรฉdits',
        partners: 'Partenaires',
        settings: 'Paramรจtres',
        appearance: 'Apparence',
        appearanceHint: 'Clair / Sombre',
        language: 'Langue',
        languageHint: "Changer la langue de l'interface",
        currency: 'Devise',
        currencyHint: 'Conversion automatique',
        data: 'Donnรฉes',
        dataHint: 'Exporter/Importer/Supprimer',
        exportData: 'Exporter',
        importData: 'Importer',
        clearData: 'Tout effacer',
        enableMockData: 'Ajouter des donnรฉes test',
        disableMockData: 'Supprimer les donnรฉes test',
        mockEnableConfirm: "Ajouter des donnรฉes de test pour essayer l'app. Vous pourrez les supprimer via le mรชme bouton.",
        mockDisableConfirm: 'Supprimer uniquement les donnรฉes de test ajoutรฉes.',
        mockAdded: 'Donnรฉes test ajoutรฉes',
        mockRemoved: 'Donnรฉes test supprimรฉes',
        mockNotAvailable: 'Les donnรฉes test ne sont dispo que sur mobile',
        yesDelete: 'Oui, supprimer',
        delete: 'Supprimer',
        cancel: 'Annuler',
        income: 'Entrรฉes',
        expenses: 'Sorties',
        netProfit: 'Bรฉnรฉfice net',
        cashFlow: 'Cash flow',
        today: "Aujourd'hui",
        allTime: 'Total',
        quickActions: 'Actions rapides',
        tips: 'Astuce : bouton (+) pour ajouter vite',
        newSale: 'Nouvelle vente',
        newPurchase: 'Nouvel achat',
        saleHint: 'Entrรฉe',
        purchaseHint: 'Sortie',
        pendingDebts: 'Crรฉdits en cours',
        recentActivity: 'Activitรฉ rรฉcente',
        seeAll: 'Voir tout',
        transactions: 'Transactions',
        transaction: 'Transaction',
        total: 'Total',
        itemName: 'Article',
        price: 'Prix (unitรฉ)',
        quantity: 'Quantitรฉ',
        paymentStatus: 'Paiement',
        paymentHint: 'Payรฉ ou crรฉdit',
        paidLabel: 'Payรฉ',
        creditLabel: 'Crรฉdit',
        paidShort: 'Payรฉ',
        creditShort: 'Crรฉdit',
        clientName: 'Client',
        amountPaid: 'Montant payรฉ',
        remaining: 'Restant',
        settled: 'Rรฉglรฉ',
        debtDueDate: 'Date rappel',
        debtDueHint: 'Laissez vide si pas de rappel',
        reminderSet: 'Dรฉfinir rappel',
        reminderClear: 'Supprimer rappel',
        noReminder: 'Pas de rappel',
        date: 'Date',
        save: 'Enregistrer',
        quickAdd: 'Ajout rapide',
        refresh: 'Rafraรฎchir',
        creditBook: 'Carnet de crรฉdit',
        peopleOweYou: 'Les gens vous doivent ou vous leur devez',
        stock: 'Stock',
        addPartner: 'Ajouter partenaire',
        partnerHint: 'Pourcentage du bรฉnรฉfice',
        add: 'Ajouter',
        deleteWarning: 'Toutes les donnรฉes seront supprimรฉes',
        confirmTitle: 'Confirmation',
        confirmAction: 'Confirmer',
        settleDebtConfirmMessage: 'Marquer cette dette comme rรฉglรฉe ?',
        debtDetailsTitle: 'Dรฉtails de la dette',
        debtTypeLabel: 'Type',
        transactionDetailsTitle: 'Dรฉtails de la transaction',
        receipt: 'Reรงu',
        share: 'Partager',
        download: 'Tรฉlรฉcharger',
        deleteTransactionTitle: 'Supprimer la transaction',
        deleted: 'Supprimรฉ',
        search: 'Rechercherโฆ',
        searchDebts: 'Rechercher par nom ou articleโฆ',
        filterAll: 'Tout',
        filterSales: 'Ventes',
        filterPurchases: 'Achats',
        filterCredits: 'Crรฉdits',
        emptyToday: "Aucune opรฉration pour l'instant.",
        emptyHistory: 'Aucune transaction.',
        emptyDebts: "Aucun crรฉdit en cours.",
        copied: 'Reรงu copiรฉ !',
        saved: 'Transaction enregistrรฉe !',
        fillAll: 'Veuillez remplir tous les champs',
        needClient: 'Veuillez saisir le nom du client',

        // Pricing mode
        pricingMode: 'Mode de calcul',
        pricingHint: 'Entrez prix et quantitรฉ, lโapp calcule',
        unitPriceMode: 'Prix unitaire',
        totalPriceMode: 'Prix total',
        unitPrice: 'Prix (unitรฉ)',
        totalPrice: 'Prix total',
        unitModeHint: 'Prix unitaire + quantitรฉ โ total automatique.',
        totalModeHint: 'Total + quantitรฉ โ prix unitaire automatique.',
        quantityRequired: 'Veuillez saisir la quantitรฉ',
        unitPriceRequired: 'Veuillez saisir le prix unitaire',
        totalPriceRequired: 'Veuillez saisir le prix total',

        // AI
        ai: 'IA',
        aiAssistant: 'Assistant IA',
        aiToggleHint: 'Activer/Dรฉsactiver (uniquement vos donnรฉes)',
        aiDisclaimer: 'Rรฉponses courtes basรฉes sur vos donnรฉes.',
        aiEmpty: 'Demandez: bรฉnรฉfice, ventes, achats, dettesโฆ',
        aiDisabled: 'Activez lโassistant dans les rรฉglages',
        aiDisabledShort: 'IA dรฉsactivรฉe',
        aiEnabled: 'IA activรฉe',
        aiHelp: 'Essayez: bรฉnรฉfice ? ventes ? achats ? dettes ?',
        aiExamples: 'Exemples',
        aiExamplesHint: 'Touchez un exemple pour le coller',
        aiReviewAndApply: 'โ Un plan est prรชt. Vรฉrifiez puis cliquez "Appliquer".',
        aiProposedChanges: 'Changements proposรฉs',
        aiApply: 'Appliquer',
        aiPlanCanceled: 'Plan annulรฉ',
        aiNoPlan: 'Aucun plan',
        aiNothingApplied: 'Rien appliquรฉ',
        aiAppliedTitle: 'Changements appliquรฉs',
        aiSomeSkipped: 'Certaines actions ont รฉtรฉ ignorรฉes',
        aiOnline: 'En ligne',
        aiOffline: 'Hors ligne',
        aiLocal: 'Mode local',
        aiServerOffline: 'Serveur hors ligne',
        aiKeyMissing: 'Clรฉ IA manquante',
        aiEndpointMissing: 'Endpoint IA introuvable',
        aiHistory: 'Historique',
        aiHistoryHint: 'Changer de chat ou en crรฉer un nouveau',
        aiNewChat: 'Nouveau chat',
        aiDefaultChatTitle: 'Chat',
        aiExample1Label: 'Profit du jour',
        aiExample1Prompt: 'Quel est mon profit aujourdโhui ?',
        aiExample2Label: 'Meilleures ventes',
        aiExample2Prompt: 'Quels sont les articles les plus vendus ce mois-ci ?',
        aiExample3Label: 'Appliquer une histoire',
        aiExample3Prompt: 'Je veux: jโai achetรฉ un mouton pour 2000, il a eu un bรฉbรฉ, jโai vendu le mouton adulte pour 2500 et gardรฉ le bรฉbรฉ. Applique รงa dans lโapp.',
        aiIntroTitle: 'Je suis lโassistant TIJARATI',
        aiIntroBody: 'Mon travail: vous aider ร comprendre vos chiffres et organiser vos opรฉrations.',
        aiIntroCan1: 'Calculer profit/ventes/dรฉpenses/dettes',
        aiIntroCan2: 'Proposer un plan pour ajouter des opรฉrations (puis vous confirmez avec "Appliquer")',
        aiIntroCan3: 'Suggรฉrer des actions pour amรฉliorer votre suivi',
        aiHintSales: 'Ventes',
        aiHintPurchases: 'Dรฉpenses',
        aiHintAsk: 'Vous pouvez demander:',
        aiHintApply: 'Pour appliquer des changements, dites: "apply" / "appliquer".',

        // Installments
        installments: 'Paiement en versements',
        installmentsHint: 'Si le remboursement se fait en plusieurs versements',
        payment: 'Versement',
        noPayments: 'Aucun versement pour le moment.',
        paymentAmount: 'Montant',
        paymentDate: 'Date',
        addPayment: 'Ajouter un versement',
        paymentAmountRequired: 'Veuillez saisir le montant',

        // Common
        clear: 'Effacer',
        send: 'Envoyer',
        editSale: 'Modifier vente',
        editPurchase: 'Modifier achat',

        // Partners
        invested: 'Investi',
        investedAt: "Date dโinvestissement",
        roi: 'ROI',
        whySplit: 'Pourquoi',
        profitTimesPercent: 'bรฉnรฉfice ร pourcentage',

        // Cloud
        cloud: 'Cloud',
        cloudHint: 'Sauvegarde Google',
        cloudNotSupported: 'Le cloud nรฉcessite http/https (serveur web).',
        cloudModeServer: 'Sauvegarde serveur',
        cloudModeServerHint: "Sur mobile : le cloud passe par le serveur. Renseigne lโURL puis Backup/Restore.",
        serverUrl: 'URL du serveur',
        serverTest: 'Tester',
        serverStatusNotSet: 'URL du serveur manquante.',
        serverStatusOk: 'Connectรฉ au serveur',
        serverStatusFail: 'Serveur injoignable',
        testing: 'Testโฆ',
        cloudSignIn: 'Connexion Google',
        cloudSignOut: 'Dรฉconnexion',
        cloudBackup: 'Sauvegarder maintenant',
        cloudRestore: 'Restaurer depuis le cloud',
        cloudNeedLogin: 'Connectez-vous dโabord',
        cloudBackupDone: 'Sauvegarde envoyรฉe',
        cloudRestoreDone: 'Restauration terminรฉe',
        cloudNoBackup: 'Aucune sauvegarde trouvรฉe',
        cloudRestoreConfirm: 'Cela remplacera vos donnรฉes actuelles. Continuer ?',
        cloudRefreshStatus: 'Rafraรฎchir le statut',
        cloudStatusSignedOut: 'Connectez-vous pour voir le statut',
        cloudStatusSignedIn: 'Connectรฉ',
        cloudStatusLoading: 'Vรฉrification du statutโฆ',
        cloudStatusError: 'Impossible de charger le statut',
        cloudStatusNever: 'Aucune sauvegarde cloud pour lโinstant',
        cloudStatusLast: 'Derniรจre sauvegarde cloud',
        cloudStatusCloudItems: 'Dรฉjร sauvegardรฉ',
        cloudStatusLocalItems: 'Local',
        cloudStatusPendingItems: 'Non sauvegardรฉ',

        // Auth
        authTitle: 'Connexion',
        email: 'E-mail',
        password: 'Mot de passe',
        signIn: 'Se connecter',
        signUp: 'Crรฉer un compte',
        resetPassword: 'Mot de passe oubliรฉ ?',
        continueWithGoogle: 'Continuer avec Google',
        signedIn: 'Connectรฉ',
        accountCreated: 'Compte crรฉรฉ',
        passwordMin: 'Le mot de passe doit contenir au moins 6 caractรจres',
        emailRequired: 'E-mail requis',
        resetSent: 'E-mail de rรฉinitialisation envoyรฉ',
        confirmPassword: 'Confirmer le mot de passe',
        passwordsDontMatch: 'Les mots de passe ne correspondent pas'
      },
      english: {
        appName: 'TIJARATI',
        loading: 'Preparingโฆ',
        clearingData: 'Clearing dataโฆ',
        clearedDone: 'Done!',
        clearFailed: 'Clear failed',
        home: 'Home',
        history: 'History',
        credit: 'Debts',
        partners: 'Partners',
        settings: 'Settings',
        appearance: 'Appearance',
        appearanceHint: 'Light / Dark',
        language: 'Language',
        languageHint: 'Change UI language',
        currency: 'Currency',
        currencyHint: 'Auto conversion',
        data: 'Data',
        dataHint: 'Export/Import/Clear',
        exportData: 'Export',
        importData: 'Import',
        clearData: 'Clear data',
        enableMockData: 'Enable mock data',
        disableMockData: 'Disable mock data',
        mockEnableConfirm: 'This will add sample data for testing. You can remove it using the same button.',
        mockDisableConfirm: 'This will remove only the sample data that was added.',
        mockAdded: 'Mock data added',
        mockRemoved: 'Mock data removed',
        mockNotAvailable: 'Mock data is available in the mobile app only',
        yesDelete: 'Yes, delete',
        delete: 'Delete',
        cancel: 'Cancel',
        income: 'Income',
        expenses: 'Expenses',
        netProfit: 'Net profit',
        cashFlow: 'Cash flow',
        today: 'Today',
        allTime: 'All time',
        quickActions: 'Quick actions',
        tips: 'Tip: use (+) to add quickly',
        newSale: 'New sale',
        newPurchase: 'New purchase',
        saleHint: 'Cash in',
        purchaseHint: 'Cash out',
        pendingDebts: 'Pending debts',
        recentActivity: 'Recent activity',
        seeAll: 'See all',
        transactions: 'Transactions',
        transaction: 'Transaction',
        total: 'Total',
        itemName: 'Item name',
        price: 'Unit price',
        quantity: 'Quantity',
        paymentStatus: 'Payment',
        paymentHint: 'Paid or credit',
        paidLabel: 'Paid',
        creditLabel: 'Credit',
        paidShort: 'Paid',
        creditShort: 'Credit',
        clientName: 'Client name',
        amountPaid: 'Amount paid',
        remaining: 'Remaining',
        settled: 'Settled',
        debtDueDate: 'Reminder date',
        debtDueHint: 'Leave empty if you do not want a reminder',
        reminderSet: 'Set reminder',
        reminderClear: 'Clear reminder',
        noReminder: 'No reminder',
        date: 'Date',
        save: 'Save',
        quickAdd: 'Quick add',
        refresh: 'Refresh',
        creditBook: 'Debt book',
        peopleOweYou: 'People Owe You OR you owe them',
        stock: 'Stock',
        addPartner: 'Add partner',
        partnerHint: 'Profit percentage',
        add: 'Add',
        deleteWarning: 'All data will be deleted',
        confirmTitle: 'Confirm',
        confirmAction: 'Confirm',
        settleDebtConfirmMessage: 'Mark this debt as settled?',
        debtDetailsTitle: 'Debt details',
        debtTypeLabel: 'Type',
        transactionDetailsTitle: 'Transaction details',
        receipt: 'Receipt',
        share: 'Share',
        download: 'Download',
        deleteTransactionTitle: 'Delete transaction',
        deleted: 'Deleted',
        search: 'Searchโฆ',
        searchDebts: 'Search by name or itemโฆ',
        filterAll: 'All',
        filterSales: 'Sales',
        filterPurchases: 'Purchases',
        filterCredits: 'Debts',
        emptyToday: 'No transactions yet.',
        emptyHistory: 'No transactions.',
        emptyDebts: 'No pending debts.',
        copied: 'Receipt copied!',
        saved: 'Saved successfully!',
        fillAll: 'Please fill in all required fields',
        needClient: 'Please enter client name',

        // Pricing mode
        pricingMode: 'Pricing mode',
        pricingHint: 'Enter price + quantity, the app calculates',
        unitPriceMode: 'Unit price',
        totalPriceMode: 'Total price',
        unitPrice: 'Unit price',
        totalPrice: 'Total price',
        unitModeHint: 'Unit price + quantity โ total auto.',
        totalModeHint: 'Total + quantity โ unit price auto.',
        quantityRequired: 'Please enter quantity',
        unitPriceRequired: 'Please enter unit price',
        totalPriceRequired: 'Please enter total price',

        // AI
        ai: 'AI',
        aiAssistant: 'AI assistant',
        aiToggleHint: 'Enable/Disable (uses only your app data)',
        aiDisclaimer: 'Short answers based on your data.',
        aiEmpty: 'Ask about profit, sales, purchases, or debtsโฆ',
        aiDisabled: 'Enable the assistant in Settings',
        aiDisabledShort: 'AI disabled',
        aiEnabled: 'AI enabled',
        aiHelp: 'Try: profit? sales? purchases? debts?',
        aiExamples: 'Examples',
        aiExamplesHint: 'Tap an example to paste',
        aiReviewAndApply: 'โ I prepared a change plan. Review it, then tap โApplyโ.',
        aiProposedChanges: 'Proposed changes',
        aiApply: 'Apply',
        aiPlanCanceled: 'Plan canceled',
        aiNoPlan: 'No plan',
        aiNothingApplied: 'Nothing applied',
        aiAppliedTitle: 'Applied changes',
        aiSomeSkipped: 'Some actions were skipped',
        aiOnline: 'Online',
        aiOffline: 'Offline',
        aiLocal: 'Local mode',
        aiServerOffline: 'Server offline',
        aiKeyMissing: 'AI key missing',
        aiEndpointMissing: 'AI endpoint missing',
        aiHistory: 'Chat history',
        aiHistoryHint: 'Switch chats or start a new one',
        aiNewChat: 'New chat',
        aiDefaultChatTitle: 'Chat',
        aiExample1Label: 'Profit today',
        aiExample1Prompt: 'What is my profit today?',
        aiExample2Label: 'Top items',
        aiExample2Prompt: 'What are my top selling items this month?',
        aiExample3Label: 'Apply story',
        aiExample3Prompt: 'Please apply this in the app: I bought a sheep for 2000, it had a baby, I sold the adult sheep for 2500 and kept the baby.',
        aiIntroTitle: 'Iโm the TIJARATI assistant',
        aiIntroBody: 'My job is to help you understand your numbers and (when you ask) prepare safe change plans for your data.',
        aiIntroCan1: 'Answer questions about profit, sales, expenses, and debts',
        aiIntroCan2: 'Prepare a change plan to add transactions (you review + tap โApplyโ)',
        aiIntroCan3: 'Suggest next steps to keep your records clean',
        aiHintSales: 'Sales',
        aiHintPurchases: 'Expenses',
        aiHintAsk: 'You can ask:',
        aiHintApply: 'If you want me to change data, say โapplyโ and describe what happened.',

        // Installments
        installments: 'Installments',
        installmentsHint: 'If the debt is repaid in payments',
        payment: 'Payment',
        noPayments: 'No payments yet.',
        paymentAmount: 'Payment amount',
        paymentDate: 'Payment date',
        addPayment: 'Add payment',
        paymentAmountRequired: 'Please enter payment amount',

        // Common
        clear: 'Clear',
        send: 'Send',
        editSale: 'Edit sale',
        editPurchase: 'Edit purchase',

        // Partners
        invested: 'Invested',
        investedAt: 'Invested at',
        roi: 'ROI',
        whySplit: 'Why',
        profitTimesPercent: 'profit ร percent',
        partnerDetails: 'Dรฉtails du partenaire',
        partnerDue: 'Dรป',
        profitSchedule: 'Calendrier des profits',
        profitScheduleHint: 'Ex. mensuel ou hebdomadaire',
        payouts: 'Paiements',
        payoutsHint: 'Historique des paiements',
        close: 'Fermer',
        partnerDetails: 'Partner details',
        partnerDue: 'Due',
        profitSchedule: 'Profit schedule',
        profitScheduleHint: 'e.g. monthly or weekly',
        payouts: 'Payouts',
        payoutsHint: 'Track profit payouts',
        close: 'Close',

        // Cloud
        cloud: 'Cloud',
        cloudHint: 'Google backup & restore',
        cloudNotSupported: 'Cloud requires running on http/https (web server).',
        cloudModeServer: 'Server backup',
        cloudModeServerHint: 'On mobile: cloud runs via your server. Set Server URL, then Backup/Restore.',
        serverUrl: 'Server URL',
        serverTest: 'Test',
        serverStatusNotSet: 'Server URL not set.',
        serverStatusOk: 'Connected',
        serverStatusFail: 'Cannot reach server',
        testing: 'Testingโฆ',
        cloudSignIn: 'Sign in with Google',
        cloudSignOut: 'Sign out',
        cloudBackup: 'Backup to cloud',
        cloudRestore: 'Restore from cloud',
        cloudNeedLogin: 'Please sign in first',
        cloudBackupDone: 'Backup uploaded',
        cloudRestoreDone: 'Restore completed',
        cloudNoBackup: 'No backup found',
        cloudRestoreConfirm: 'This will overwrite your current data. Continue?',
        cloudRefreshStatus: 'Refresh status',
        cloudStatusSignedOut: 'Sign in to see cloud status',
        cloudStatusSignedIn: 'Signed in',
        cloudStatusLoading: 'Checking cloud backup statusโฆ',
        cloudStatusError: 'Could not load cloud status',
        cloudStatusNever: 'No cloud backup yet',
        cloudStatusLast: 'Last cloud backup',
        cloudStatusCloudItems: 'Already backed up',
        cloudStatusLocalItems: 'Local data',
        cloudStatusPendingItems: 'Not backed up yet',

        // Auth
        authTitle: 'Sign in',
        email: 'Email',
        password: 'Password',
        signIn: 'Sign in',
        signUp: 'Sign up',
        resetPassword: 'Forgot password?',
        continueWithGoogle: 'Continue with Google',
        signedIn: 'Signed in',
        accountCreated: 'Account created',
        passwordMin: 'Password must be at least 6 characters',
        emailRequired: 'Email is required',
        resetSent: 'Password reset email sent',
        confirmPassword: 'Confirm password',
        passwordsDontMatch: 'Passwords do not match',

        // Security
        security: 'Security',
        securityHint: 'PIN + fingerprint',
        setPin: 'Set PIN',
        disablePin: 'Disable PIN',
        enableBiometric: 'Enable fingerprint',
        disableBiometric: 'Disable fingerprint',
        enterPin: 'Enter PIN (min 4 digits)',
        pinEnabled: 'PIN is enabled',
        pinDisabled: 'PIN is disabled',
        biometricNotAvailable: 'Fingerprint not available on this device'
      }
    };

    // ==========================
    // Helpers
    // ==========================
    function t(key) {
      return (translations[state.language] && translations[state.language][key]) || translations.darija[key] || key;
    }

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function baseFromCurrentCurrency(amountInSelectedCurrency) {
      const rate = exchangeRates[state.currency] || 1;
      return amountInSelectedCurrency / rate;
    }

    function currentFromBase(baseAmount) {
      const rate = exchangeRates[state.currency] || 1;
      return (baseAmount || 0) * rate;
    }

    function formatMoney(baseAmount) {
      const rate = exchangeRates[state.currency] || 1;
      const value = baseAmount * rate;
      const locale = state.language === 'english' ? 'en' : (state.language === 'french' ? 'fr' : 'ar-MA');
      try {
        return new Intl.NumberFormat(locale, { maximumFractionDigits: 2 }).format(value);
      } catch {
        return (value || 0).toFixed(2);
      }
    }

    function setThemeColorMeta() {
      const meta = document.querySelector('meta[name="theme-color"]');
      const dark = document.documentElement.classList.contains('dark');
      meta && meta.setAttribute('content', dark ? '#070b16' : '#f7f7fb');
    }

    // ==========================
    // Persistence
    // ==========================
    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const saved = JSON.parse(raw);
          state = { ...state, ...saved };
        } catch { /* ignore */ }
      }
      if (!Array.isArray(state.transactions)) state.transactions = [];
      if (!Array.isArray(state.partners)) state.partners = [];
      if (!state.pricingMode) state.pricingMode = 'unit';
      if (!Array.isArray(state.aiChat)) state.aiChat = [];
      if (!Array.isArray(state.aiConversations)) state.aiConversations = [];
      if (!state.aiActiveConversationId) {
        const id = Date.now();
        state.aiConversations = [{ id, createdAt: Date.now(), title: t('aiDefaultChatTitle') || 'Chat', messages: [...state.aiChat] }];
        state.aiActiveConversationId = id;
      }

      // Remove legacy toggle if present
      if ('aiEnabled' in state) {
        try { delete state.aiEnabled; } catch { }
      }
      if (!state.theme) state.theme = 'system';
      if (typeof state.mockDataEnabled !== 'boolean') state.mockDataEnabled = false;
      if (typeof state.localRevision !== 'number') state.localRevision = 0;
      if (typeof state.lastLocalChangeAt !== 'number') state.lastLocalChangeAt = 0;
      if (typeof state.lastBackup !== 'object') state.lastBackup = null;
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        language: state.language,
        currency: state.currency,
        theme: state.theme,
        mockDataEnabled: state.mockDataEnabled,
        pricingMode: state.pricingMode,
        aiChat: state.aiChat,
        aiConversations: state.aiConversations,
        aiActiveConversationId: state.aiActiveConversationId,
        stockSearch: state.stockSearch,
        transactions: state.transactions,
        partners: state.partners,
        localRevision: state.localRevision,
        lastLocalChangeAt: state.lastLocalChangeAt,
        lastBackup: state.lastBackup,
        lastScreen: state.lastScreen
      }));
    }

    function touchLocalChange() {
      state.localRevision = (typeof state.localRevision === 'number' ? state.localRevision : 0) + 1;
      state.lastLocalChangeAt = Date.now();
    }

    function updateMockDataButton() {
      const btn = document.getElementById('settings-mock-data');
      const label = document.getElementById('settings-mock-label');
      if (!btn || !label) return;

      const enabled = !!state.mockDataEnabled;
      label.textContent = enabled ? t('disableMockData') : t('enableMockData');

      // Visual hint: warn when enabled (so user knows itโs test mode)
      btn.style.background = enabled
        ? 'color-mix(in srgb, var(--danger) 10%, var(--surface))'
        : 'color-mix(in srgb, var(--warn) 10%, var(--surface))';
      btn.style.border = enabled
        ? '1px solid color-mix(in srgb, var(--danger) 18%, var(--border))'
        : '1px solid color-mix(in srgb, var(--warn) 18%, var(--border))';
      btn.style.color = enabled
        ? 'color-mix(in srgb, var(--danger) 92%, var(--fg))'
        : 'color-mix(in srgb, var(--warn) 92%, var(--fg))';

      btn.onclick = toggleMockData;
      lucide.createIcons();
    }

    // ==========================
    // Theme
    // ==========================
    function systemPrefersDark() {
      if (window.isNativeApp && window.systemTheme) return window.systemTheme === 'dark';
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    }

    function applyTheme() {
      const mode = state.theme;
      const shouldDark = mode === 'dark' || (mode === 'system' && systemPrefersDark());
      document.documentElement.classList.toggle('dark', shouldDark);
      setThemeColorMeta();
      updateThemeButtons();
    }

    function cycleTheme() {
      // user-friendly: system -> dark -> light -> system
      const order = ['system', 'dark', 'light'];
      const idx = order.indexOf(state.theme);
      state.theme = order[(idx + 1) % order.length];
      saveState();
      applyTheme();
      showToast(state.theme === 'dark' ? 'Dark mode' : state.theme === 'light' ? 'Light mode' : 'System', 'info');
    }

    function themeLabel() {
      if (state.theme === 'dark') return 'Dark';
      if (state.theme === 'light') return 'Light';
      return 'System';
    }

    function updateThemeButtons() {
      const dark = document.documentElement.classList.contains('dark');
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.innerHTML = dark
          ? '<i data-lucide="sun" class="w-5 h-5"></i>'
          : '<i data-lucide="moon" class="w-5 h-5"></i>';
      }
      const btn = document.getElementById('settings-theme');
      const label = document.getElementById('settings-theme-label');
      if (btn && label) {
        label.textContent = themeLabel();
        btn.onclick = cycleTheme;
      }
      lucide.createIcons();
    }

    // ==========================
    // i18n & direction
    // ==========================
    function applyLanguage() {
      const isRTL = ['darija', 'arabic'].includes(state.language);
      document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
      document.documentElement.lang = state.language === 'english' ? 'en' : (state.language === 'french' ? 'fr' : 'ar');

      // Switch font for latin-heavy languages
      document.body.style.fontFamily = isRTL ? 'var(--font-ar)' : 'var(--font-latin)';

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (!key) return;
        el.textContent = t(key);
      });

      // Update placeholders
      const hs = document.getElementById('history-search');
      if (hs) hs.placeholder = t('search');
      const ds = document.getElementById('debts-search');
      if (ds) ds.placeholder = t('searchDebts');

      document.querySelectorAll('.lang-btn').forEach(btn => {
        const active = btn.dataset.lang === state.language;
        btn.style.borderColor = active ? 'color-mix(in srgb, var(--primary) 45%, var(--border))' : 'var(--border)';
        btn.style.background = active ? 'color-mix(in srgb, var(--primary) 10%, var(--surface))' : 'var(--surface-2)';
        btn.style.color = active ? 'var(--fg)' : 'var(--fg)';
      });

      updateDateHeader();
      updateMockDataButton();
    }

    function setLanguage(lang) {
      state.language = lang;
      saveState();
      applyLanguage();
      renderAll();
    }

    // ==========================
    // Currency
    // ==========================
    function applyCurrency() {
      document.querySelectorAll('.currency-symbol').forEach(el => {
        el.textContent = currencySymbols[state.currency] || state.currency;
      });

      document.querySelectorAll('.curr-btn').forEach(btn => {
        const active = btn.dataset.curr === state.currency;
        btn.style.background = active ? 'linear-gradient(135deg, var(--primary), var(--primary-2))' : 'var(--surface-2)';
        btn.style.border = active ? '1px solid color-mix(in srgb, var(--primary-2) 28%, transparent)' : '1px solid var(--border)';
        btn.style.color = active ? '#fff' : 'var(--fg)';
      });
    }

    function setCurrency(curr) {
      state.currency = curr;
      saveState();
      applyCurrency();
      renderAll();
    }

    // ==========================
    // Navigation
    // ==========================
    const navStack = [];

    function showScreen(id, opts = { push: true }) {
      const current = document.querySelector('.screen.active');
      if (opts.push && current && current.id !== id && current.id !== 'settings-screen') {
        navStack.push(current.id);
      }

      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screen = document.getElementById(id);
      if (screen) screen.classList.add('active');

      // Update nav active
      document.querySelectorAll('.nav-item').forEach(n => {
        const active = n.dataset.target === id;
        n.style.color = active ? 'var(--primary-2)' : 'var(--muted)';
      });

      // AI screen should be distraction-free (no bottom navbar)
      const bottomNav = document.getElementById('bottom-nav');
      if (bottomNav) bottomNav.classList.toggle('hidden', id === 'ai-screen');

      state.lastScreen = id;
      saveState();

      // Trigger renderers
      if (id === 'home-screen') updateDashboard();
      if (id === 'history-screen') renderHistory();
      if (id === 'debts-screen') renderDebts();
      if (id === 'partners-screen') renderPartnersAndStock();
      if (id === 'ai-screen') renderAiScreen();

      lucide.createIcons();
    }

    function goBack() {
      const prev = navStack.pop();
      showScreen(prev || 'home-screen', { push: false });
    }

    function openSettings() {
      showScreen('settings-screen', { push: true });
      try { securityRefreshUi(); } catch { }
      try { Cloud.updateUi(); } catch { }
      try { cloudRefreshStatus(); } catch { }
    }

    function closeSettings() {
      goBack();
    }

    // ==========================
    // Auth (Full-page)
    // ==========================
    let authScreenMode = 'signin';

    function openAuthScreen() {
      const current = document.querySelector('.screen.active');
      if (current && current.id && current.id !== 'auth-screen') {
        // Push even if current is settings-screen.
        navStack.push(current.id);
      }
      showScreen('auth-screen', { push: false });
      setAuthScreenMode('signin');
      updateAuthScreenUi();
      setTimeout(() => {
        const email = document.getElementById('auth-screen-email');
        if (email) email.focus();
      }, 80);
    }

    function setAuthScreenMode(mode) {
      authScreenMode = (mode === 'signup') ? 'signup' : 'signin';
      updateAuthScreenUi();
    }

    function updateAuthScreenUi() {
      const signInTab = document.getElementById('auth-tab-signin');
      const signUpTab = document.getElementById('auth-tab-signup');
      const confirmWrap = document.getElementById('auth-screen-confirm-wrap');
      const primaryText = document.getElementById('auth-screen-primary-text');
      const status = document.getElementById('auth-screen-status');
      const signOutBtn = document.getElementById('auth-screen-signout');

      const isSignUp = authScreenMode === 'signup';

      if (signInTab) {
        signInTab.style.background = !isSignUp ? 'linear-gradient(135deg, var(--primary), var(--primary-2))' : 'transparent';
        signInTab.style.color = !isSignUp ? '#fff' : 'var(--muted)';
      }
      if (signUpTab) {
        signUpTab.style.background = isSignUp ? 'linear-gradient(135deg, var(--primary), var(--primary-2))' : 'transparent';
        signUpTab.style.color = isSignUp ? '#fff' : 'var(--muted)';
      }
      if (confirmWrap) confirmWrap.classList.toggle('hidden', !isSignUp);
      if (primaryText) primaryText.textContent = isSignUp ? (t('signUp') || 'Sign up') : (t('signIn') || 'Sign in');

      if (status) {
        if (Cloud.user) status.textContent = `${t('cloudStatusSignedIn') || 'Signed in'}${Cloud.user.email ? ' โข ' + Cloud.user.email : ''}`;
        else status.textContent = t('cloudStatusSignedOut') || '';
      }

      if (signOutBtn) signOutBtn.classList.toggle('hidden', !Cloud.user);
      try { lucide.createIcons(); } catch { }
    }

    async function authScreenPrimary() {
      try {
        if (!window.firebase || !firebase.auth) throw new Error('Firebase not available');
        const email = (document.getElementById('auth-screen-email')?.value || '').trim();
        const pass = (document.getElementById('auth-screen-password')?.value || '').trim();
        const confirm = (document.getElementById('auth-screen-confirm')?.value || '').trim();
        if (!email || !pass) {
          showToast(t('fillAll'), 'error');
          return;
        }

        if (authScreenMode === 'signup') {
          if (pass.length < 6) {
            showToast(t('passwordMin') || 'Password must be at least 6 characters', 'error');
            return;
          }
          if (confirm && confirm !== pass) {
            showToast(t('passwordsDontMatch') || 'Passwords do not match', 'error');
            return;
          }
          await firebase.auth().createUserWithEmailAndPassword(email, pass);
          showToast(t('accountCreated') || 'Account created', 'success');
        } else {
          await firebase.auth().signInWithEmailAndPassword(email, pass);
          showToast(t('signedIn') || 'Signed in', 'success');
        }

        updateAuthScreenUi();
        goBack();
      } catch (e) {
        showToast(String(e?.message || e || 'Auth failed'), 'error');
      }
    }

    async function authScreenReset() {
      try {
        if (!window.firebase || !firebase.auth) throw new Error('Firebase not available');
        const email = (document.getElementById('auth-screen-email')?.value || '').trim();
        if (!email) {
          showToast(t('emailRequired') || 'Email is required', 'error');
          return;
        }
        await firebase.auth().sendPasswordResetEmail(email);
        showToast(t('resetSent') || 'Password reset email sent', 'success');
      } catch (e) {
        showToast(String(e?.message || e || 'Reset failed'), 'error');
      }
    }

    // ==========================
    // Dashboard (all-time)
    // ==========================
    function updateDashboard() {
      const incomeBase = state.transactions
        .filter(t => t.type === 'sale')
        .reduce((sum, t) => sum + (t.paidAmountBase ?? t.amountBase ?? 0), 0);

      const expenseBase = state.transactions
        .filter(t => t.type === 'purchase')
        .reduce((sum, t) => sum + (t.paidAmountBase ?? t.amountBase ?? 0), 0);

      const balanceBase = incomeBase - expenseBase;

      const balanceEl = document.getElementById('dashboard-balance');
      const incEl = document.getElementById('dashboard-income');
      const expEl = document.getElementById('dashboard-expense');

      if (balanceEl) {
        balanceEl.textContent = formatMoney(balanceBase);
        balanceEl.style.color = balanceBase >= 0 ? 'var(--fg)' : 'color-mix(in srgb, var(--danger) 80%, var(--fg))';
      }
      if (incEl) incEl.textContent = formatMoney(incomeBase);
      if (expEl) expEl.textContent = formatMoney(expenseBase);

      // Recent list
      const recentContainer = document.getElementById('recent-transactions-list');
      const recent = [...state.transactions].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 5);

      if (recentContainer) {
        if (recent.length === 0) {
          recentContainer.innerHTML = emptyState('inbox', t('emptyToday'));
        } else {
          recentContainer.innerHTML = recent.map(tx => createTransactionRow(tx, { compact: true })).join('');
        }
      }

      // Debt alert
      const totalDebt = calculateTotalPendingDebt();
      const alert = document.getElementById('debt-alert');
      if (alert) {
        if (totalDebt > 0.0001) {
          alert.classList.remove('hidden');
          document.getElementById('total-pending-debt').textContent = formatMoney(totalDebt);
        } else {
          alert.classList.add('hidden');
        }
      }

      applyCurrency();
      lucide.createIcons();

      updateAiUi();
    }

    // ==========================
    // AI Assistant
    // ==========================
    function aiGetRemoteBaseUrl() {
      try {
        const raw = (window && window.__TIJARATI_AI_SERVER_URL__) ? String(window.__TIJARATI_AI_SERVER_URL__) : '';
        const trimmed = raw.trim();
        if (!trimmed) return '';
        return trimmed.replace(/\/+$/, '');
      } catch {
        return '';
      }
    }

    function updateAiUi() {
      renderAiPlan();
      renderAiChat();
      renderAiShortcuts();
    }

    function renderAiScreen() {
      updateAiUi();
      try {
        askAiStatusForUi();
      } catch { }
    }

    async function askAiStatusForUi() {
      const statusEl = document.getElementById('ai-chat-status');
      if (!statusEl) return;
      statusEl.textContent = '';
      try {
        const proto = (window.location && window.location.protocol) ? window.location.protocol : '';
        if (proto === 'file:') {
          const base = aiGetRemoteBaseUrl();
          if (!base) {
            statusEl.textContent = (t('aiLocal') || 'Local mode');
            return;
          }

          const statusResp = await fetch(`${base}/api/ai/status`, { method: 'GET' });
          if (!statusResp.ok) {
            statusEl.textContent = (t('aiServerOffline') || t('aiOffline') || 'Offline');
            return;
          }

          const status = await statusResp.json();
          if (status?.enabled) {
            statusEl.textContent = (t('aiOnline') || 'Online');
            return;
          }
          if (status?.reason === 'missing_api_key') {
            statusEl.textContent = (t('aiKeyMissing') || 'AI key missing');
            return;
          }
          statusEl.textContent = (t('aiOffline') || 'Offline');
          return;
        }
        const statusResp = await fetch('/api/ai/status', { method: 'GET' });
        if (!statusResp.ok) {
          if (statusResp.status === 404) {
            statusEl.textContent = (t('aiEndpointMissing') || 'AI endpoint missing');
            return;
          }
          throw new Error('no-status');
        }

        const status = await statusResp.json();
        if (status?.enabled) {
          statusEl.textContent = (t('aiOnline') || 'Online');
          return;
        }

        if (status?.reason === 'missing_api_key') {
          statusEl.textContent = (t('aiKeyMissing') || 'AI key missing');
          return;
        }

        statusEl.textContent = (t('aiOffline') || 'Offline');
      } catch {
        statusEl.textContent = (t('aiServerOffline') || t('aiOffline') || 'Offline');
      }
    }

    function renderAiChat() {
      const box = document.getElementById('ai-chat-messages');
      if (!box) return;

      const items = aiGetActiveMessages();
      if (items.length === 0) {
        box.innerHTML = `<div class="text-xs font-bold" style="color: var(--muted);">${escapeHtml(t('aiEmpty'))}</div>`;
        renderAiShortcuts();
        return;
      }

      box.innerHTML = items.map(m => {
        const isUser = m.role === 'user';
        const bg = isUser ? 'color-mix(in srgb, var(--primary) 14%, var(--surface))' : 'var(--surface)';
        const border = isUser ? 'color-mix(in srgb, var(--primary) 24%, var(--border))' : 'var(--border)';
        const align = isUser ? 'ml-auto' : 'mr-auto';
        return `
          <div class="max-w-[90%] ${align} rounded-2xl p-3" style="background: ${bg}; border: 1px solid ${border};">
            <div class="text-sm font-bold" style="white-space: pre-wrap;">${escapeHtml(m.text || '')}</div>
          </div>
        `;
      }).join('');

      box.scrollTop = box.scrollHeight;
      renderAiShortcuts();
    }

    function clearAiChat() {
      aiClearCurrentChat();
    }

    async function sendAiChat() {
      const input = document.getElementById('ai-chat-input');
      const msg = (input?.value || '').trim();
      if (!msg) return;

      aiEnsureConversation();
      const items = aiGetActiveMessages();
      items.push({ role: 'user', text: msg, at: Date.now() });
      aiMaybeSetConversationTitleFrom(msg);
      input.value = '';
      saveState();
      renderAiChat();

      const replyRaw = await askAiBackend(aiBuildBackendMessage(msg));
      const extracted = aiExtractActionPlan(replyRaw);
      if (extracted?.plan) {
        state.aiPendingPlan = {
          plan: extracted.plan,
          raw: replyRaw,
          at: Date.now()
        };
        touchLocalChange();
        saveState();
        renderAiPlan();
      }

      const assistantText = extracted?.plan
        ? `${(extracted.cleanedText || extracted.plan.summary || '').trim()}\n\n${t('aiReviewAndApply')}`.trim()
        : replyRaw;

      items.push({ role: 'assistant', text: assistantText || t('aiHelp'), at: Date.now() });
      saveState();
      renderAiChat();
    }

    function renderAiShortcuts() {
      const wrap = document.getElementById('ai-shortcuts');
      if (!wrap) return;
      const items = aiGetActiveMessages();
      const show = Array.isArray(items) && items.length === 0;
      wrap.classList.toggle('hidden', !show);
      if (!show) return;

      const b1 = document.getElementById('ai-ex-1');
      const b2 = document.getElementById('ai-ex-2');
      const b3 = document.getElementById('ai-ex-3');

      if (b1) {
        b1.textContent = t('aiExample1Label');
        b1.onclick = () => aiUseExample(t('aiExample1Prompt'));
      }
      if (b2) {
        b2.textContent = t('aiExample2Label');
        b2.onclick = () => aiUseExample(t('aiExample2Prompt'));
      }
      if (b3) {
        b3.textContent = t('aiExample3Label');
        b3.onclick = () => aiUseExample(t('aiExample3Prompt'));
      }
    }

    function openAiHistory() {
      const el = document.getElementById('ai-history');
      if (!el) return;
      el.classList.remove('hidden');
      renderAiHistoryList();
      try { lucide.createIcons(); } catch { }
    }

    function closeAiHistory() {
      const el = document.getElementById('ai-history');
      if (!el) return;
      el.classList.add('hidden');
    }

    function aiEnsureConversation() {
      if (!Array.isArray(state.aiConversations)) state.aiConversations = [];
      if (!state.aiActiveConversationId) {
        const id = Date.now();
        state.aiConversations.unshift({ id, createdAt: Date.now(), title: t('aiDefaultChatTitle') || 'Chat', messages: [] });
        state.aiActiveConversationId = id;
      }
      const active = state.aiConversations.find(c => c && c.id === state.aiActiveConversationId);
      if (!active) {
        const id = Date.now();
        state.aiConversations.unshift({ id, createdAt: Date.now(), title: t('aiDefaultChatTitle') || 'Chat', messages: [] });
        state.aiActiveConversationId = id;
      }
    }

    function aiGetActiveConversation() {
      aiEnsureConversation();
      return state.aiConversations.find(c => c && c.id === state.aiActiveConversationId);
    }

    function aiGetActiveMessages() {
      const conv = aiGetActiveConversation();
      if (!Array.isArray(conv.messages)) conv.messages = [];
      return conv.messages;
    }

    function aiMaybeSetConversationTitleFrom(text) {
      const conv = aiGetActiveConversation();
      const defaultTitle = t('aiDefaultChatTitle') || 'Chat';
      if (conv.title && conv.title !== defaultTitle) return;
      const clean = String(text || '').trim();
      if (!clean) return;
      conv.title = clean.length > 28 ? (clean.slice(0, 28) + 'โฆ') : clean;
      saveState();
    }

    function aiNewConversation() {
      if (!Array.isArray(state.aiConversations)) state.aiConversations = [];
      const id = Date.now();
      state.aiConversations.unshift({ id, createdAt: Date.now(), title: t('aiDefaultChatTitle') || 'Chat', messages: [] });
      state.aiActiveConversationId = id;
      state.aiPendingPlan = null;
      touchLocalChange();
      saveState();
      updateAiUi();
    }

    function aiClearCurrentChat() {
      const conv = aiGetActiveConversation();
      conv.messages = [];
      state.aiPendingPlan = null;
      touchLocalChange();
      saveState();
      updateAiUi();
    }

    function renderAiHistoryList() {
      const list = document.getElementById('ai-history-list');
      if (!list) return;
      aiEnsureConversation();
      const convs = Array.isArray(state.aiConversations) ? state.aiConversations : [];
      if (convs.length === 0) {
        list.innerHTML = emptyState('message-circle', t('aiEmpty') || '');
        return;
      }

      list.innerHTML = convs.map(c => {
        const active = c.id === state.aiActiveConversationId;
        const title = escapeHtml(c.title || (t('aiDefaultChatTitle') || 'Chat'));
        const count = Array.isArray(c.messages) ? c.messages.length : 0;
        return `
          <div class="card p-3" style="background: ${active ? 'color-mix(in srgb, #4f46e5 10%, var(--surface))' : 'var(--surface)'}; border: 1px solid ${active ? 'color-mix(in srgb, #4f46e5 18%, var(--border))' : 'var(--border)'};">
            <div class="flex items-center justify-between gap-2">
              <button onclick="aiSwitchConversation(${c.id})" class="flex-1 text-right">
                <div class="text-sm font-black">${title}</div>
                <div class="text-[11px] font-bold" style="color: var(--muted);">${count} msg</div>
              </button>
              <button onclick="aiDeleteConversation(${c.id})" class="w-10 h-10 rounded-2xl flex items-center justify-center"
                style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Delete">
                <i data-lucide="trash-2" class="w-4 h-4" style="color: var(--danger);"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
      try { lucide.createIcons(); } catch { }
    }

    function aiSwitchConversation(id) {
      state.aiActiveConversationId = id;
      state.aiPendingPlan = null;
      saveState();
      updateAiUi();
      closeAiHistory();
    }

    function aiDeleteConversation(id) {
      if (!Array.isArray(state.aiConversations)) state.aiConversations = [];
      state.aiConversations = state.aiConversations.filter(c => c && c.id !== id);
      if (state.aiActiveConversationId === id) {
        state.aiActiveConversationId = state.aiConversations[0]?.id || null;
        if (!state.aiActiveConversationId) {
          const newId = Date.now();
          state.aiConversations = [{ id: newId, createdAt: Date.now(), title: t('aiDefaultChatTitle') || 'Chat', messages: [] }];
          state.aiActiveConversationId = newId;
        }
      }
      state.aiPendingPlan = null;
      touchLocalChange();
      saveState();
      renderAiHistoryList();
      updateAiUi();
    }

    function aiUseExample(text) {
      const input = document.getElementById('ai-chat-input');
      if (!input) {
        showScreen('ai-screen');
        setTimeout(() => aiUseExample(text), 80);
        return;
      }
      input.value = text;
      // Don't auto-open keyboard.
    }

    function aiBuildBackendMessage(userText) {
      const today = new Date().toISOString().slice(0, 10);
      const schema = `If the user asks you to APPLY changes inside the app, respond with a JSON plan in a single fenced code block (\`\`\`json). The JSON MUST have: {"type":"tijarati_action_plan_v1","summary":"...","actions":[...]}.\nSupported actions:\n- {"action":"add_transaction","transaction":{"type":"sale"|"purchase","item":"...","quantity":number,"unitPrice":number? ,"totalPrice":number? ,"date":"YYYY-MM-DD"?}}\n- {"action":"stock_adjustment","item":"...","delta":number,"date":"YYYY-MM-DD"?}\nRules: use the app current currency (${state.currency}); keep numbers simple; do NOT apply automatically.\nIf the user greets (hi/hello), introduce yourself: who you are, your job in TIJARATI, and what you can do.\nFor normal questions, answer with helpful detail (not ultra-short) and include next-step suggestions when useful.`;
      const context = `Context: today=${today}; currency=${state.currency}; pricingMode=${state.pricingMode || 'unit'}.`;
      return `${userText}\n\n---\n${schema}\n${context}`;
    }

    function aiExtractActionPlan(text) {
      const raw = String(text || '');
      const m = raw.match(/```json\s*([\s\S]*?)\s*```/i);
      if (!m) return { plan: null, cleanedText: raw.trim() };
      const jsonStr = (m[1] || '').trim();
      let obj = null;
      try { obj = JSON.parse(jsonStr); } catch { obj = null; }
      if (!obj || obj.type !== 'tijarati_action_plan_v1' || !Array.isArray(obj.actions)) {
        return { plan: null, cleanedText: raw.trim() };
      }
      const cleanedText = raw.replace(m[0], '').trim();
      return { plan: obj, cleanedText };
    }

    function renderAiPlan() {
      const card = document.getElementById('ai-plan-card');
      if (!card) return;
      const pending = state.aiPendingPlan && state.aiPendingPlan.plan;
      card.classList.toggle('hidden', !pending);
      if (!pending) return;

      const summary = document.getElementById('ai-plan-summary');
      const pre = document.getElementById('ai-plan-json');
      if (summary) summary.textContent = pending.summary || '';
      if (pre) {
        try { pre.textContent = JSON.stringify(pending, null, 2); }
        catch { pre.textContent = String(pending); }
      }
      try { lucide.createIcons(); } catch { }
    }

    function aiCancelPlan() {
      state.aiPendingPlan = null;
      touchLocalChange();
      saveState();
      renderAiPlan();
      showToast(t('aiPlanCanceled') || 'Canceled', 'success');
    }

    async function aiApplyPlan() {
      const pending = state.aiPendingPlan && state.aiPendingPlan.plan;
      if (!pending) {
        showToast(t('aiNoPlan') || 'No plan', 'error');
        return;
      }

      const now = Date.now();
      const applied = [];
      const errors = [];

      for (let i = 0; i < pending.actions.length; i++) {
        const a = pending.actions[i] || {};
        try {
          const created = await aiApplySingleAction(a, now + i);
          if (created) applied.push(created);
        } catch (e) {
          errors.push((e && e.message) ? e.message : 'invalid-action');
        }
      }

      if (applied.length === 0) {
        showToast(t('aiNothingApplied') || 'Nothing applied', 'error');
        return;
      }

      state.aiPendingPlan = null;
      touchLocalChange();
      saveState();
      renderAiPlan();

      updateDashboard();
      try { renderHistory(); } catch { }
      try { renderPartnersAndStock(); } catch { }

      const audit = aiBuildAudit(applied, errors);
      aiEnsureConversation();
      aiGetActiveMessages().push({ role: 'assistant', text: audit, at: Date.now() });
      saveState();
      renderAiChat();

      showToast(t('saved'), 'success');
    }

    async function aiApplySingleAction(action, idSeed) {
      const today = new Date().toISOString().slice(0, 10);
      const kind = (action && action.action) ? String(action.action) : '';

      if (kind === 'add_transaction') {
        const spec = action.transaction || {};
        const tx = aiBuildTxFromSpec(spec, idSeed, today);
        state.transactions.push(tx);
        touchLocalChange();
        saveState();
        await persistTransaction(tx);
        return tx;
      }

      if (kind === 'stock_adjustment') {
        const item = String(action.item || '').trim();
        const delta = Number(action.delta);
        const date = String(action.date || today);
        if (!item) throw new Error('missing item');
        if (!isFinite(delta) || delta === 0) throw new Error('invalid delta');

        const txSpec = {
          type: delta > 0 ? 'purchase' : 'sale',
          item,
          quantity: Math.abs(delta),
          totalPrice: 0,
          unitPrice: 0,
          date
        };
        const tx = aiBuildTxFromSpec(txSpec, idSeed, today);
        state.transactions.push(tx);
        touchLocalChange();
        saveState();
        await persistTransaction(tx);
        return tx;
      }

      throw new Error('unsupported action');
    }

    function aiBuildTxFromSpec(spec, idSeed, fallbackDate) {
      const type = (spec && spec.type) ? String(spec.type) : '';
      const item = (spec && spec.item) ? String(spec.item).trim() : '';
      const qty = Number(spec && spec.quantity);
      const date = String((spec && spec.date) || fallbackDate);

      if (type !== 'sale' && type !== 'purchase') throw new Error('invalid type');
      if (!item) throw new Error('missing item');
      if (!isFinite(qty) || qty <= 0) throw new Error('invalid quantity');
      if (!date) throw new Error('missing date');

      const totalSelectedRaw = spec && spec.totalPrice;
      const unitSelectedRaw = spec && spec.unitPrice;
      const totalSelected = isFinite(Number(totalSelectedRaw)) ? Number(totalSelectedRaw) : null;
      const unitSelected = isFinite(Number(unitSelectedRaw)) ? Number(unitSelectedRaw) : null;

      let finalTotal = 0;
      let finalUnit = 0;
      if (totalSelected !== null) {
        finalTotal = totalSelected;
        finalUnit = qty > 0 ? Math.round((finalTotal / qty) * 100) / 100 : 0;
      } else if (unitSelected !== null) {
        finalUnit = unitSelected;
        finalTotal = Math.round(finalUnit * qty * 100) / 100;
      } else {
        throw new Error('missing prices');
      }

      if (!isFinite(finalTotal) || finalTotal < 0) throw new Error('invalid total');
      if (!isFinite(finalUnit) || finalUnit < 0) throw new Error('invalid unit');

      const amountBase = baseFromCurrentCurrency(finalTotal);
      const unitPriceBase = baseFromCurrentCurrency(finalUnit);

      const isCredit = !!(spec && spec.isCredit);
      const clientName = isCredit ? String(spec.clientName || '').trim() : '';
      const dueDate = isCredit ? String(spec.dueDate || '').trim() : '';
      const paidSelected = isCredit ? clamp(Number(spec.paidAmount || 0) || 0, 0, finalTotal) : finalTotal;
      const paidAmountBase = baseFromCurrentCurrency(paidSelected);

      if (isCredit && !clientName) throw new Error('missing clientName');

      const createdAt = Date.now();
      return {
        id: idSeed,
        createdAt,
        type,
        item,
        quantity: qty,
        unitPriceBase,
        amountBase,
        pricingMode: 'unit',
        date,
        isCredit,
        clientName,
        paidAmountBase,
        isFullyPaid: !isCredit || (paidSelected >= finalTotal - 1e-9),
        dueDate: isCredit ? dueDate : '',
        reminderId: null,
        isInstallmentPlan: false,
        installments: []
      };
    }

    async function persistTransaction(tx) {
      if (!window.isNativeApp) return;
      try {
        API.saveTransaction(tx);
      } catch { }

      try {
        if (tx.isCredit && tx.dueDate) {
          await scheduleOrUpdateDebtReminder(tx);
          try { API.saveTransaction(tx); } catch { }
          saveState();
        }
      } catch { }
    }

    function aiBuildAudit(appliedTxs, errors) {
      const lines = [];
      lines.push((t('aiAppliedTitle') || 'Applied changes') + ` (${appliedTxs.length})`);
      for (const tx of appliedTxs) {
        const total = formatMoney(tx.amountBase || 0);
        lines.push(`- ${tx.type.toUpperCase()}: ${tx.item} โข x${tx.quantity} โข ${total} ${currencySymbols[state.currency]}`);
      }
      if (errors && errors.length) {
        lines.push('');
        lines.push((t('aiSomeSkipped') || 'Some actions were skipped') + ` (${errors.length})`);
        for (const e of errors.slice(0, 5)) lines.push(`- ${e}`);
      }
      return lines.join('\n');
    }

    async function askAiBackend(message) {
      // Web uses relative /api; mobile (file://) must use an absolute Server URL.
      const proto = (window.location && window.location.protocol) ? window.location.protocol : '';
      if (proto === 'file:') {
        const base = aiGetRemoteBaseUrl();
        if (!base) return aiLocalRespond(message);

        const summary = aiComputeSummaryFromState();

        try {
          const statusResp = await fetch(`${base}/api/ai/status`, { method: 'GET' });
          if (!statusResp.ok) throw new Error('no-status');
          const status = await statusResp.json();
          if (!status?.enabled) throw new Error('ai-disabled');

          const resp = await fetch(`${base}/api/ai`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, lang: state.language || 'darija', summary })
          });
          if (!resp.ok) throw new Error('ai-failed');
          const data = await resp.json();
          const text = (data?.reply || '').toString().trim();
          if (text) return text;
          throw new Error('no-reply');
        } catch {
          return aiLocalRespond(message);
        }
      }
      try {
        const summary = aiComputeSummaryFromState();
        const statusResp = await fetch('/api/ai/status', { method: 'GET' });
        if (!statusResp.ok) throw new Error('no-status');
        const status = await statusResp.json();
        if (!status?.enabled) throw new Error('ai-disabled');

        const resp = await fetch('/api/ai', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, lang: state.language || 'darija', summary })
        });
        if (!resp.ok) throw new Error('ai-failed');
        const data = await resp.json();
        const text = (data?.reply || '').toString().trim();
        if (text) return text;
        throw new Error('no-reply');
      } catch {
        return aiLocalRespond(message);
      }
    }

    function aiComputeSummaryFromState() {
      try {
        const txs = Array.isArray(state.transactions) ? state.transactions : [];
        const totalSales = txs.filter(t => t.type === 'sale').reduce((s, t) => s + (t.amountBase || 0), 0);
        const totalPurchases = txs.filter(t => t.type === 'purchase').reduce((s, t) => s + (t.amountBase || 0), 0);
        const netProfit = totalSales - totalPurchases;
        const pendingDebts = txs.filter(t => t.isCredit && !t.isFullyPaid)
          .reduce((s, t) => s + Math.max(0, (t.amountBase || 0) - (t.paidAmountBase || 0)), 0);

        const topSaleItems = (() => {
          const counts = new Map();
          txs.filter(t => t.type === 'sale').forEach(t => {
            const name = (t.item || '').toString().trim();
            if (!name) return;
            const key = name.toLowerCase();
            counts.set(key, (counts.get(key) || 0) + (t.quantity || 1));
          });
          return Array.from(counts.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([item, qty]) => ({ item, qty }));
        })();

        return { totalSales, totalPurchases, netProfit, pendingDebts, topSaleItems };
      } catch {
        return { totalSales: 0, totalPurchases: 0, netProfit: 0, pendingDebts: 0, topSaleItems: [] };
      }
    }

    function aiLocalRespond(message) {
      const q = String(message || '').toLowerCase();
      const totalSales = state.transactions.filter(t => t.type === 'sale').reduce((s, t) => s + (t.amountBase || 0), 0);
      const totalPurchases = state.transactions.filter(t => t.type === 'purchase').reduce((s, t) => s + (t.amountBase || 0), 0);
      const net = totalSales - totalPurchases;
      const pendingTxs = state.transactions.filter(t => t.isCredit && !t.isFullyPaid);
      const pending = pendingTxs
        .reduce((s, t) => s + Math.max(0, (t.amountBase || 0) - (t.paidAmountBase || 0)), 0);

      function aiLocalIntroText() {
        const lines = [];
        const title = t('aiIntroTitle') || "I'm the TIJARATI assistant";
        const body = t('aiIntroBody') || 'I help you understand your numbers and prepare safe change plans.';
        const can1 = t('aiIntroCan1') || '';
        const can2 = t('aiIntroCan2') || '';
        const can3 = t('aiIntroCan3') || '';
        const hintAsk = t('aiHintAsk') || '';
        const hintApply = t('aiHintApply') || '';

        lines.push(title);
        lines.push(body);
        const cans = [can1, can2, can3].filter(Boolean);
        if (cans.length) {
          lines.push('');
          for (const c of cans) lines.push(`- ${c}`);
        }
        if (hintAsk || hintApply) {
          lines.push('');
          if (hintAsk) lines.push(hintAsk);
          if (hintApply) lines.push(hintApply);
        }
        return lines.join('\n').trim();
      }

      const isGreeting = /\b(hi|hello|hey|salam|salem|bonjour|bonsoir|salut)\b/.test(q)
        || q.includes('ุณูุงู')
        || q.includes('ูุฑุญุจุง')
        || q.includes('ุฃููุง')
        || q.includes('ุงููุง');
      if (isGreeting) return aiLocalIntroText();

      const sym = currencySymbols[state.currency];
      const hintApply = t('aiHintApply') || '';
      const hint = hintApply ? `\n\n${hintApply}` : '';

      if (q.includes('profit') || q.includes('ุฑุจุญ') || q.includes('ุตุงูู')) {
        return `${t('netProfit')}: ${formatMoney(net)} ${sym}\n${t('income')}: ${formatMoney(totalSales)} ${sym}\n${t('expenses')}: ${formatMoney(totalPurchases)} ${sym}${hint}`;
      }
      if (q.includes('sale') || q.includes('ูุจูุนุงุช') || q.includes('ุจูุน')) {
        return `${t('income')}: ${formatMoney(totalSales)} ${sym}\n${t('netProfit')}: ${formatMoney(net)} ${sym}${hint}`;
      }
      if (q.includes('purchase') || q.includes('ูุตุฑูู') || q.includes('ุดุฑุงุก')) {
        return `${t('expenses')}: ${formatMoney(totalPurchases)} ${sym}\n${t('netProfit')}: ${formatMoney(net)} ${sym}${hint}`;
      }
      if (q.includes('debt') || q.includes('ุฏูู') || q.includes('ูุฑูุฏู')) {
        const count = pendingTxs.length;
        const countPart = count ? ` (${count})` : '';
        return `${t('pendingDebts')}${countPart}: ${formatMoney(pending)} ${sym}${hint}`;
      }

      return `${t('aiHelp')}${hint}`.trim();
    }

    function calculateTotalPendingDebt() {
      return state.transactions
        .filter(t => t.isCredit && !t.isFullyPaid)
        .reduce((sum, t) => sum + Math.max(0, (t.amountBase || 0) - (t.paidAmountBase || 0)), 0);
    }

    // ==========================
    // Transaction rows
    // ==========================
    function txBadgeHTML(tx) {
      if (!tx.isCredit) return '';
      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      const done = remaining < 0.0001;
      const bg = done ? 'color-mix(in srgb, var(--success) 14%, transparent)' : 'color-mix(in srgb, var(--warn) 16%, transparent)';
      const color = done ? 'var(--success)' : 'var(--warn)';
      const label = done ? t('paidShort') : t('creditShort');
      return `<span class="px-2 py-0.5 rounded-full text-[11px] font-black" style="background: ${bg}; color: ${color}; border: 1px solid color-mix(in srgb, ${color} 20%, var(--border));">${label}</span>`;
    }

    function createTransactionRow(tx, { compact = false } = {}) {
      const isSale = tx.type === 'sale';
      const icon = isSale ? 'trending-up' : 'trending-down';
      const accent = isSale ? 'var(--success)' : 'var(--danger)';
      const bg = `color-mix(in srgb, ${accent} 12%, transparent)`;
      const border = `color-mix(in srgb, ${accent} 18%, var(--border))`;

      const amountText = formatMoney(tx.amountBase || 0);
      const meta = [tx.date, (tx.quantity && tx.quantity > 1) ? `ร${tx.quantity}` : null].filter(Boolean).join(' โข ');
      const sub = tx.isCredit ? `${tx.clientName || ''}` : '';

      // Preserve type: numbers become `123`, strings become `'mock_tx_1'` (quoted)
      const txIdLiteral = JSON.stringify(tx.id);

      return `
        <div class="card p-4 flex items-center justify-between gap-3 animate-in cursor-pointer" onclick='openTransactionDetails(${txIdLiteral})'>
          <div class="flex items-center gap-3 min-w-0">
            <div class="w-11 h-11 rounded-2xl flex items-center justify-center flex-none" style="background: ${bg}; border: 1px solid ${border}; color: ${accent};">
              <i data-lucide="${icon}" class="w-5 h-5"></i>
            </div>
            <div class="min-w-0">
              <div class="flex items-center gap-2 min-w-0">
                <div class="font-black truncate flex-1 min-w-0">${escapeHtml(tx.item || '')}</div>
              </div>
              <div class="mt-0.5 text-xs font-bold truncate" style="color: var(--muted);">
                ${escapeHtml(meta)}${sub ? ` โข ${escapeHtml(sub)}` : ''}
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2 flex-none">
            <div class="text-left">
              <div class="font-black" style="color: ${accent};">${amountText} <span class="text-[10px] font-black currency-symbol" style="color: color-mix(in srgb, ${accent} 70%, var(--muted));"></span></div>
              ${compact ? '' : `<div class="text-xs font-bold" style="color: var(--muted);">${tx.isCredit ? (t('remaining') + ': ' + formatMoney(Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0)))) : ''}</div>`}
            </div>

            <button onclick='event.stopPropagation(); editTransaction(${txIdLiteral})' class="w-10 h-10 rounded-2xl flex items-center justify-center" style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="Edit">
              <i data-lucide="pencil" class="w-4 h-4" style="color: var(--muted);"></i>
            </button>

            <button onclick='event.stopPropagation(); deleteTransaction(${txIdLiteral})' class="w-10 h-10 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border));" aria-label="Delete">
              <i data-lucide="trash" class="w-4 h-4" style="color: color-mix(in srgb, var(--danger) 90%, var(--fg));"></i>
            </button>
          </div>
        </div>
      `;
    }

    let openTransactionDetailsId = null;

    function buildReceiptText(tx) {
      if (!tx) return '';
      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      const lines = [];
      lines.push(`${t('appName')} โ ${t('transaction')}`);
      lines.push('------------------');
      lines.push(`${t('itemName')}: ${tx.item || ''}`);
      lines.push(`${t('quantity')}: ${tx.quantity || 1}`);
      lines.push(`${t('total')}: ${formatMoney(tx.amountBase || 0)} ${currencySymbols[state.currency]}`);
      lines.push(`${t('date')}: ${tx.date || ''}`);
      if (tx.isCredit) {
        lines.push(`${t('clientName')}: ${tx.clientName || ''}`);
        lines.push(`${t('amountPaid')}: ${formatMoney(tx.paidAmountBase || 0)} ${currencySymbols[state.currency]}`);
        lines.push(`${t('remaining')}: ${formatMoney(remaining)} ${currencySymbols[state.currency]}`);
      } else {
        lines.push(t('paidLabel'));
      }
      lines.push('------------------');
      return lines.join('\n');
    }

    function buildReceiptHtml(tx) {
      if (!tx) return '';

      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      const unitBase = (tx.unitPriceBase && tx.unitPriceBase > 0)
        ? tx.unitPriceBase
        : ((tx.quantity || 1) ? (tx.amountBase || 0) / (tx.quantity || 1) : 0);
      const currency = currencySymbols[state.currency] || '';

      const safe = (v) => escapeHtml(String(v ?? ''));
      const title = `${t('receipt')} โ ${t('appName')}`;

      const rows = [
        [t('itemName'), safe(tx.item || '')],
        [t('quantity'), safe(tx.quantity || 1)],
        [t('price'), safe(`${formatMoney(unitBase)} ${currency}`)],
        [t('total'), safe(`${formatMoney(tx.amountBase || 0)} ${currency}`)],
        [t('date'), safe(tx.date || '')],
      ];

      if (tx.isCredit) {
        rows.push([t('clientName'), safe(tx.clientName || '')]);
        rows.push([t('amountPaid'), safe(`${formatMoney(tx.paidAmountBase || 0)} ${currency}`)]);
        rows.push([t('remaining'), safe(`${formatMoney(remaining)} ${currency}`)]);
        rows.push([t('debtDueDate'), safe(tx.dueDate || t('noReminder'))]);
      } else {
        rows.push([t('status') || 'Status', safe(t('paidLabel'))]);
      }

      const rowsHtml = rows.map(([k, v]) => `
        <tr>
          <td class="k">${safe(k)}</td>
          <td class="v">${v}</td>
        </tr>
      `).join('');

      return `<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>${safe(title)}</title>
    <style>
      :root { color-scheme: light; }
      body { margin: 0; padding: 22px; font-family: "IBM Plex Sans Arabic", Tahoma, Arial, system-ui, sans-serif; background: #ffffff; color: #0f172a; }
      .card { max-width: 720px; margin: 0 auto; border: 1px solid #e2e8f0; border-radius: 16px; padding: 18px; }
      h1 { margin: 0 0 6px; font-size: 22px; line-height: 1.3; }
      .sub { color: #475569; font-size: 14px; margin-bottom: 14px; }
      table { width: 100%; border-collapse: collapse; }
      td { padding: 12px 10px; border-top: 1px solid #eef2f7; vertical-align: top; font-size: 18px; line-height: 1.7; }
      td.k { width: 42%; color: #334155; font-weight: 700; }
      td.v { width: 58%; font-weight: 800; }
      .footer { margin-top: 14px; color: #64748b; font-size: 13px; }
      @media print { body { padding: 0; } .card { border: none; border-radius: 0; } }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>${safe(t('receipt'))}</h1>
      <div class="sub">${safe(t('appName'))}</div>
      <table>
        ${rowsHtml}
      </table>
      <div class="footer">${safe(new Date().toLocaleString())}</div>
    </div>
  </body>
</html>`;
    }

    async function shareReceiptText(text) {
      try {
        if (!text) return;
        if (window.isNativeApp) {
          // Delegate to native share sheet.
          if (window.ReactNativeWebView) {
            const id = Date.now() + Math.random().toString();
            const handler = (event) => {
              let data = event.data;
              try { if (typeof data === 'string') data = JSON.parse(data); } catch (e) { }
              if (data && data.id === id) {
                document.removeEventListener('message', handler);
                window.removeEventListener('message', handler);
              }
            };
            document.addEventListener('message', handler);
            window.addEventListener('message', handler);
            window.ReactNativeWebView.postMessage(JSON.stringify({ id, type: 'SHARE_TEXT', payload: { title: t('receipt'), text } }));
          }
          return;
        }

        if (navigator.share) {
          await navigator.share({ title: t('receipt'), text });
        } else {
          await navigator.clipboard.writeText(text);
          showToast(t('copied'), 'success');
        }
      } catch {
        // ignore
      }
    }

    async function shareReceipt(tx) {
      if (!tx) return;

      // Native: share an HTML receipt for better readability (bigger font + RTL layout).
      if (window.isNativeApp) {
        const safeId = String(tx.id ?? Date.now()).replace(/[^a-z0-9_\-]+/gi, '_');
        const html = buildReceiptHtml(tx);
        const res = await API.saveFileWithType(`tijarati_receipt_${safeId}.html`, html, 'text/html');
        if (res && res.message) showToast(res.message, 'success');
        return;
      }

      const text = buildReceiptText(tx);
      await shareReceiptText(text);
    }

    async function downloadReceiptText(fileName, text) {
      if (!text) return;
      const name = fileName || `tijarati_receipt_${Date.now()}.txt`;
      if (window.isNativeApp) {
        const res = await API.saveFileWithType(name, text, 'text/plain');
        if (res && res.message) showToast(res.message, 'success');
        return;
      }
      await API.saveFileWithType(name, text, 'text/plain');
      showToast(t('saved'), 'success');
    }

    async function downloadReceiptHtml(fileName, tx) {
      if (!tx) return;
      const safeId = String(tx.id ?? Date.now()).replace(/[^a-z0-9_\-]+/gi, '_');
      const name = fileName || `tijarati_receipt_${safeId}.html`;
      const html = buildReceiptHtml(tx);
      if (window.isNativeApp) {
        const res = await API.saveFileWithType(name, html, 'text/html');
        if (res && res.message) showToast(res.message, 'success');
        return;
      }
      await API.saveFileWithType(name, html, 'text/html');
      showToast(t('saved'), 'success');
    }

    function openTransactionDetails(id, tab = 'details') {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;
      openTransactionDetailsId = id;

      const isSale = tx.type === 'sale';
      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      const unitBase = (tx.unitPriceBase && tx.unitPriceBase > 0) ? tx.unitPriceBase : ((tx.quantity || 1) ? (tx.amountBase || 0) / (tx.quantity || 1) : 0);

      document.getElementById('txd-item').textContent = tx.item || '';
      document.getElementById('txd-type').textContent = isSale ? t('filterSales') : t('filterPurchases');
      document.getElementById('txd-date').textContent = tx.date || '';

      const clientRow = document.getElementById('txd-client-row');
      if (tx.isCredit) {
        clientRow.classList.remove('hidden');
        document.getElementById('txd-client').textContent = tx.clientName || '';
      } else {
        clientRow.classList.add('hidden');
        document.getElementById('txd-client').textContent = '';
      }

      document.getElementById('txd-qty').textContent = String(tx.quantity || 1);
      document.getElementById('txd-unit').textContent = `${formatMoney(unitBase)} ${currencySymbols[state.currency]}`;
      document.getElementById('txd-total').textContent = `${formatMoney(tx.amountBase || 0)} ${currencySymbols[state.currency]}`;

      const creditBox = document.getElementById('txd-credit-box');
      const creditActions = document.getElementById('txd-credit-actions');
      const settleBtn = document.getElementById('txd-settle');
      const clearBtn = document.getElementById('txd-clear-reminder');

      if (tx.isCredit) {
        creditBox.classList.remove('hidden');
        creditActions.classList.remove('hidden');
        document.getElementById('txd-paid').textContent = `${formatMoney(tx.paidAmountBase || 0)} ${currencySymbols[state.currency]}`;
        document.getElementById('txd-remaining').textContent = `${formatMoney(remaining)} ${currencySymbols[state.currency]}`;
        document.getElementById('txd-reminder').textContent = tx.dueDate || t('noReminder');

        // Toggle clear reminder
        if (tx.dueDate) clearBtn.classList.remove('hidden');
        else clearBtn.classList.add('hidden');

        // Show settle only when still pending
        if (!tx.isFullyPaid && remaining > 0.0001) settleBtn.classList.remove('hidden');
        else settleBtn.classList.add('hidden');
      } else {
        creditBox.classList.add('hidden');
        creditActions.classList.add('hidden');
        settleBtn.classList.add('hidden');
      }

      const receipt = buildReceiptText(tx);
      document.getElementById('txd-receipt').textContent = receipt;

      document.getElementById('txd-share').onclick = async () => shareReceipt(tx);
      document.getElementById('txd-download').onclick = async () => downloadReceiptHtml(`tijarati_receipt_${String(tx.id).replace(/[^a-z0-9_\-]+/gi, '_')}.html`, tx);
      document.getElementById('txd-delete').onclick = () => {
        closeTransactionDetails();
        deleteTransaction(tx.id);
      };

      // Credit-only actions
      document.getElementById('txd-set-reminder').onclick = () => pickDebtReminderDate(tx.id);
      clearBtn.onclick = async () => { await clearDebtReminder(tx.id); refreshTransactionDetails(tx.id); };
      settleBtn.onclick = () => settleDebt(tx.id);

      const modal = document.getElementById('transaction-details-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      lucide.createIcons();

      // For now tab only drives intent (receipt icon opens modal); could be expanded later.
      void tab;
    }

    function refreshTransactionDetails(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;
      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      if (tx.isCredit) {
        document.getElementById('txd-paid').textContent = `${formatMoney(tx.paidAmountBase || 0)} ${currencySymbols[state.currency]}`;
        document.getElementById('txd-remaining').textContent = `${formatMoney(remaining)} ${currencySymbols[state.currency]}`;
        document.getElementById('txd-reminder').textContent = tx.dueDate || t('noReminder');
        const clearBtn = document.getElementById('txd-clear-reminder');
        if (tx.dueDate) clearBtn.classList.remove('hidden');
        else clearBtn.classList.add('hidden');
        const settleBtn = document.getElementById('txd-settle');
        if (!tx.isFullyPaid && remaining > 0.0001) settleBtn.classList.remove('hidden');
        else settleBtn.classList.add('hidden');
      }
      const receipt = buildReceiptText(tx);
      document.getElementById('txd-receipt').textContent = receipt;
    }

    function closeTransactionDetails() {
      const modal = document.getElementById('transaction-details-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      openTransactionDetailsId = null;
    }

    function emptyState(icon, text) {
      return `
        <div class="card p-6 text-center" style="background: color-mix(in srgb, var(--surface) 70%, transparent);">
          <div class="mx-auto w-12 h-12 rounded-2xl flex items-center justify-center" style="background: var(--surface-2); border: 1px solid var(--border); color: var(--muted);">
            <i data-lucide="${icon}" class="w-6 h-6"></i>
          </div>
          <div class="mt-3 text-sm font-black">${escapeHtml(text)}</div>
        </div>
      `;
    }

    // ==========================
    // Transaction flow
    // ==========================
    function openQuickAdd() {
      const q = document.getElementById('quick-add');
      q.classList.remove('hidden');
      q.classList.add('flex');
      lucide.createIcons();
    }

    function closeQuickAdd() {
      const q = document.getElementById('quick-add');
      q.classList.add('hidden');
      q.classList.remove('flex');
    }

    function startFlow(type) {
      state.currentFlow = type;
      state.editingTxId = null;

      // reset
      document.getElementById('tx-item').value = '';
      const unitEl = document.getElementById('tx-unit-price');
      const totalEl = document.getElementById('tx-total-price');
      if (unitEl) unitEl.value = '';
      if (totalEl) totalEl.value = '';
      document.getElementById('tx-qty').value = '';
      document.getElementById('tx-client').value = '';
      document.getElementById('tx-paid-amount').value = '';
      const due = document.getElementById('tx-due-date');
      if (due) due.value = '';
      document.getElementById('tx-date').value = new Date().toISOString().slice(0, 10);

      // header
      const header = document.getElementById('modal-header');
      const title = document.getElementById('modal-title');
      if (type === 'sale') {
        header.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-2))';
        title.textContent = t('newSale');
        generateSuggestions(getTopItemSuggestions('sale'));
      } else {
        header.style.background = 'linear-gradient(135deg, #334155, #0f172a)';
        title.textContent = t('newPurchase');
        generateSuggestions(getTopItemSuggestions('purchase'));
      }

      setPaymentType('paid');

      setPricingMode('unit');

      const modal = document.getElementById('transaction-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      recalculatePricing();
      lucide.createIcons();

      // focus
      setTimeout(() => document.getElementById('tx-item').focus(), 60);
    }

    function closeModal() {
      const modal = document.getElementById('transaction-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function setPaymentType(type) {
      state.paymentType = type;

      const paid = document.getElementById('btn-paid');
      const credit = document.getElementById('btn-credit');
      const details = document.getElementById('credit-details');

      const active = {
        background: 'linear-gradient(135deg, var(--primary), var(--primary-2))',
        color: '#fff',
        border: '1px solid color-mix(in srgb, var(--primary-2) 22%, transparent)'
      };

      const inactive = {
        background: 'transparent',
        color: 'var(--muted)',
        border: '1px solid transparent'
      };

      const apply = (el, st) => {
        el.style.background = st.background;
        el.style.color = st.color;
        el.style.border = st.border;
      };

      if (type === 'paid') {
        apply(paid, active);
        apply(credit, inactive);
        details.classList.add('hidden');
      } else {
        // use warn accent for credit
        paid.style.background = 'transparent';
        paid.style.color = 'var(--muted)';
        paid.style.border = '1px solid transparent';

        credit.style.background = 'linear-gradient(135deg, color-mix(in srgb, var(--warn) 85%, #fb7185), var(--warn))';
        credit.style.color = '#1f2937';
        credit.style.border = '1px solid color-mix(in srgb, var(--warn) 22%, transparent)';

        details.classList.remove('hidden');
      }
      recalculatePricing();
    }

    function generateSuggestions(items) {
      const container = document.getElementById('quick-suggestions');
      container.innerHTML = items.map(i => {
        const safe = escapeHtml(i);
        return `<button class="chip" onclick="document.getElementById('tx-item').value='${i.replace(/'/g, "\\'")}';">${safe}</button>`;
      }).join('');
    }

    function getTopItemSuggestions(type, limit = 10) {
      const counts = new Map();
      const latestLabel = new Map();

      (state.transactions || []).forEach((t) => {
        if (t.type !== type) return;
        const raw = (t.item || '').trim();
        if (!raw) return;
        const key = raw.toLowerCase();
        counts.set(key, (counts.get(key) || 0) + 1);
        latestLabel.set(key, raw);
      });

      const items = Array.from(counts.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, limit)
        .map(([k]) => latestLabel.get(k) || k);

      if (items.length) return items;

      // Fallback for first-run
      const lang = state.language;
      const fallback = {
        darija: { sale: ['ุฎุจุฒ', 'ุญููุจ', 'ูููุฉ', 'ูุณูู', 'ุนุตูุฑ', 'ูุงุก'], purchase: ['ุทุญูู', 'ุฒูุช', 'ุณูุฑ', 'ุฎุถุฑุฉ', 'ุจูุทุฉ', 'ูููุฉ'] },
        arabic: { sale: ['ุฎุจุฒ', 'ุญููุจ', 'ูููุฉ', 'ูุณูู', 'ุนุตูุฑ', 'ูุงุก'], purchase: ['ุทุญูู', 'ุฒูุช', 'ุณูุฑ', 'ุฎุถุฑุฉ', 'ุบุงุฒ', 'ูููุฉ'] },
        english: { sale: ['Bread', 'Milk', 'Coffee', 'Juice', 'Water', 'Tea'], purchase: ['Flour', 'Oil', 'Sugar', 'Vegetables', 'Gas', 'Coffee'] },
        french: { sale: ['Pain', 'Lait', 'Cafรฉ', 'Jus', 'Eau', 'Thรฉ'], purchase: ['Farine', 'Huile', 'Sucre', 'Lรฉgumes', 'Gaz', 'Cafรฉ'] }
      };
      const group = fallback[lang] || fallback.darija;
      return group[type] || group.sale;
    }

    function setPricingMode(mode) {
      state.pricingMode = mode === 'total' ? 'total' : 'unit';
      saveState();

      const btnUnit = document.getElementById('btn-mode-unit');
      const btnTotal = document.getElementById('btn-mode-total');
      const unitInput = document.getElementById('tx-unit-price');
      const totalInput = document.getElementById('tx-total-price');
      const hint = document.getElementById('pricing-hint');

      const active = {
        background: 'linear-gradient(135deg, var(--primary), var(--primary-2))',
        color: '#fff',
        border: '1px solid color-mix(in srgb, var(--primary-2) 22%, transparent)'
      };
      const inactive = { background: 'transparent', color: 'var(--muted)', border: '1px solid transparent' };

      const apply = (el, st) => {
        if (!el) return;
        el.style.background = st.background;
        el.style.color = st.color;
        el.style.border = st.border;
      };

      if (state.pricingMode === 'unit') {
        apply(btnUnit, active);
        apply(btnTotal, inactive);
        if (unitInput) { unitInput.readOnly = false; unitInput.style.opacity = '1'; }
        if (totalInput) { totalInput.readOnly = true; totalInput.style.opacity = '0.65'; }
        if (hint) hint.textContent = t('unitModeHint');
      } else {
        apply(btnTotal, active);
        apply(btnUnit, inactive);
        if (totalInput) { totalInput.readOnly = false; totalInput.style.opacity = '1'; }
        if (unitInput) { unitInput.readOnly = true; unitInput.style.opacity = '0.65'; }
        if (hint) hint.textContent = t('totalModeHint');
      }

      recalculatePricing();
    }

    function recalculatePricing() {
      const mode = state.pricingMode || 'unit';
      const qtyRaw = (document.getElementById('tx-qty')?.value || '').trim();
      const qty = parseFloat(qtyRaw);
      const unitEl = document.getElementById('tx-unit-price');
      const totalEl = document.getElementById('tx-total-price');

      if (!qtyRaw || !isFinite(qty) || qty <= 0) {
        document.getElementById('tx-total-preview').textContent = formatMoney(0);
        applyCurrency();
        return;
      }

      const unit = parseFloat(unitEl?.value || '');
      const total = parseFloat(totalEl?.value || '');

      if (mode === 'unit') {
        if (!isFinite(unit) || unit < 0) {
          document.getElementById('tx-total-preview').textContent = formatMoney(0);
          applyCurrency();
          return;
        }
        const computedTotal = Math.round(unit * qty * 100) / 100;
        if (totalEl) totalEl.value = String(computedTotal);
        document.getElementById('tx-total-preview').textContent = formatMoney(baseFromCurrentCurrency(computedTotal));
      } else {
        if (!isFinite(total) || total < 0) {
          document.getElementById('tx-total-preview').textContent = formatMoney(0);
          applyCurrency();
          return;
        }
        const computedUnit = Math.round((total / qty) * 100) / 100;
        if (unitEl) unitEl.value = String(computedUnit);
        document.getElementById('tx-total-preview').textContent = formatMoney(baseFromCurrentCurrency(total));
      }

      applyCurrency();
    }

    function saveTransaction() {
      const item = (document.getElementById('tx-item').value || '').trim();
      const mode = state.pricingMode || 'unit';
      const qtyRaw = (document.getElementById('tx-qty').value || '').trim();
      const qty = parseFloat(qtyRaw);
      const unitPrice = parseFloat(document.getElementById('tx-unit-price')?.value || '');
      const totalPrice = parseFloat(document.getElementById('tx-total-price')?.value || '');
      const date = document.getElementById('tx-date').value;

      if (!item || !date) {
        showToast(t('fillAll'), 'error');
        return;
      }

      if (!isFinite(qty) || qty <= 0) {
        showToast(t('quantityRequired'), 'error');
        return;
      }

      let finalUnit = 0;
      let finalTotal = 0;

      if (mode === 'unit') {
        if (!isFinite(unitPrice) || unitPrice <= 0) {
          showToast(t('unitPriceRequired'), 'error');
          return;
        }
        finalUnit = unitPrice;
        finalTotal = Math.round(unitPrice * qty * 100) / 100;
      } else {
        if (!isFinite(totalPrice) || totalPrice <= 0) {
          showToast(t('totalPriceRequired'), 'error');
          return;
        }
        finalTotal = totalPrice;
        finalUnit = Math.round((totalPrice / qty) * 100) / 100;
      }

      const totalSelected = finalTotal;
      const amountBase = baseFromCurrentCurrency(totalSelected);

      const isCredit = state.paymentType === 'credit';
      let client = '';
      let paidSelected = totalSelected;
      let dueDate = '';

      if (isCredit) {
        client = (document.getElementById('tx-client').value || '').trim();
        paidSelected = parseFloat(document.getElementById('tx-paid-amount').value) || 0;
        dueDate = (document.getElementById('tx-due-date')?.value || '').trim();
        if (!client) {
          showToast(t('needClient'), 'error');
          return;
        }
      }

      paidSelected = clamp(paidSelected, 0, totalSelected);
      const paidAmountBase = baseFromCurrentCurrency(paidSelected);

      const now = Date.now();
      const editingId = state.editingTxId;
      const existing = editingId ? state.transactions.find(t => t.id === editingId) : null;

      const tx = {
        id: editingId ?? now,
        createdAt: existing?.createdAt ?? now,
        type: state.currentFlow,
        item,
        quantity: qty,
        unitPriceBase: baseFromCurrentCurrency(finalUnit),
        amountBase,
        pricingMode: mode,
        date,
        isCredit,
        clientName: client,
        paidAmountBase,
        isFullyPaid: !isCredit || (paidSelected >= totalSelected - 1e-9),
        dueDate: isCredit ? dueDate : '',
        reminderId: existing?.reminderId ?? null,
        isInstallmentPlan: existing?.isInstallmentPlan ?? false,
        installments: existing?.installments ?? []
      };

      if (editingId) {
        const idx = state.transactions.findIndex(t => t.id === editingId);
        if (idx >= 0) state.transactions[idx] = { ...state.transactions[idx], ...tx };
        else state.transactions.push(tx);
      } else {
        state.transactions.push(tx);
      }
      state.editingTxId = null;
      touchLocalChange();
      saveState();
      if (window.isNativeApp) {
        API.saveTransaction(tx);
        // schedule reminder (if any) and persist reminderId
        if (tx.isCredit && tx.dueDate) {
          scheduleOrUpdateDebtReminder(tx).then(() => {
            API.saveTransaction(tx);
            saveState();
          });
        }
      }
      closeModal();
      updateDashboard();
      showToast(t('saved'), 'success');
    }

    function editTransaction(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;

      state.currentFlow = tx.type;
      state.editingTxId = tx.id;

      // header
      const header = document.getElementById('modal-header');
      const title = document.getElementById('modal-title');
      if (tx.type === 'sale') {
        header.style.background = 'linear-gradient(135deg, var(--primary), var(--primary-2))';
        title.textContent = t('editSale') || t('newSale');
        generateSuggestions(getTopItemSuggestions('sale'));
      } else {
        header.style.background = 'linear-gradient(135deg, #334155, #0f172a)';
        title.textContent = t('editPurchase') || t('newPurchase');
        generateSuggestions(getTopItemSuggestions('purchase'));
      }

      document.getElementById('tx-item').value = tx.item || '';
      document.getElementById('tx-qty').value = (tx.quantity ?? '') !== null ? String(tx.quantity ?? '') : '';
      document.getElementById('tx-date').value = tx.date || new Date().toISOString().slice(0, 10);
      document.getElementById('tx-client').value = tx.clientName || '';

      const mode = tx.pricingMode || 'unit';
      setPricingMode(mode);

      const unitSelected = currentFromBase(tx.unitPriceBase || 0);
      const totalSelected = currentFromBase(tx.amountBase || 0);

      const unitEl = document.getElementById('tx-unit-price');
      const totalEl = document.getElementById('tx-total-price');

      if (mode === 'unit') {
        if (unitEl) unitEl.value = String(Math.round(unitSelected * 100) / 100);
        if (totalEl) totalEl.value = '';
      } else {
        if (totalEl) totalEl.value = String(Math.round(totalSelected * 100) / 100);
        if (unitEl) unitEl.value = '';
      }

      setPaymentType(tx.isCredit ? 'credit' : 'paid');
      document.getElementById('tx-paid-amount').value = tx.isCredit ? String(Math.round(currentFromBase(tx.paidAmountBase || 0) * 100) / 100) : '';
      const due = document.getElementById('tx-due-date');
      if (due) due.value = tx.isCredit ? (tx.dueDate || '') : '';

      const modal = document.getElementById('transaction-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      recalculatePricing();
      lucide.createIcons();

      setTimeout(() => document.getElementById('tx-item').focus(), 60);
    }

    // ==========================
    // Debt reminders
    // ==========================
    let pendingReminderTxId = null;

    function pickDebtReminderDate(txId) {
      pendingReminderTxId = txId;
      const picker = document.getElementById('debt-reminder-picker');
      if (!picker) return;
      const tx = state.transactions.find(t => t.id === txId);
      picker.value = (tx && tx.dueDate) ? tx.dueDate : '';
      if (picker.showPicker) picker.showPicker();
      else picker.click();
    }

    async function scheduleOrUpdateDebtReminder(tx) {
      if (!window.isNativeApp) return;
      if (!tx || !tx.isCredit) return;

      // Cancel old reminder
      if (tx.reminderId) {
        try { await API.cancelDebtReminder(tx.reminderId); } catch { }
        tx.reminderId = null;
      }

      if (!tx.dueDate) return;
      const trigger = new Date(tx.dueDate + 'T09:00:00');
      if (Number.isNaN(trigger.getTime())) return;
      // If date is in the past, don't schedule.
      if (trigger.getTime() < Date.now() + 60 * 1000) return;

      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      const title = `${t('appName')} โ ${tx.type === 'sale' ? t('filterSales') : t('filterPurchases')}`;
      const body = `${tx.clientName || ''} โข ${tx.item || ''} โข ${t('remaining')}: ${formatMoney(remaining)} ${currencySymbols[state.currency]}`;

      const res = await API.scheduleDebtReminder({
        txId: tx.id,
        timestamp: trigger.getTime(),
        title,
        body
      });
      if (res && res.success && res.reminderId) {
        tx.reminderId = res.reminderId;
      }
    }

    async function setDebtDueDate(txId, dueDate) {
      const tx = state.transactions.find(t => t.id === txId);
      if (!tx) return;
      tx.dueDate = (dueDate || '').trim();
      await scheduleOrUpdateDebtReminder(tx);
      saveState();
      if (window.isNativeApp) await API.saveTransaction(tx);
      renderDebts(true);
      updateDashboard();
      if (document.getElementById('debt-details-modal') && !document.getElementById('debt-details-modal').classList.contains('hidden')) {
        refreshDebtDetails(txId);
      }
      if (document.getElementById('transaction-details-modal') && !document.getElementById('transaction-details-modal').classList.contains('hidden')) {
        refreshTransactionDetails(txId);
      }
    }

    async function clearDebtReminder(txId) {
      const tx = state.transactions.find(t => t.id === txId);
      if (!tx) return;
      tx.dueDate = '';
      await scheduleOrUpdateDebtReminder(tx);
      saveState();
      if (window.isNativeApp) await API.saveTransaction(tx);
      renderDebts(true);
      updateDashboard();
    }

    // live total preview
    function bindTxInputs() {
      ['tx-unit-price', 'tx-total-price', 'tx-qty'].forEach(id => {
        const el = document.getElementById(id);
        el && el.addEventListener('input', recalculatePricing);
      });
      const paid = document.getElementById('tx-paid-amount');
      paid && paid.addEventListener('input', recalculatePricing);
    }

    // ==========================
    // History
    // ==========================
    const historyFilters = [
      { key: 'all', labelKey: 'filterAll' },
      { key: 'sale', labelKey: 'filterSales' },
      { key: 'purchase', labelKey: 'filterPurchases' },
      { key: 'debt', labelKey: 'filterCredits' },
    ];

    function renderHistoryFilters(active = state.historyFilter || 'all') {
      state.historyFilter = active;
      saveState();
      const container = document.getElementById('history-filters');
      if (!container) return;
      container.innerHTML = historyFilters.map(f => {
        const isActive = f.key === active;
        return `<button class="chip ${isActive ? 'active' : ''}" onclick="filterHistory('${f.key}')">${escapeHtml(t(f.labelKey))}</button>`;
      }).join('');
    }

    function renderHistory() {
      filterHistory(state.historyFilter || 'all', { silentUI: false });
    }

    function filterHistory(filter, { silentUI = true } = {}) {
      if (!silentUI) renderHistoryFilters(filter);
      else {
        state.historyFilter = filter;
        saveState();
        renderHistoryFilters(filter);
      }

      const search = (document.getElementById('history-search')?.value || '').trim().toLowerCase();
      let data = [...state.transactions].sort((a, b) => (b.date || '').localeCompare(a.date || '') || (b.createdAt || 0) - (a.createdAt || 0));

      if (filter === 'sale') data = data.filter(t => t.type === 'sale');
      if (filter === 'purchase') data = data.filter(t => t.type === 'purchase');
      if (filter === 'debt') data = data.filter(t => t.isCredit && !t.isFullyPaid);

      if (search) {
        data = data.filter(t =>
          (t.item || '').toLowerCase().includes(search) ||
          (t.clientName || '').toLowerCase().includes(search)
        );
      }

      const container = document.getElementById('full-history-list');
      if (!container) return;

      if (data.length === 0) {
        container.innerHTML = emptyState('inbox', t('emptyHistory'));
        lucide.createIcons();
        return;
      }

      // Group by date
      const groups = {};
      for (const tx of data) {
        const d = tx.date || 'โ';
        if (!groups[d]) groups[d] = [];
        groups[d].push(tx);
      }

      const dates = Object.keys(groups).sort((a, b) => b.localeCompare(a));
      container.innerHTML = dates.map(d => {
        const items = groups[d].map(tx => createTransactionRow(tx, { compact: false })).join('');
        return `
          <div>
            <div class="flex items-center justify-between mb-2">
              <div class="text-xs font-black" style="color: var(--muted);">${escapeHtml(d)}</div>
              <div class="text-[11px] font-bold" style="color: var(--muted);">${groups[d].length}</div>
            </div>
            <div class="space-y-3">${items}</div>
          </div>
        `;
      }).join('');

      applyCurrency();
      lucide.createIcons();
    }

    // ==========================
    // Debts
    // ==========================
    function renderDebts(force = false) {
      const search = (document.getElementById('debts-search')?.value || '').trim().toLowerCase();
      const container = document.getElementById('debts-list');
      if (!container) return;

      const debts = state.transactions
        .filter(t => t.isCredit && !t.isFullyPaid)
        .filter(t => !search || (t.clientName || '').toLowerCase().includes(search) || (t.item || '').toLowerCase().includes(search))
        .sort((a, b) => (b.date || '').localeCompare(a.date || '') || (b.createdAt || 0) - (a.createdAt || 0));

      const total = debts.reduce((sum, t) => sum + Math.max(0, (t.amountBase || 0) - (t.paidAmountBase || 0)), 0);
      document.getElementById('debts-total').textContent = formatMoney(total);

      if (debts.length === 0) {
        container.innerHTML = emptyState('shield-check', t('emptyDebts'));
        lucide.createIcons();
        return;
      }

      container.innerHTML = debts.map(tx => {
        const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
        const typeIsSale = tx.type === 'sale';
        const typeLabel = typeIsSale ? t('filterSales') : t('filterPurchases');
        const typeAccent = typeIsSale ? 'var(--success)' : 'var(--danger)';
        const txIdLiteral = JSON.stringify(tx.id);
        return `
          <div class="card p-4 flex items-center justify-between gap-3 animate-in cursor-pointer" onclick='openDebtDetails(${txIdLiteral})'>
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <div class="w-10 h-10 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, var(--warn) 14%, transparent); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border)); color: var(--warn);">
                  <i data-lucide="user" class="w-5 h-5"></i>
                </div>
                <div class="min-w-0">
                  <div class="flex items-center gap-2 min-w-0">
                    <div class="font-black truncate flex-1 min-w-0">${escapeHtml(tx.clientName || '')}</div>
                    <span class="px-2 py-0.5 rounded-full text-[11px] font-black flex-none" style="background: color-mix(in srgb, ${typeAccent} 12%, transparent); color: ${typeAccent}; border: 1px solid color-mix(in srgb, ${typeAccent} 18%, var(--border));">${escapeHtml(typeLabel)}</span>
                  </div>
                  <div class="text-xs font-bold truncate" style="color: var(--muted);">${escapeHtml(tx.item || '')} โข ${escapeHtml(tx.date || '')}</div>
                  <div class="mt-1 text-[11px] font-bold truncate" style="color: var(--muted);">${escapeHtml(t('debtDueDate'))}: ${escapeHtml(tx.dueDate || t('noReminder'))}</div>
                </div>
              </div>
            </div>

            <div class="flex flex-col items-end gap-2 flex-none">
              <div class="font-black" style="color: var(--warn);">${formatMoney(remaining)} <span class="text-[10px] font-black currency-symbol" style="color: color-mix(in srgb, var(--warn) 70%, var(--muted));"></span></div>
              <div class="w-9 h-9 rounded-2xl flex items-center justify-center" style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="${escapeHtml(t('debtDetailsTitle'))}">
                <i data-lucide="chevron-right" class="w-4 h-4" style="color: var(--muted);"></i>
              </div>
            </div>
          </div>
        `;
      }).join('');

      applyCurrency();
      lucide.createIcons();
    }

    function settleDebt(id) {
      const txIndex = state.transactions.findIndex(t => t.id === id);
      if (txIndex < 0) return;

      openConfirm({
        title: t('confirmTitle'),
        message: t('settleDebtConfirmMessage'),
        confirmText: t('confirmAction'),
        danger: false,
        onConfirm: async () => {
          const tx = state.transactions[txIndex];
          closeDebtDetails();
          // Clear reminders when settling
          if (tx.reminderId && window.isNativeApp) {
            try { await API.cancelDebtReminder(tx.reminderId); } catch { }
          }
          tx.reminderId = null;
          tx.dueDate = '';
          tx.paidAmountBase = tx.amountBase;
          tx.isFullyPaid = true;
          touchLocalChange();
          saveState();
          if (window.isNativeApp) API.saveTransaction(tx);
          renderDebts();
          updateDashboard();
          showToast('โ', 'success');
        }
      });
    }

    let openDebtDetailsTxId = null;

    function toggleDebtInstallments() {
      if (!openDebtDetailsTxId) return;
      const tx = state.transactions.find(t => t.id === openDebtDetailsTxId);
      if (!tx) return;

      const enabled = !!document.getElementById('debt-installments-enabled')?.checked;
      tx.isInstallmentPlan = enabled;
      if (!Array.isArray(tx.installments)) tx.installments = [];

      touchLocalChange();
      saveState();
      if (window.isNativeApp) API.saveTransaction(tx);

      const section = document.getElementById('debt-installments-section');
      if (section) {
        if (enabled) section.classList.remove('hidden');
        else section.classList.add('hidden');
      }
      renderDebtInstallments(tx);
    }

    function renderDebtInstallments(tx) {
      const list = document.getElementById('debt-installments-list');
      if (!list) return;

      const payments = Array.isArray(tx.installments) ? tx.installments : [];
      if (payments.length === 0) {
        list.innerHTML = `<div class="text-xs font-bold" style="color: var(--muted);">${escapeHtml(t('noPayments'))}</div>`;
        return;
      }

      list.innerHTML = payments
        .slice()
        .sort((a, b) => (b.date || '').localeCompare(a.date || '') || (b.at || 0) - (a.at || 0))
        .map(p => {
          const idLiteral = JSON.stringify(p.id);
          const amt = formatMoney(p.amountBase || 0);
          const dt = p.date || '';
          return `
            <div class="flex items-center justify-between gap-2 rounded-2xl p-3" style="background: var(--surface); border: 1px solid var(--border);">
              <div class="min-w-0">
                <div class="text-sm font-black truncate">${escapeHtml(dt)}</div>
                <div class="text-xs font-bold" style="color: var(--muted);">${escapeHtml(t('payment'))}</div>
              </div>
              <div class="flex items-center gap-2 flex-none">
                <div class="text-sm font-black" style="color: var(--warn);">${amt} <span class="text-[10px] font-black currency-symbol"></span></div>
                <button onclick='removeDebtInstallment(${idLiteral})' class="w-9 h-9 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border));" aria-label="Delete">
                  <i data-lucide="trash" class="w-4 h-4" style="color: color-mix(in srgb, var(--danger) 90%, var(--fg));"></i>
                </button>
              </div>
            </div>
          `;
        }).join('');

      applyCurrency();
      lucide.createIcons();
    }

    function addDebtInstallmentPayment() {
      if (!openDebtDetailsTxId) return;
      const tx = state.transactions.find(t => t.id === openDebtDetailsTxId);
      if (!tx) return;

      const amountSelected = parseFloat(document.getElementById('debt-payment-amount')?.value || '');
      const date = (document.getElementById('debt-payment-date')?.value || '').trim() || new Date().toISOString().slice(0, 10);
      if (!isFinite(amountSelected) || amountSelected <= 0) {
        showToast(t('paymentAmountRequired'), 'error');
        return;
      }

      const amountBase = baseFromCurrentCurrency(amountSelected);
      if (!Array.isArray(tx.installments)) tx.installments = [];

      const payment = { id: String(Date.now()), date, amountBase, at: Date.now() };
      tx.installments.push(payment);
      tx.isInstallmentPlan = true;

      const newPaid = clamp((tx.paidAmountBase || 0) + amountBase, 0, tx.amountBase || 0);
      tx.paidAmountBase = newPaid;
      tx.isFullyPaid = (tx.isCredit && (tx.amountBase || 0) - (tx.paidAmountBase || 0) < 0.0001) || !tx.isCredit;

      touchLocalChange();
      saveState();
      if (window.isNativeApp) API.saveTransaction(tx);

      document.getElementById('debt-payment-amount').value = '';
      document.getElementById('debt-payment-date').value = date;

      refreshDebtDetails(tx.id);
      renderDebtInstallments(tx);
      renderDebts(true);
      updateDashboard();
      showToast('โ', 'success');
    }

    function removeDebtInstallment(paymentId) {
      if (!openDebtDetailsTxId) return;
      const tx = state.transactions.find(t => t.id === openDebtDetailsTxId);
      if (!tx || !Array.isArray(tx.installments)) return;

      const idx = tx.installments.findIndex(p => p.id === paymentId);
      if (idx < 0) return;

      const amt = tx.installments[idx]?.amountBase || 0;
      tx.installments.splice(idx, 1);
      tx.paidAmountBase = clamp((tx.paidAmountBase || 0) - amt, 0, tx.amountBase || 0);
      tx.isFullyPaid = (tx.isCredit && (tx.amountBase || 0) - (tx.paidAmountBase || 0) < 0.0001) || !tx.isCredit;
      if (tx.installments.length === 0) tx.isInstallmentPlan = false;

      touchLocalChange();
      saveState();
      if (window.isNativeApp) API.saveTransaction(tx);

      refreshDebtDetails(tx.id);
      renderDebtInstallments(tx);
      renderDebts(true);
      updateDashboard();
      lucide.createIcons();
    }

    function openDebtDetails(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;

      openDebtDetailsTxId = tx.id;

      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));

      document.getElementById('debt-details-client').textContent = tx.clientName || '';
      document.getElementById('debt-details-item').textContent = tx.item || '';
      document.getElementById('debt-details-date').textContent = tx.date || '';
      document.getElementById('debt-details-type').textContent = tx.type === 'sale' ? t('filterSales') : t('filterPurchases');
      document.getElementById('debt-details-total').textContent = `${formatMoney(tx.amountBase || 0)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-paid').textContent = `${formatMoney(tx.paidAmountBase || 0)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-remaining').textContent = `${formatMoney(remaining)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-reminder').textContent = tx.dueDate || t('noReminder');

      // installments UI
      const cb = document.getElementById('debt-installments-enabled');
      const section = document.getElementById('debt-installments-section');
      if (cb) cb.checked = !!tx.isInstallmentPlan;
      if (section) {
        if (tx.isInstallmentPlan) section.classList.remove('hidden');
        else section.classList.add('hidden');
      }
      const payDate = document.getElementById('debt-payment-date');
      if (payDate && !payDate.value) payDate.value = new Date().toISOString().slice(0, 10);
      renderDebtInstallments(tx);

      const setBtn = document.getElementById('debt-details-set-reminder');
      const clearBtn = document.getElementById('debt-details-clear-reminder');
      const settleBtn = document.getElementById('debt-details-settle');

      setBtn.onclick = (e) => { e && e.stopPropagation && e.stopPropagation(); pickDebtReminderDate(tx.id); };
      clearBtn.onclick = async (e) => { e && e.stopPropagation && e.stopPropagation(); await clearDebtReminder(tx.id); refreshDebtDetails(tx.id); };
      settleBtn.onclick = (e) => { e && e.stopPropagation && e.stopPropagation(); settleDebt(tx.id); };

      if (tx.dueDate) clearBtn.classList.remove('hidden');
      else clearBtn.classList.add('hidden');

      const modal = document.getElementById('debt-details-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      lucide.createIcons();
    }

    function refreshDebtDetails(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;

      const remaining = Math.max(0, (tx.amountBase || 0) - (tx.paidAmountBase || 0));
      document.getElementById('debt-details-total').textContent = `${formatMoney(tx.amountBase || 0)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-paid').textContent = `${formatMoney(tx.paidAmountBase || 0)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-remaining').textContent = `${formatMoney(remaining)} ${currencySymbols[state.currency]}`;
      document.getElementById('debt-details-reminder').textContent = tx.dueDate || t('noReminder');

      const clearBtn = document.getElementById('debt-details-clear-reminder');
      if (tx.dueDate) clearBtn.classList.remove('hidden');
      else clearBtn.classList.add('hidden');
    }

    function closeDebtDetails() {
      const modal = document.getElementById('debt-details-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      openDebtDetailsTxId = null;
    }

    // ==========================
    // Stock & partners
    // ==========================
    function renderPartnersAndStock() {
      switchPartnerTab(state.partnerTab || 'stock');
    }

    function switchPartnerTab(tab) {
      state.partnerTab = tab;
      saveState();

      const stockBtn = document.getElementById('tab-stock');
      const partnersBtn = document.getElementById('tab-partners');
      const stockView = document.getElementById('stock-view');
      const partnersView = document.getElementById('partners-view');

      const active = (btn) => {
        btn.style.background = 'var(--surface)';
        btn.style.border = '1px solid var(--border)';
        btn.style.color = 'var(--fg)';
      };
      const inactive = (btn) => {
        btn.style.background = 'transparent';
        btn.style.border = '1px solid transparent';
        btn.style.color = 'var(--muted)';
      };

      if (tab === 'stock') {
        active(stockBtn); inactive(partnersBtn);
        stockView.classList.remove('hidden');
        partnersView.classList.add('hidden');
        renderStock();
      } else {
        active(partnersBtn); inactive(stockBtn);
        partnersView.classList.remove('hidden');
        stockView.classList.add('hidden');
        renderPartners();
      }
      lucide.createIcons();
    }

    function renderStock() {
      const normalizeItemKey = (name) => (name || '').toString().toLowerCase().trim().replace(/\s+/g, ' ');
      const stats = {};
      (state.transactions || []).forEach(t => {
        const raw = (t.item || '').toString().trim();
        const key = normalizeItemKey(raw);
        if (!key) return;
        if (!stats[key]) stats[key] = { key, label: raw || key, inQty: 0, outQty: 0, inAmountBase: 0, outAmountBase: 0, lastAt: 0, txs: [] };

        const q = Number(t.quantity ?? 0) || 0;
        const amt = Number(t.amountBase ?? 0) || 0;

        if (t.type === 'purchase') {
          stats[key].inQty += q;
          stats[key].inAmountBase += amt;
        }
        if (t.type === 'sale') {
          stats[key].outQty += q;
          stats[key].outAmountBase += amt;
        }

        const ts = Number(t.createdAt || 0) || 0;
        if (ts > stats[key].lastAt) stats[key].lastAt = ts;
        if (raw && stats[key].label !== raw && ts >= stats[key].lastAt) stats[key].label = raw;

        stats[key].txs.push(t);
      });

      const qText = (n) => {
        const v = Math.round((Number(n) || 0) * 100) / 100;
        return (Math.abs(v) < 1e-9) ? '0' : String(v);
      };

      const search = (state.stockSearch || '').toString().toLowerCase().trim();
      const sort = (state.stockSort || 'qty-desc').toString();
      const filter = (state.stockFilter || 'all').toString();
      const lowThreshold = Math.max(0, Number(state.stockLowThreshold ?? 3) || 0);

      const allItems = Object.values(stats)
        .map(s => {
          const netQty = (s.inQty || 0) - (s.outQty || 0);
          const inAvgBase = (s.inQty || 0) > 0 ? (s.inAmountBase || 0) / (s.inQty || 1) : 0;
          const outAvgBase = (s.outQty || 0) > 0 ? (s.outAmountBase || 0) / (s.outQty || 1) : 0;
          return {
            key: s.key,
            label: (s.label || s.key || '').toString().trim(),
            inQty: s.inQty || 0,
            outQty: s.outQty || 0,
            netQty,
            lastAt: s.lastAt || 0,
            inAvgBase,
            outAvgBase,
            txs: Array.isArray(s.txs) ? s.txs : []
          };
        })
        .filter(it => (it.inQty > 1e-9) || (it.outQty > 1e-9))
        .filter(it => !search || normalizeItemKey(it.label).includes(search));

      const matchesFilter = (it) => {
        if (filter === 'in') return it.netQty > 1e-9;
        if (filter === 'low') return it.netQty > 1e-9 && it.netQty <= (lowThreshold + 1e-9);
        if (filter === 'out') return Math.abs(it.netQty) <= 1e-9;
        if (filter === 'neg') return it.netQty < -1e-9;
        return true;
      };

      const items = allItems
        .filter(matchesFilter)
        .sort((a, b) => {
          if (sort === 'qty-desc') return (b.netQty - a.netQty) || (b.lastAt - a.lastAt);
          if (sort === 'qty-asc') return (a.netQty - b.netQty) || (b.lastAt - a.lastAt);
          if (sort === 'recent-desc') return (b.lastAt - a.lastAt) || (b.netQty - a.netQty);
          if (sort === 'name-asc') return (a.label || '').localeCompare((b.label || ''), undefined, { sensitivity: 'base' });
          if (sort === 'in-desc') return (b.inQty - a.inQty) || (b.lastAt - a.lastAt);
          if (sort === 'out-desc') return (b.outQty - a.outQty) || (b.lastAt - a.lastAt);
          return (b.netQty - a.netQty) || (b.lastAt - a.lastAt);
        });

      const searchEl = document.getElementById('stock-search');
      if (searchEl && searchEl.value !== (state.stockSearch || '')) searchEl.value = state.stockSearch || '';

      const sortEl = document.getElementById('stock-sort');
      if (sortEl && sortEl.value !== (state.stockSort || 'qty-desc')) sortEl.value = state.stockSort || 'qty-desc';

      const summaryEl = document.getElementById('stock-summary');
      const listEl = document.getElementById('stock-list');
      if (!summaryEl || !listEl) return;

      const searchedItems = allItems;

      const counts = {
        total: searchedItems.length,
        available: searchedItems.filter(it => it.netQty > 1e-9).length,
        low: searchedItems.filter(it => it.netQty > 1e-9 && it.netQty <= (lowThreshold + 1e-9)).length,
        out: searchedItems.filter(it => Math.abs(it.netQty) <= 1e-9).length,
        neg: searchedItems.filter(it => it.netQty < -1e-9).length
      };

      const totalIn = searchedItems.reduce((s, it) => s + (it.inQty || 0), 0);
      const totalOut = searchedItems.reduce((s, it) => s + (it.outQty || 0), 0);

      const card = ({ title, value, sub, icon, accent }) => {
        const a = accent || 'var(--primary)';
        return `
          <div class="card p-4">
            <div class="flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="text-[11px] font-extrabold" style="color: var(--muted);">${escapeHtml(title)}</div>
                <div class="mt-1 text-lg font-black" style="color: ${a};">${escapeHtml(String(value))}</div>
                ${sub ? `<div class="mt-1 text-[11px] font-bold truncate" style="color: var(--muted);">${escapeHtml(sub)}</div>` : ''}
              </div>
              <div class="w-10 h-10 rounded-2xl flex items-center justify-center flex-none" style="background: color-mix(in srgb, ${a} 12%, transparent); border: 1px solid color-mix(in srgb, ${a} 18%, var(--border)); color: ${a};">
                <i data-lucide="${icon}" class="w-5 h-5"></i>
              </div>
            </div>
          </div>
        `;
      };

      summaryEl.innerHTML = `
        <div class="card p-4 col-span-2">
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-xs font-extrabold" style="color: var(--muted);">${escapeHtml(t('stock'))}</div>
              <div class="mt-1 text-[11px] font-bold" style="color: var(--muted);">${escapeHtml(t('stockInShort'))}: ${qText(totalIn)} โข ${escapeHtml(t('stockOutShort'))}: ${qText(totalOut)}</div>
              <div class="mt-1 text-[11px] font-bold" style="color: var(--muted);">${escapeHtml(t('stockItems'))}: ${counts.total} โข ${escapeHtml(t('stockAvailable'))}: ${counts.available} โข ${escapeHtml(t('stockOut'))}: ${counts.out}${counts.neg ? ` โข ${escapeHtml(t('stockNegative'))}: ${counts.neg}` : ''}</div>
            </div>
            <div class="w-12 h-12 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, var(--primary) 12%, transparent); border: 1px solid color-mix(in srgb, var(--primary) 18%, var(--border)); color: var(--primary);">
              <i data-lucide="boxes" class="w-6 h-6"></i>
            </div>
          </div>
        </div>
        ${card({ title: t('stockAvailable'), value: counts.available, sub: lowThreshold > 0 ? `${t('stockLow')}: ${counts.low}` : '', icon: 'package-check', accent: 'var(--success)' })}
        ${card({ title: t('stockOut'), value: counts.out, sub: counts.neg ? `${t('stockNegative')}: ${counts.neg}` : '', icon: 'package-x', accent: counts.neg ? 'var(--warn)' : 'var(--muted)' })}
      `;

      updateStockFilterChips();

      if (items.length === 0) {
        listEl.innerHTML = emptyState('package', state.language === 'english' ? 'No stock data yet.' : state.language === 'french' ? 'Aucune donnรฉe de stock.' : 'ูุง ูุงููุงุด ุจูุงูุงุช ุฏูุงู ุงูุณุชูู ุฏุงุจุง.');
        lucide.createIcons();
        return;
      }

      listEl.innerHTML = items.map(it => {
        const status = it.netQty < -1e-9 ? 'neg' : (Math.abs(it.netQty) <= 1e-9 ? 'out' : (it.netQty <= (lowThreshold + 1e-9) ? 'low' : 'in'));
        const accent = status === 'in' ? 'var(--success)' : status === 'low' ? 'var(--warn)' : status === 'neg' ? 'var(--danger)' : 'var(--muted)';
        const keyLiteral = JSON.stringify(it.key);
        const labelLiteral = JSON.stringify(it.label);
        const expanded = !!(state.stockExpanded && state.stockExpanded[it.key]);

        const lastTxs = [...(it.txs || [])]
          .sort((a, b) => (b.date || '').localeCompare(a.date || '') || (b.createdAt || 0) - (a.createdAt || 0))
          .slice(0, 3);

        const detailsHtml = expanded ? `
          <div class="mt-3 pt-3" style="border-top: 1px dashed var(--border);">
            <div class="grid grid-cols-2 gap-2">
              <div class="rounded-2xl p-3" style="background: var(--surface-2); border: 1px solid var(--border);">
                <div class="text-[11px] font-extrabold" style="color: var(--muted);">${escapeHtml(t('stockInShort'))}</div>
                <div class="mt-1 font-black">${qText(it.inQty)}</div>
                <div class="mt-1 text-[11px] font-bold" style="color: var(--muted);">${escapeHtml(t('avg'))}: ${formatMoney(it.inAvgBase || 0)}</div>
              </div>
              <div class="rounded-2xl p-3" style="background: var(--surface-2); border: 1px solid var(--border);">
                <div class="text-[11px] font-extrabold" style="color: var(--muted);">${escapeHtml(t('stockOutShort'))}</div>
                <div class="mt-1 font-black">${qText(it.outQty)}</div>
                <div class="mt-1 text-[11px] font-bold" style="color: var(--muted);">${escapeHtml(t('avg'))}: ${formatMoney(it.outAvgBase || 0)}</div>
              </div>
            </div>

            <div class="mt-3 flex items-center justify-between gap-2">
              <button class="btn px-3 py-2" style="background: var(--surface-2); border: 1px solid var(--border);" onclick='event.stopPropagation(); openItemHistory(${labelLiteral});'>
                <div class="flex items-center gap-2">
                  <i data-lucide="list" class="w-4 h-4"></i>
                  <span class="text-xs font-black">${escapeHtml(t('stockViewHistory'))}</span>
                </div>
              </button>
              <div class="text-[11px] font-bold" style="color: var(--muted);">${escapeHtml(t('stockLast'))}: ${escapeHtml(lastTxs[0]?.date || 'โ')}</div>
            </div>

            ${lastTxs.length ? `
              <div class="mt-3 space-y-2">
                ${lastTxs.map(tx => {
                  const typeAccent = tx.type === 'sale' ? 'var(--success)' : 'var(--danger)';
                  const typeLabel = tx.type === 'sale' ? t('filterSales') : t('filterPurchases');
                  const txIdLiteral = JSON.stringify(tx.id);
                  return `
                    <div class="rounded-2xl p-3 flex items-center justify-between gap-3 cursor-pointer" style="background: var(--surface-2); border: 1px solid var(--border);" onclick='event.stopPropagation(); openTransactionDetails(${txIdLiteral});'>
                      <div class="min-w-0">
                        <div class="flex items-center gap-2">
                          <span class="px-2 py-0.5 rounded-full text-[11px] font-black" style="background: color-mix(in srgb, ${typeAccent} 12%, transparent); color: ${typeAccent}; border: 1px solid color-mix(in srgb, ${typeAccent} 18%, var(--border));">${escapeHtml(typeLabel)}</span>
                          <div class="text-[11px] font-bold" style="color: var(--muted);">${escapeHtml(tx.date || '')}</div>
                        </div>
                        <div class="mt-1 text-sm font-black truncate">${escapeHtml(tx.item || '')}</div>
                      </div>
                      <div class="flex flex-col items-end flex-none">
                        <div class="text-sm font-black">${qText(tx.quantity ?? 0)}</div>
                        <div class="text-[11px] font-bold" style="color: var(--muted);">${formatMoney(tx.amountBase || 0)}</div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : ''}
          </div>
        ` : '';

        return `
          <div class="card p-4 cursor-pointer" onclick='toggleStockItem(${keyLiteral});'>
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-3 min-w-0">
                <div class="w-10 h-10 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, ${accent} 12%, transparent); border: 1px solid color-mix(in srgb, ${accent} 18%, var(--border)); color: ${accent};">
                  <i data-lucide="package" class="w-5 h-5"></i>
                </div>
                <div class="min-w-0">
                  <div class="font-black truncate">${escapeHtml(it.label)}</div>
                  <div class="text-[11px] font-bold" style="color: var(--muted);">${escapeHtml(t('stockInShort'))}: ${qText(it.inQty)} โข ${escapeHtml(t('stockOutShort'))}: ${qText(it.outQty)}</div>
                </div>
              </div>

              <div class="flex items-center gap-2 flex-none">
                <span class="px-3 py-1 rounded-2xl font-black" style="background: color-mix(in srgb, ${accent} 12%, transparent); border: 1px solid color-mix(in srgb, ${accent} 18%, var(--border)); color: ${accent};" title="${escapeHtml(t('stockNet'))}">
                  ${qText(it.netQty)}
                </span>
                <button class="w-9 h-9 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, var(--success) 14%, transparent); border: 1px solid color-mix(in srgb, var(--success) 18%, var(--border)); color: var(--success);" onclick='event.stopPropagation(); startFlowWithItem("sale", ${labelLiteral});' aria-label="${escapeHtml(t('stockQuickSale'))}">
                  <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                </button>
                <button class="w-9 h-9 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, var(--warn) 14%, transparent); border: 1px solid color-mix(in srgb, var(--warn) 18%, var(--border)); color: var(--warn);" onclick='event.stopPropagation(); startFlowWithItem("purchase", ${labelLiteral});' aria-label="${escapeHtml(t('stockQuickPurchase'))}">
                  <i data-lucide="package-plus" class="w-4 h-4"></i>
                </button>
                <div class="w-9 h-9 rounded-2xl flex items-center justify-center" style="background: var(--surface-2); border: 1px solid var(--border);" aria-label="${expanded ? 'Collapse' : 'Expand'}">
                  <i data-lucide="${expanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4" style="color: var(--muted);"></i>
                </div>
              </div>
            </div>
            ${detailsHtml}
          </div>
        `;
      }).join('');

      lucide.createIcons();
    }

    function updateStockFilterChips() {
      const active = (btn) => {
        btn.style.background = 'var(--surface-2)';
        btn.style.border = '1px solid var(--border)';
        btn.style.color = 'var(--fg)';
      };
      const inactive = (btn) => {
        btn.style.background = 'transparent';
        btn.style.border = '1px solid transparent';
        btn.style.color = 'var(--muted)';
      };

      const map = {
        all: document.getElementById('stock-filter-all'),
        in: document.getElementById('stock-filter-in'),
        low: document.getElementById('stock-filter-low'),
        out: document.getElementById('stock-filter-out'),
        neg: document.getElementById('stock-filter-neg')
      };

      const current = (state.stockFilter || 'all').toString();
      Object.entries(map).forEach(([k, el]) => {
        if (!el) return;
        if (k === current) active(el);
        else inactive(el);
      });
    }

    function setStockSort(value) {
      state.stockSort = (value || '').toString() || 'qty-desc';
      saveState();
      renderStock();
    }

    function setStockFilter(value) {
      state.stockFilter = (value || '').toString() || 'all';
      saveState();
      renderStock();
    }

    function toggleStockItem(key) {
      const k = (key || '').toString();
      if (!state.stockExpanded) state.stockExpanded = {};
      state.stockExpanded[k] = !state.stockExpanded[k];
      saveState();
      renderStock();
    }

    function startFlowWithItem(type, itemName) {
      startFlow(type);
      try {
        const el = document.getElementById('tx-item');
        if (el) el.value = (itemName || '').toString();
        setTimeout(() => {
          const qty = document.getElementById('tx-qty');
          if (qty) qty.focus();
        }, 60);
        recalculatePricing();
      } catch { }
    }

    function openItemHistory(itemName) {
      try {
        showScreen('history-screen');
        const hs = document.getElementById('history-search');
        if (hs) hs.value = (itemName || '').toString();
        renderHistoryFilters('all');
        filterHistory('all', { silentUI: false });
      } catch { }
    }

    function setStockSearch(value) {
      state.stockSearch = (value || '').toString();
      saveState();
      renderStock();
    }

    function normalizePartnerName(name) {
      return (name || '').toString().trim().replace(/\s+/g, ' ').toLowerCase();
    }

    function computeNetProfitBase() {
      const txs = Array.isArray(state.transactions) ? state.transactions : [];
      const totalSales = txs.filter(t => t.type === 'sale').reduce((s, t) => s + (t.amountBase || 0), 0);
      const totalPurchases = txs.filter(t => t.type === 'purchase').reduce((s, t) => s + (t.amountBase || 0), 0);
      return Math.max(0, totalSales - totalPurchases);
    }

    function computePartnerPaidBase(p) {
      const payouts = Array.isArray(p?.payouts) ? p.payouts : [];
      return payouts.reduce((s, pay) => s + (Number(pay?.amountBase) || 0), 0);
    }

    function computePartnerShareBase(p, netProfitBase) {
      const percent = clamp(parseFloat(p?.percent) || 0, 0, 100);
      return (netProfitBase * percent) / 100;
    }

    function computePartnerDueBase(p, netProfitBase) {
      const share = computePartnerShareBase(p, netProfitBase);
      const paid = computePartnerPaidBase(p);
      return Math.max(0, share - paid);
    }

    function setPartnerSearch(value) {
      state.partnerSearch = (value || '').toString();
      saveState();
      renderPartners();
    }

    function setPartnerSort(value) {
      state.partnerSort = (value || '').toString() || 'share-desc';
      saveState();
      renderPartners();
    }

    function togglePartnerAddForm() {
      state.partnerAddOpen = !state.partnerAddOpen;
      saveState();
      renderPartners();
    }

    function setPartnerPercent(value) {
      const el = document.getElementById('partner-percent');
      if (!el) return;
      const v = Number(value);
      if (!isFinite(v)) return;
      el.value = String(Math.round(v * 100) / 100);
    }

    function fillRemainingPartnerPercent() {
      const total = (Array.isArray(state.partners) ? state.partners : []).reduce((s, p) => s + clamp(parseFloat(p?.percent) || 0, 0, 100), 0);
      const remaining = Math.max(0, Math.round((100 - total) * 100) / 100);
      const el = document.getElementById('partner-percent');
      if (el) el.value = String(remaining);
      const hintEl = document.getElementById('partner-add-hint');
      if (hintEl) {
        hintEl.textContent = remaining > 0
          ? (state.language === 'english' ? `Remaining allocation: ${remaining}%` : state.language === 'french' ? `Reste: ${remaining}%` : `ุงูุจุงูู: ${remaining}%`)
          : (state.language === 'english' ? 'Allocation is full (100%).' : state.language === 'french' ? 'Rรฉpartition complรจte (100%).' : 'ุงูุชูุณูู ูุงูู (100%).');
      }
    }

    function renderPartners() {
      const container = document.getElementById('partners-list');
      const summary = document.getElementById('partners-summary');
      if (!container || !summary) return;

      const searchEl = document.getElementById('partners-search');
      if (searchEl) {
        const ph = state.language === 'english' ? 'Search partnersโฆ' : state.language === 'french' ? 'Rechercherโฆ' : 'ุจุญุซ ุจุงูุดุฑููโฆ';
        if (searchEl.placeholder !== ph) searchEl.placeholder = ph;
        if (searchEl.value !== (state.partnerSearch || '')) searchEl.value = state.partnerSearch || '';
      }
      const sortEl = document.getElementById('partners-sort');
      if (sortEl) {
        const opts = [
          { v: 'share-desc', t: state.language === 'english' ? 'Share โ' : state.language === 'french' ? 'Part โ' : 'ุงูุฃุฑุจุงุญ โ' },
          { v: 'due-desc', t: state.language === 'english' ? 'Due โ' : state.language === 'french' ? 'Dรป โ' : 'ุงููุณุชุญู โ' },
          { v: 'percent-desc', t: state.language === 'english' ? 'Percent โ' : state.language === 'french' ? '% โ' : 'ุงููุณุจุฉ โ' },
          { v: 'name-asc', t: state.language === 'english' ? 'Name AโZ' : state.language === 'french' ? 'Nom AโZ' : 'ุงูุงุณู AโZ' },
        ];
        const current = sortEl.value;
        if (sortEl.options.length !== opts.length) {
          sortEl.innerHTML = opts.map(o => `<option value="${o.v}">${escapeHtml(o.t)}</option>`).join('');
        } else {
          for (let i = 0; i < opts.length; i++) {
            if (sortEl.options[i].value !== opts[i].v) sortEl.options[i].value = opts[i].v;
            if (sortEl.options[i].textContent !== opts[i].t) sortEl.options[i].textContent = opts[i].t;
          }
        }
        if (current && Array.from(sortEl.options).some(o => o.value === current)) sortEl.value = current;
        if (sortEl.value !== (state.partnerSort || '')) sortEl.value = state.partnerSort || 'share-desc';
      }

      const addFormEl = document.getElementById('partner-add-form');
      if (addFormEl) {
        if (state.partnerAddOpen) addFormEl.classList.remove('hidden');
        else addFormEl.classList.add('hidden');
      }

      const toggleBtn = document.getElementById('partner-add-toggle');
      if (toggleBtn) {
        const label = toggleBtn.querySelector('span');
        if (label) label.textContent = state.partnerAddOpen ? (state.language === 'english' ? 'Hide' : state.language === 'french' ? 'Masquer' : 'ุฅุฎูุงุก') : (state.language === 'english' ? 'Add' : state.language === 'french' ? 'Ajouter' : 'ุฅุถุงูุฉ');
      }

      const netProfitBase = computeNetProfitBase();
      const partners = Array.isArray(state.partners) ? state.partners : [];

      const totalPercent = partners.reduce((s, p) => s + clamp(parseFloat(p?.percent) || 0, 0, 100), 0);
      const allocated = clamp(totalPercent, 0, 100);
      const over = Math.max(0, Math.round((totalPercent - 100) * 100) / 100);
      const remaining = Math.max(0, Math.round((100 - totalPercent) * 100) / 100);

      const totals = partners.reduce((acc, p) => {
        const invested = Number(p?.investedBase) || 0;
        const paid = computePartnerPaidBase(p);
        const due = computePartnerDueBase(p, netProfitBase);
        return {
          investedBase: acc.investedBase + invested,
          paidBase: acc.paidBase + paid,
          dueBase: acc.dueBase + due,
        };
      }, { investedBase: 0, paidBase: 0, dueBase: 0 });

      const allocationTone = over > 0 ? 'var(--danger)' : (remaining > 0 ? 'var(--warn)' : 'var(--success)');
      const allocationText = over > 0
        ? (state.language === 'english' ? `Over-allocated by ${over}%` : state.language === 'french' ? `Dรฉpassement: ${over}%` : `ุฒุงูุฏ ุจู ${over}%`)
        : (remaining > 0
          ? (state.language === 'english' ? `Remaining: ${remaining}%` : state.language === 'french' ? `Reste: ${remaining}%` : `ุงูุจุงูู: ${remaining}%`)
          : (state.language === 'english' ? 'Allocation complete (100%)' : state.language === 'french' ? 'Rรฉpartition complรจte (100%)' : 'ุงูุชูุณูู ูุงูู (100%)'));

      summary.innerHTML = `
        <div class="flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-xs font-extrabold" style="color: var(--muted);">${escapeHtml(state.language === 'english' ? 'Estimated net profit' : state.language === 'french' ? 'Bรฉnรฉfice estimรฉ' : 'ุงูุฑุจุญ (ุชูุฏูุฑู)')}</div>
            <div class="mt-1 text-2xl font-black" style="color: var(--primary-2);">${formatMoney(netProfitBase)} <span class="text-sm currency-symbol"></span></div>
          </div>
          <div class="w-12 h-12 rounded-2xl flex items-center justify-center" style="background: color-mix(in srgb, var(--primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--primary) 18%, var(--border)); color: var(--primary-2);">
            <i data-lucide="pie-chart" class="w-6 h-6"></i>
          </div>
        </div>

        <div class="mt-4">
          <div class="flex items-center justify-between gap-3">
            <div class="text-[11px] font-extrabold" style="color: var(--muted);">${escapeHtml(state.language === 'english' ? 'Allocation' : state.language === 'french' ? 'Rรฉpartition' : 'ุงูุชูุณูู')}</div>
            <div class="text-[11px] font-black" style="color: ${allocationTone};">${escapeHtml(allocationText)}</div>
          </div>
          <div class="mt-2 h-3 rounded-2xl" style="background: color-mix(in srgb, var(--surface) 70%, transparent); border: 1px solid var(--border); overflow: hidden;">
            <div style="height: 100%; width: ${allocated}%; background: color-mix(in srgb, ${allocationTone} 70%, var(--primary));"></div>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-3 gap-2">
          <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="text-[11px] font-extrabold" style="color: var(--muted);">${escapeHtml(state.language === 'english' ? 'Invested' : state.language === 'french' ? 'Investi' : 'ุงูุงุณุชุซูุงุฑ')}</div>
            <div class="mt-1 text-sm font-black">${formatMoney(totals.investedBase)} <span class="currency-symbol"></span></div>
          </div>
          <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="text-[11px] font-extrabold" style="color: var(--muted);">${escapeHtml(state.language === 'english' ? 'Paid' : state.language === 'french' ? 'Payรฉ' : 'ุงููุคุฏู')}</div>
            <div class="mt-1 text-sm font-black">${formatMoney(totals.paidBase)} <span class="currency-symbol"></span></div>
          </div>
          <div class="p-3 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
            <div class="text-[11px] font-extrabold" style="color: var(--muted);">${escapeHtml(state.language === 'english' ? 'Due' : state.language === 'french' ? 'Dรป' : 'ุงููุณุชุญู')}</div>
            <div class="mt-1 text-sm font-black" style="color: var(--primary-2);">${formatMoney(totals.dueBase)} <span class="currency-symbol"></span></div>
          </div>
        </div>
      `;

      const hintEl = document.getElementById('partner-add-hint');
      if (hintEl) {
        hintEl.textContent = over > 0
          ? (state.language === 'english' ? 'Total % exceeds 100%. Reduce some percentages.' : state.language === 'french' ? 'Le total dรฉpasse 100%. Rรฉduisez les pourcentages.' : 'ุงููุฌููุน ููู 100%ุ ููุต ุงููููุณุจ.')
          : (state.language === 'english' ? `Tip: remaining is ${remaining}%.` : state.language === 'french' ? `Astuce: reste ${remaining}%.` : `ูุตูุญุฉ: ุงูุจุงูู ูู ${remaining}%.`);
      }

      if (!partners.length) {
        container.innerHTML = emptyState('users', state.language === 'english' ? 'Add partners to split profit.' : state.language === 'french' ? 'Ajoutez des partenaires.' : 'ุฒูุฏ ุงูุดุฑูุงุก ุจุงุด ูุชูุณู ุงูุฑุจุญ.');
        applyCurrency();
        lucide.createIcons();
        return;
      }

      const search = normalizePartnerName(state.partnerSearch);
      const enriched = partners.map(p => {
        const percent = clamp(parseFloat(p?.percent) || 0, 0, 100);
        const shareBase = computePartnerShareBase(p, netProfitBase);
        const paidBase = computePartnerPaidBase(p);
        const dueBase = Math.max(0, shareBase - paidBase);
        const investedBase = Number(p?.investedBase) || 0;
        const roiPct = investedBase > 0 ? ((shareBase / investedBase) * 100) : 0;
        return { p, percent, shareBase, paidBase, dueBase, investedBase, roiPct, nameNorm: normalizePartnerName(p?.name) };
      }).filter(x => !search || x.nameNorm.includes(search));

      const sort = (state.partnerSort || 'share-desc').toString();
      enriched.sort((a, b) => {
        if (sort === 'name-asc') return String(a.p?.name || '').localeCompare(String(b.p?.name || ''));
        if (sort === 'percent-desc') return (b.percent - a.percent);
        if (sort === 'due-desc') return (b.dueBase - a.dueBase);
        return (b.shareBase - a.shareBase);
      });

      container.innerHTML = enriched.map(({ p, percent, shareBase, paidBase, dueBase, investedBase, roiPct }) => {
        const safeId = String(p?.id ?? '').replace(/'/g, "\\'");
        const safeName = String(p?.name || '').replace(/'/g, "\\'");
        const roiText = investedBase > 0 ? `${escapeHtml(t('roi'))}: ${new Intl.NumberFormat('en', { maximumFractionDigits: 1 }).format(roiPct)}%` : '';
        const dueBadge = dueBase > 0
          ? `<span class="px-3 py-1 rounded-2xl font-black" style="background: color-mix(in srgb, var(--primary) 10%, transparent); border: 1px solid color-mix(in srgb, var(--primary) 18%, var(--border)); color: var(--primary-2);">${formatMoney(dueBase)} <span class="currency-symbol"></span></span>`
          : `<span class="px-3 py-1 rounded-2xl font-black" style="background: color-mix(in srgb, var(--success) 10%, transparent); border: 1px solid color-mix(in srgb, var(--success) 18%, var(--border)); color: color-mix(in srgb, var(--success) 92%, var(--fg));">${state.language === 'english' ? 'Settled' : state.language === 'french' ? 'Rรฉglรฉ' : 'ููุณููู'}</span>`;

        return `
          <div class="card p-4">
            <div class="flex items-start justify-between gap-3">
              <div class="flex items-start gap-3 min-w-0">
                <div class="w-10 h-10 rounded-2xl flex items-center justify-center" style="background: var(--surface-2); border: 1px solid var(--border); color: var(--muted);">
                  <i data-lucide="user" class="w-5 h-5"></i>
                </div>
                <div class="min-w-0">
                  <div class="flex items-center gap-2">
                    <div class="font-black truncate">${escapeHtml(p?.name || '')}</div>
                    <span class="px-2 py-0.5 rounded-xl text-[11px] font-black" style="background: var(--surface-2); border: 1px solid var(--border); color: var(--muted);">${new Intl.NumberFormat('en', { maximumFractionDigits: 2 }).format(percent)}%</span>
                  </div>
                  <div class="mt-1 text-[11px] font-bold" style="color: var(--muted);">${escapeHtml(state.language === 'english' ? 'Share' : state.language === 'french' ? 'Part' : 'ุงููุตูุจ')}: ${formatMoney(shareBase)} <span class="currency-symbol"></span> โข ${escapeHtml(state.language === 'english' ? 'Paid' : state.language === 'french' ? 'Payรฉ' : 'ุงููุคุฏู')}: ${formatMoney(paidBase)} <span class="currency-symbol"></span></div>
                  ${investedBase > 0 ? `<div class="mt-1 text-[11px] font-bold" style="color: var(--muted);">${escapeHtml(t('invested'))}: ${formatMoney(investedBase)} <span class="currency-symbol"></span>${roiText ? ` โข ${roiText}` : ''}</div>` : ''}
                </div>
              </div>
              <div class="flex flex-col items-end gap-2">
                ${dueBadge}
              </div>
            </div>

            <div class="mt-3 flex items-center justify-end gap-2">
              <button onclick="openPartnerDetails('${safeId}', '${safeName}')" class="btn px-4 py-2 rounded-2xl" style="background: var(--surface-2); border: 1px solid var(--border);">
                <div class="flex items-center gap-2" style="color: var(--fg);">
                  <i data-lucide="info" class="w-4 h-4"></i>
                  <span class="text-xs font-black">${state.language === 'english' ? 'Details' : state.language === 'french' ? 'Dรฉtails' : 'ุชูุงุตูู'}</span>
                </div>
              </button>
              ${dueBase > 0 ? `
                <button onclick="prefillPartnerDuePayout('${safeId}', '${safeName}')" class="btn px-4 py-2 rounded-2xl" style="background: linear-gradient(135deg, var(--primary), var(--primary-2)); color: white;">
                  <div class="flex items-center gap-2">
                    <i data-lucide="banknote" class="w-4 h-4"></i>
                    <span class="text-xs font-black">${state.language === 'english' ? 'Pay due' : state.language === 'french' ? 'Payer' : 'ุฏูุน'}</span>
                  </div>
                </button>
              ` : ''}
              <button onclick="removePartnerById('${safeId}', '${safeName}')" class="btn px-4 py-2 rounded-2xl" style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border));">
                <div class="flex items-center gap-2" style="color: color-mix(in srgb, var(--danger) 88%, var(--fg));">
                  <i data-lucide="trash" class="w-4 h-4"></i>
                  <span class="text-xs font-black">${state.language === 'english' ? 'Remove' : state.language === 'french' ? 'Supprimer' : 'ุญุฐู'}</span>
                </div>
              </button>
            </div>
          </div>
        `;
      }).join('');

      applyCurrency();
      lucide.createIcons();
    }

    function addPartner() {
      const name = (document.getElementById('partner-name').value || '').trim();
      const percent = parseFloat(document.getElementById('partner-percent').value);
      const investedSelected = parseFloat(document.getElementById('partner-invested')?.value || '') || 0;
      const investedAt = (document.getElementById('partner-invested-at')?.value || '').trim();
      if (!name) {
        showToast(state.language === 'english' ? 'Enter a name' : state.language === 'french' ? 'Entrez un nom' : 'ูุชุจ ุงูุงุณู', 'error');
        return;
      }
      if (!isFinite(percent) || percent <= 0) {
        showToast(state.language === 'english' ? 'Enter a valid %' : state.language === 'french' ? 'Entrez un % valide' : 'ุฏุฎู ูุณุจุฉ ุตุญูุญุฉ', 'error');
        return;
      }

      const normalized = normalizePartnerName(name);
      const exists = (Array.isArray(state.partners) ? state.partners : []).some(p => normalizePartnerName(p?.name) === normalized);
      if (exists) {
        showToast(state.language === 'english' ? 'Partner already exists' : state.language === 'french' ? 'Partenaire dรฉjร existant' : 'ูุงูู ุดุฑูู ุจูุงุฏ ุงูุงุณู', 'error');
        return;
      }

      const totalPercent = (Array.isArray(state.partners) ? state.partners : []).reduce((s, p) => s + clamp(parseFloat(p?.percent) || 0, 0, 100), 0);
      const nextTotal = totalPercent + clamp(percent, 0, 100);
      if (nextTotal > 100.0001) {
        showToast(state.language === 'english' ? 'Total % cannot exceed 100' : state.language === 'french' ? 'Le total ne peut pas dรฉpasser 100%' : 'ุงููุฌููุน ูุง ุฎุงุตูุด ูููุช 100%', 'error');
        return;
      }
      const newP = {
        id: Date.now(),
        name,
        percent: clamp(percent, 0, 100),
        investedBase: investedSelected > 0 ? baseFromCurrentCurrency(investedSelected) : 0,
        investedAt,
        profitSchedule: '',
        notes: '',
        payouts: [],
        createdAt: Date.now()
      };
      state.partners.push(newP);
      touchLocalChange();
      saveState();
      if (window.isNativeApp) API.savePartner(newP);
      document.getElementById('partner-name').value = '';
      document.getElementById('partner-percent').value = '';
      const inv = document.getElementById('partner-invested');
      if (inv) inv.value = '';
      const invAt = document.getElementById('partner-invested-at');
      if (invAt) invAt.value = '';
      state.partnerAddOpen = false;
      saveState();
      renderPartners();
      showToast(state.language === 'english' ? 'Partner added' : state.language === 'french' ? 'Partenaire ajoutรฉ' : 'ุชุฒุงุฏ ุงูุดุฑูู', 'success');
    }

    function removePartner(name) {
      const p = state.partners.find(p => p.name === name);
      if (p && p.id && window.isNativeApp) API.deletePartner(p.id);
      state.partners = state.partners.filter(p => p.name !== name);
      touchLocalChange();
      saveState();
      renderPartners();
    }

    function removePartnerById(id, name) {
      const rawId = String(id || '').trim();
      const p = rawId ? state.partners.find(pp => String(pp.id) === rawId) : state.partners.find(pp => pp.name === name);
      if (p && p.id && window.isNativeApp) API.deletePartner(p.id);
      if (rawId) state.partners = state.partners.filter(pp => String(pp.id) !== rawId);
      else state.partners = state.partners.filter(pp => pp.name !== name);
      touchLocalChange();
      saveState();
      renderPartners();
    }

    let openPartnerDetailsId = null;

    function getPartnerByOpenId(id, name) {
      const rawId = String(id || '').trim();
      if (rawId) {
        const byId = state.partners.find(p => String(p.id) === rawId);
        if (byId) return byId;
      }
      return state.partners.find(p => p.name === name) || null;
    }

    function openPartnerDetails(id, name) {
      const p = getPartnerByOpenId(id, name);
      if (!p) return;
      openPartnerDetailsId = String(p.id);

      const modal = document.getElementById('partner-details-modal');
      if (!modal) return;

      const title = document.getElementById('partner-details-name');
      if (title) title.textContent = p.name || '';

      const scheduleEl = document.getElementById('partner-details-schedule');
      if (scheduleEl) scheduleEl.value = (p.profitSchedule || '').toString();

      const notesEl = document.getElementById('partner-details-notes');
      if (notesEl) notesEl.value = (p.notes || '').toString();

      const nameEl = document.getElementById('partner-details-name-input');
      if (nameEl) nameEl.value = (p.name || '').toString();
      const percentEl = document.getElementById('partner-details-percent-input');
      if (percentEl) percentEl.value = String(clamp(parseFloat(p.percent) || 0, 0, 100));
      const investedEl = document.getElementById('partner-details-invested-input');
      if (investedEl) {
        const raw = currentFromBase(Number(p.investedBase) || 0);
        investedEl.value = raw > 0 ? String(Math.round(raw * 100) / 100) : '';
      }
      const investedAtEl = document.getElementById('partner-details-invested-at-input');
      if (investedAtEl) investedAtEl.value = (p.investedAt || '').toString();
      const msgEl = document.getElementById('partner-details-core-msg');
      if (msgEl) msgEl.textContent = '';

      const amtEl = document.getElementById('partner-payout-amount');
      if (amtEl) amtEl.value = '';
      const dateEl = document.getElementById('partner-payout-date');
      if (dateEl) dateEl.value = new Date().toISOString().slice(0, 10);

      modal.classList.remove('hidden');
      modal.classList.add('flex');

      renderPartnerDetails();
      try { lucide.createIcons(); } catch { }
    }

    function savePartnerDetailsCore() {
      if (!openPartnerDetailsId) return;
      const idx = state.partners.findIndex(p => String(p.id) === String(openPartnerDetailsId));
      if (idx < 0) return;

      const msgEl = document.getElementById('partner-details-core-msg');
      const setMsg = (text, tone) => {
        if (!msgEl) return;
        msgEl.textContent = text || '';
        msgEl.style.color = tone || 'var(--muted)';
      };

      const nameRaw = (document.getElementById('partner-details-name-input')?.value || '').trim();
      const percentRaw = parseFloat(document.getElementById('partner-details-percent-input')?.value || '');
      const investedSelected = parseFloat(document.getElementById('partner-details-invested-input')?.value || '') || 0;
      const investedAt = (document.getElementById('partner-details-invested-at-input')?.value || '').trim();

      if (!nameRaw) {
        setMsg(state.language === 'english' ? 'Name is required.' : state.language === 'french' ? 'Nom requis.' : 'ุงูุงุณู ุถุฑูุฑู.', 'var(--danger)');
        return;
      }
      if (!isFinite(percentRaw) || percentRaw <= 0) {
        setMsg(state.language === 'english' ? 'Enter a valid %.' : state.language === 'french' ? 'Entrez un % valide.' : 'ุฏุฎู ูุณุจุฉ ุตุญูุญุฉ.', 'var(--danger)');
        return;
      }

      const normalized = normalizePartnerName(nameRaw);
      const duplicate = state.partners.some((p, i) => i !== idx && normalizePartnerName(p?.name) === normalized);
      if (duplicate) {
        setMsg(state.language === 'english' ? 'Another partner has the same name.' : state.language === 'french' ? 'Un autre partenaire a le mรชme nom.' : 'ูุงูู ุดุฑูู ุขุฎุฑ ุจููุณ ุงูุงุณู.', 'var(--danger)');
        return;
      }

      const currentTotalMinusThis = state.partners.reduce((s, p, i) => {
        if (i === idx) return s;
        return s + clamp(parseFloat(p?.percent) || 0, 0, 100);
      }, 0);

      const nextPercent = clamp(percentRaw, 0, 100);
      const nextTotal = currentTotalMinusThis + nextPercent;
      if (nextTotal > 100.0001) {
        setMsg(state.language === 'english' ? 'Total % cannot exceed 100.' : state.language === 'french' ? 'Le total ne peut pas dรฉpasser 100%.' : 'ุงููุฌููุน ูุง ุฎุงุตูุด ูููุช 100%.', 'var(--danger)');
        return;
      }

      const prev = state.partners[idx];
      const next = {
        ...prev,
        name: nameRaw,
        percent: nextPercent,
        investedBase: investedSelected > 0 ? baseFromCurrentCurrency(investedSelected) : 0,
        investedAt,
      };
      state.partners[idx] = next;
      touchLocalChange();
      saveState();
      if (window.isNativeApp) API.savePartner(next);
      renderPartnerDetails();
      renderPartners();
      setMsg(state.language === 'english' ? 'Saved.' : state.language === 'french' ? 'Enregistrรฉ.' : 'ุชุญูุธ.', 'var(--success)');
      showToast(t('saved') || 'Saved', 'success');
      try { lucide.createIcons(); } catch { }
    }

    function prefillPartnerDuePayout(id, name) {
      openPartnerDetails(id, name);
      setTimeout(() => {
        const p = getPartnerByOpenId(id, name);
        if (!p) return;
        const dueBase = computePartnerDueBase(p, computeNetProfitBase());
        const amtEl = document.getElementById('partner-payout-amount');
        if (amtEl) {
          const selected = Math.round(currentFromBase(dueBase) * 100) / 100;
          amtEl.value = selected > 0 ? String(selected) : '';
          amtEl.focus();
        }
      }, 60);
    }

    function closePartnerDetails() {
      const modal = document.getElementById('partner-details-modal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      openPartnerDetailsId = null;
    }

    function savePartnerDetailsMeta() {
      if (!openPartnerDetailsId) return;
      const idx = state.partners.findIndex(p => String(p.id) === String(openPartnerDetailsId));
      if (idx < 0) return;
      const scheduleEl = document.getElementById('partner-details-schedule');
      const notesEl = document.getElementById('partner-details-notes');
      const next = {
        ...state.partners[idx],
        profitSchedule: (scheduleEl?.value || '').toString(),
        notes: (notesEl?.value || '').toString(),
      };
      state.partners[idx] = next;
      touchLocalChange();
      saveState();
      if (window.isNativeApp) API.savePartner(next);
    }

    function renderPartnerDetails() {
      if (!openPartnerDetailsId) return;
      const p = state.partners.find(pp => String(pp.id) === String(openPartnerDetailsId));
      if (!p) return;

      const totalSales = state.transactions.filter(t => t.type === 'sale').reduce((s, t) => s + (t.amountBase || 0), 0);
      const totalPurchases = state.transactions.filter(t => t.type === 'purchase').reduce((s, t) => s + (t.amountBase || 0), 0);
      const netProfit = Math.max(0, totalSales - totalPurchases);
      const percent = clamp(parseFloat(p.percent) || 0, 0, 100);
      const share = (netProfit * percent) / 100;

      const payouts = Array.isArray(p.payouts) ? p.payouts : [];
      const paid = payouts.reduce((s, pay) => s + (Number(pay?.amountBase) || 0), 0);
      const due = Math.max(0, share - paid);

      const shareEl = document.getElementById('partner-details-share');
      const dueEl = document.getElementById('partner-details-due');
      const paidEl = document.getElementById('partner-details-paid');
      if (shareEl) shareEl.innerHTML = `${formatMoney(share)} <span class="currency-symbol"></span> (${percent}%)`;
      if (paidEl) paidEl.innerHTML = `${t('amountPaid') || 'Paid'}: ${formatMoney(paid)} <span class="currency-symbol"></span>`;
      if (dueEl) dueEl.innerHTML = `${formatMoney(due)} <span class="currency-symbol"></span>`;

      const listEl = document.getElementById('partner-payouts-list');
      if (!listEl) return;
      if (!payouts.length) {
        listEl.innerHTML = `<div class="text-xs font-bold" style="color: var(--muted);">${state.language === 'english' ? 'No payouts yet.' : state.language === 'french' ? 'Aucun paiement.' : 'ูุงุฒุงู ูุง ูุงููุงุด ุฏูุนุงุช.'}</div>`;
        applyCurrency();
        return;
      }

      const sorted = [...payouts].sort((a, b) => String(b?.date || '').localeCompare(String(a?.date || '')));
      listEl.innerHTML = sorted.map(pay => {
        const pid = String(pay?.id || '');
        const date = String(pay?.date || '');
        const amt = Number(pay?.amountBase) || 0;
        return `
          <div class="flex items-center justify-between gap-3 p-3 rounded-2xl" style="background: var(--surface); border: 1px solid var(--border);">
            <div class="min-w-0">
              <div class="text-xs font-extrabold" style="color: var(--muted);">${escapeHtml(date || '-') }</div>
              <div class="text-sm font-black">${formatMoney(amt)} <span class="currency-symbol"></span></div>
            </div>
            <button onclick="removePartnerPayout('${pid.replace(/'/g, "\\'")}')" class="w-10 h-10 rounded-2xl flex items-center justify-center"
              style="background: color-mix(in srgb, var(--danger) 10%, var(--surface)); border: 1px solid color-mix(in srgb, var(--danger) 18%, var(--border)); color: color-mix(in srgb, var(--danger) 88%, var(--fg));">
              <i data-lucide="trash" class="w-4 h-4"></i>
            </button>
          </div>
        `;
      }).join('');

      applyCurrency();
    }

    function addPartnerPayout() {
      if (!openPartnerDetailsId) return;
      const idx = state.partners.findIndex(p => String(p.id) === String(openPartnerDetailsId));
      if (idx < 0) return;

      const amtSelected = parseFloat(document.getElementById('partner-payout-amount')?.value || '') || 0;
      const date = (document.getElementById('partner-payout-date')?.value || '').trim();
      if (!amtSelected || amtSelected <= 0 || !date) {
        showToast(t('paymentAmountRequired') || 'Enter amount', 'error');
        return;
      }
      const amountBase = baseFromCurrentCurrency(amtSelected);
      const p = state.partners[idx];
      const payouts = Array.isArray(p.payouts) ? [...p.payouts] : [];
      payouts.push({ id: Date.now().toString(), date, amountBase });
      const next = { ...p, payouts };
      state.partners[idx] = next;
      touchLocalChange();
      saveState();
      if (window.isNativeApp) API.savePartner(next);

      const amtEl = document.getElementById('partner-payout-amount');
      if (amtEl) amtEl.value = '';
      renderPartnerDetails();
      renderPartners();
      showToast(t('saved') || 'Saved', 'success');
      try { lucide.createIcons(); } catch { }
    }

    function addPartnerPayoutDue() {
      if (!openPartnerDetailsId) return;
      const p = state.partners.find(pp => String(pp.id) === String(openPartnerDetailsId));
      if (!p) return;
      const dueBase = computePartnerDueBase(p, computeNetProfitBase());
      if (!dueBase || dueBase <= 0) {
        showToast(state.language === 'english' ? 'Nothing due.' : state.language === 'french' ? 'Rien ร payer.' : 'ูุง ูุงููุด ูุณุชุญู.', 'info');
        return;
      }
      const amtEl = document.getElementById('partner-payout-amount');
      const dateEl = document.getElementById('partner-payout-date');
      if (dateEl && !dateEl.value) dateEl.value = new Date().toISOString().slice(0, 10);
      if (amtEl) {
        const selected = Math.round(currentFromBase(dueBase) * 100) / 100;
        amtEl.value = String(selected);
      }
      addPartnerPayout();
    }

    function removePartnerPayout(paymentId) {
      if (!openPartnerDetailsId) return;
      const idx = state.partners.findIndex(p => String(p.id) === String(openPartnerDetailsId));
      if (idx < 0) return;
      const p = state.partners[idx];
      const payouts = Array.isArray(p.payouts) ? p.payouts.filter(pp => String(pp?.id) !== String(paymentId)) : [];
      const next = { ...p, payouts };
      state.partners[idx] = next;
      touchLocalChange();
      saveState();
      if (window.isNativeApp) API.savePartner(next);
      renderPartnerDetails();
      renderPartners();
      try { lucide.createIcons(); } catch { }
    }

    // ==========================
    // Export / Import / Clear
    // ==========================
    async function exportData() {
      const timestamp = new Date().toISOString().split('T')[0];
      const fileName = `tijarati_backup_${timestamp}.json`;
      const content = JSON.stringify(state, null, 2);

      const result = await API.saveFile(fileName, content);
      if (result && result.success) {
        showToast(t('saved') || 'Exported', 'success');
      } else {
        showToast('Failed to export', 'error');
      }
    }

    async function syncFromNative() {
      if (!window.isNativeApp) return;
      try {
        const txs = await API.getTransactions();
        if (txs && Array.isArray(txs)) {
          state.transactions = txs.map(tx => {
            const next = { ...(tx || {}) };
            if (next.amountBase === undefined) next.amountBase = Number(next.amount ?? 0);
            if (next.paidAmountBase === undefined) next.paidAmountBase = Number(next.paidAmount ?? 0);
            if (typeof next.installments === 'string') {
              try {
                const parsed = JSON.parse(next.installments);
                next.installments = Array.isArray(parsed) ? parsed : [];
              } catch {
                next.installments = [];
              }
            }
            return next;
          });
        }
        const parts = await API.getPartners();
        if (parts && Array.isArray(parts)) {
          state.partners = parts.map(p => {
            const next = { ...(p || {}) };
            if (typeof next.payouts === 'string') {
              try {
                const parsed = JSON.parse(next.payouts);
                next.payouts = Array.isArray(parsed) ? parsed : [];
              } catch {
                next.payouts = [];
              }
            }
            if (!Array.isArray(next.payouts)) next.payouts = [];
            if (next.profitSchedule === undefined || next.profitSchedule === null) next.profitSchedule = '';
            if (next.notes === undefined || next.notes === null) next.notes = '';
            return next;
          });
        }
        saveState();
      } catch { }
    }

    function toggleMockData() {
      if (!window.isNativeApp) {
        showToast(t('mockNotAvailable'), 'info');
        return;
      }

      const nextEnabled = !state.mockDataEnabled;
      openConfirm({
        title: nextEnabled ? t('enableMockData') : t('disableMockData'),
        message: nextEnabled ? t('mockEnableConfirm') : t('mockDisableConfirm'),
        confirmText: nextEnabled ? t('enableMockData') : t('disableMockData'),
        danger: !nextEnabled,
        onConfirm: async () => {
          try {
            showBlockingOverlay(nextEnabled ? t('enableMockData') : t('disableMockData'), '');
            const res = await API.setMockData(nextEnabled);
            if (res && res.success === false) throw new Error(res.error || 'Failed');

            state.mockDataEnabled = nextEnabled;
            await syncFromNative();
            renderAll();
            updateMockDataButton();
            showToast(nextEnabled ? t('mockAdded') : t('mockRemoved'), 'success');
          } catch (err) {
            showToast(String(err?.message || err || 'Failed'), 'error');
          } finally {
            try { hideBlockingOverlay(); } catch { }
          }
        }
      });
    }

    async function importData(event) {
      let content = null;

      if (window.isNativeApp) {
        const result = await API.pickFile();
        if (result && result.success && result.content) {
          content = result.content;
        } else {
          return;
        }
      } else {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          processImport(String(reader.result || '{}'), event);
        };
        reader.readAsText(file);
        return;
      }

      processImport(content, event);
    }

    function processImport(content, event) {
      try {
        const incoming = JSON.parse(content);
        state = {
          ...state,
          ...incoming,
          transactions: Array.isArray(incoming.transactions) ? incoming.transactions : state.transactions,
          partners: Array.isArray(incoming.partners) ? incoming.partners : state.partners
        };
        touchLocalChange();
        saveState();
        applyTheme();
        applyLanguage();
        applyCurrency();
        renderAll();
        showToast('Imported', 'success');
      } catch {
        showToast('Invalid file', 'error');
      } finally {
        if (event && event.target) event.target.value = '';
      }
    }

    // ==========================
    // Clear data (with UX)
    // ==========================
    let blockingOverlayEl = null;

    function ensureBlockingOverlay() {
      if (blockingOverlayEl) return blockingOverlayEl;

      const el = document.createElement('div');
      el.id = 'blocking-overlay';
      el.className = 'fixed inset-0 hidden items-center justify-center p-5';
      el.style.cssText = 'z-index: 9999; background: rgba(0,0,0,0.55); backdrop-filter: blur(12px);';

      el.innerHTML = `
        <div class="card p-6 w-full max-w-sm animate-pop" style="border-radius: 26px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
          <div class="flex items-center gap-3">
            <div id="blocking-overlay-icon" class="w-12 h-12 rounded-2xl flex items-center justify-center flex-shrink-0" style="background: var(--surface-2); border: 1px solid var(--border); color: var(--primary-2);">
              <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" opacity="0.25" />
                <path d="M22 12a10 10 0 0 1-10 10" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
              </svg>
            </div>
            <div class="min-w-0 flex-1">
              <div class="text-base font-black" id="blocking-overlay-title">${escapeHtml(t('clearingData'))}</div>
              <div class="mt-1 text-xs font-bold" style="color: var(--muted);" id="blocking-overlay-sub">${escapeHtml(t('deleteWarning'))}</div>
            </div>
          </div>
        </div>
      `;

      // Simple spinner animation
      try {
        const style = document.createElement('style');
        style.textContent = `
          @keyframes tijarati-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
          #blocking-overlay-icon svg { animation: tijarati-spin 0.85s linear infinite; }
          #blocking-overlay.flex { display: flex !important; }
        `;
        document.head.appendChild(style);
      } catch { }

      document.body.appendChild(el);
      blockingOverlayEl = el;
      return el;
    }

    function showBlockingOverlay(title, subText) {
      const el = ensureBlockingOverlay();
      const titleEl = document.getElementById('blocking-overlay-title');
      const subEl = document.getElementById('blocking-overlay-sub');
      if (titleEl) titleEl.textContent = title || t('clearingData');
      if (subEl) subEl.textContent = subText || '';
      el.classList.remove('hidden');
      el.classList.add('flex');
    }

    function hideBlockingOverlay() {
      const el = ensureBlockingOverlay();
      el.classList.add('hidden');
      el.classList.remove('flex');
    }

    function setBlockingOverlayDone(title) {
      ensureBlockingOverlay();
      const titleEl = document.getElementById('blocking-overlay-title');
      const iconWrap = document.getElementById('blocking-overlay-icon');
      if (titleEl) titleEl.textContent = title || t('clearedDone');
      if (iconWrap) {
        iconWrap.style.color = 'var(--success)';
        iconWrap.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5"></i>';
        lucide.createIcons();
      }
    }

    function setBlockingOverlayError(title) {
      ensureBlockingOverlay();
      const titleEl = document.getElementById('blocking-overlay-title');
      const iconWrap = document.getElementById('blocking-overlay-icon');
      if (titleEl) titleEl.textContent = title || t('clearFailed');
      if (iconWrap) {
        iconWrap.style.color = 'var(--danger)';
        iconWrap.innerHTML = '<i data-lucide="alert-circle" class="w-5 h-5"></i>';
        lucide.createIcons();
      }
    }

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    async function withTimeout(promise, ms) {
      let timer;
      const timeoutPromise = new Promise((_, reject) => {
        timer = setTimeout(() => reject(new Error('timeout')), ms);
      });
      try {
        return await Promise.race([promise, timeoutPromise]);
      } finally {
        clearTimeout(timer);
      }
    }

    function clearAllLocalTijaratiKeys() {
      // Clear current + legacy keys to make web + native WebView consistent.
      try {
        for (let i = localStorage.length - 1; i >= 0; i--) {
          const k = localStorage.key(i);
          if (!k) continue;
          if (k.startsWith('tijarati')) localStorage.removeItem(k);
        }
      } catch {
        try { localStorage.removeItem(STORAGE_KEY); } catch { }
        try { localStorage.removeItem('tijarati_v2'); } catch { }
      }
    }

    async function clearAllData() {
      console.log('๐ด clearAllData CALLED');
      
      try {
        const startedAt = Date.now();
        const MIN_SPINNER_MS = 900;
        const DONE_VISIBLE_MS = 1000;

        // 1. Immediately reset in-memory state so UI shows empty
        console.log('๐ด Step 1: Resetting state...');
        console.log('๐ด Before reset - transactions:', state.transactions.length, 'partners:', state.partners.length);
        state.transactions = [];
        state.partners = [];
        state.currentFlow = null;
        state.paymentType = 'paid';
        try { touchLocalChange(); } catch { }
        console.log('๐ด After reset - transactions:', state.transactions.length, 'partners:', state.partners.length);

        // 2. Re-render UI to show empty state (removes old elements from DOM)
        console.log('๐ด Step 2: Calling renderAll()...');
        renderAll();
        lucide.createIcons();
        console.log('๐ด renderAll() completed');

        // 3. Show loading overlay and give the browser a moment to paint it
        console.log('๐ด Step 3: Showing blocking overlay...');
        showBlockingOverlay(t('clearingData'), '');
        try {
          await new Promise((resolve) => requestAnimationFrame(() => resolve()));
        } catch {
          await sleep(50);
        }
        await sleep(150);
        console.log('๐ด Overlay should be visible now');

        // 4. Clear native data
        let nativeOk = true;
        console.log('๐ด Step 5: Checking if native app...', window.isNativeApp);
        if (window.isNativeApp) {
          try {
            console.log('๐ด Calling API.clearAllData()...');
            const res = await withTimeout(API.clearAllData(), 5000);
            console.log('๐ด API.clearAllData() response:', res);
            if (res && res.success === false) nativeOk = false;
          } catch (err) {
            console.log('๐ด API.clearAllData() ERROR:', err);
            nativeOk = false;
          }
        }

        // 5. Clear all localStorage keys
        console.log('๐ด Step 6: Clearing localStorage...');
        clearAllLocalTijaratiKeys();
        console.log('๐ด localStorage cleared');

        // Ensure the spinner is visible long enough (otherwise it flips to Done too fast to notice)
        const elapsed = Date.now() - startedAt;
        if (elapsed < MIN_SPINNER_MS) {
          console.log('๐ด Waiting extra for spinner visibility:', MIN_SPINNER_MS - elapsed);
          await sleep(MIN_SPINNER_MS - elapsed);
        }

        // 6. Show completion state
        console.log('๐ด Step 7: Showing completion state, nativeOk:', nativeOk);
        if (nativeOk) setBlockingOverlayDone(t('clearedDone'));
        else setBlockingOverlayError(t('clearFailed'));
        console.log('๐ด Completion state shown');

        // 7. Keep the result visible, then refresh UI.
        // On native WebView, location.reload can be flaky and may leave the overlay stuck.
        console.log('๐ด Step 8: Sleeping before finishing...');
        await sleep(DONE_VISIBLE_MS);
        if (window.isNativeApp) {
          console.log('๐ด Step 9: Native app - hiding overlay and re-rendering');
          hideBlockingOverlay();
          renderAll();
          lucide.createIcons();
        } else {
          console.log('๐ด Step 9: Web - reloading page');
          location.reload();
        }
      } catch (err) {
        console.error('๐ด๐ด๐ด clearAllData ERROR:', err);
        alert('ERROR in clearAllData: ' + err.message);
      }
    }

    // ==========================
    // Confirm modal
    // ==========================
    let confirmAction = null;

    function openConfirm({ title, message, confirmText, danger, onConfirm }) {
      confirmAction = onConfirm || null;
      document.getElementById('confirm-title').textContent = title || t('confirmTitle');
      document.getElementById('confirm-message').textContent = message || '';
      const actionBtn = document.getElementById('confirm-action');
      actionBtn.textContent = confirmText || t('confirmAction');
      actionBtn.style.background = danger
        ? 'linear-gradient(135deg, var(--danger), color-mix(in srgb, var(--danger) 70%, #7f1d1d))'
        : 'linear-gradient(135deg, var(--primary), var(--primary-2))';
      actionBtn.onclick = () => {
        const action = confirmAction;
        console.log('๐ต Confirm button clicked!');
        console.log('๐ต confirmAction:', action);
        closeConfirm();
        if (action) {
          console.log('๐ต Calling confirmAction...');
          action();
        } else {
          console.log('๐ต No confirmAction set!');
        }
      };

      const modal = document.getElementById('confirm-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      lucide.createIcons();
    }

    function closeConfirm() {
      const modal = document.getElementById('confirm-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      confirmAction = null;
    }

    // ==========================
    // Delete transaction
    // ==========================
    function deleteTransaction(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;
      openConfirm({
        title: t('deleteTransactionTitle'),
        message: `${tx.item} โข ${tx.date}`,
        confirmText: t('delete'),
        danger: true,
        onConfirm: async () => {
          // Cancel reminder if it exists
          if (tx.reminderId && window.isNativeApp) {
            try { await API.cancelDebtReminder(tx.reminderId); } catch { }
          }
          if (window.isNativeApp) API.deleteTransaction(id);
          state.transactions = state.transactions.filter(t => t.id !== id);
          touchLocalChange();
          saveState();
          renderAll();
          showToast(t('deleted'), 'info');
        }
      });
    }

    // ==========================
    // Sharing
    // ==========================
    async function shareTransaction(id) {
      const tx = state.transactions.find(t => t.id === id);
      if (!tx) return;

      await shareReceipt(tx);
    }

    // ==========================
    // Toast
    // ==========================
    let toastTimer = null;

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const msg = document.getElementById('toast-message');
      const icon = document.getElementById('toast-icon');

      msg.textContent = message;
      const iconName = type === 'error' ? 'alert-circle' : type === 'info' ? 'info' : 'check-circle';
      const iconColor = type === 'error' ? 'var(--danger)' : type === 'info' ? 'var(--warn)' : 'var(--success)';
      icon.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5"></i>`;
      icon.style.color = iconColor;
      lucide.createIcons();

      toast.classList.remove('opacity-0', '-translate-y-6');
      toast.classList.add('opacity-100', 'translate-y-0');

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        toast.classList.add('opacity-0', '-translate-y-6');
        toast.classList.remove('opacity-100', 'translate-y-0');
      }, 2800);
    }

    // ==========================
    // Date header
    // ==========================
    function updateDateHeader() {
      const options = { weekday: 'long', day: 'numeric', month: 'long' };
      const locale = state.language === 'english' ? 'en' : (state.language === 'french' ? 'fr' : 'ar-MA');
      const el = document.getElementById('current-date-header');
      if (el) el.textContent = new Date().toLocaleDateString(locale, options);
    }

    // ==========================
    // Render all
    // ==========================
    function renderAll() {
      updateDashboard();
      renderHistoryFilters(state.historyFilter || 'all');
      // only render heavy screens if active
      const active = document.querySelector('.screen.active')?.id;
      if (active === 'history-screen') renderHistory();
      if (active === 'debts-screen') renderDebts();
      if (active === 'partners-screen') renderPartnersAndStock();
      applyCurrency();
      lucide.createIcons();
    }

    // ==========================
    // Security
    // ==========================
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // ==========================
    // Init
    // ==========================
    async function init() {
      loadState();

      if (window.isNativeApp) {
        API.init();
        try {
          const txs = await API.getTransactions();
          if (txs && Array.isArray(txs)) {
            state.transactions = txs;
          }
          const parts = await API.getPartners();
          if (parts && Array.isArray(parts)) {
            state.partners = parts;
          }
          saveState();
          renderAll();
        } catch (e) {
          // ignore sync errors
        }
      }

      // Theme
      applyTheme();
      document.getElementById('theme-toggle').addEventListener('click', cycleTheme);
      if (window.matchMedia) {
        const mql = window.matchMedia('(prefers-color-scheme: dark)');
        const onChange = () => { if (state.theme === 'system') applyTheme(); };
        // Older Android WebView supports addListener/removeListener, not addEventListener.
        if (mql && typeof mql.addEventListener === 'function') mql.addEventListener('change', onChange);
        else if (mql && typeof mql.addListener === 'function') mql.addListener(onChange);
      }

      // i18n + currency
      applyLanguage();
      applyCurrency();

      // settings button state
      updateMockDataButton();

      // filters
      renderHistoryFilters(state.historyFilter || 'all');

      // bind transaction preview
      bindTxInputs();

      // bind debt reminder picker
      const picker = document.getElementById('debt-reminder-picker');
      if (picker) {
        picker.addEventListener('change', async () => {
          if (!pendingReminderTxId) return;
          const txId = pendingReminderTxId;
          pendingReminderTxId = null;
          const value = picker.value;
          picker.value = '';
          await setDebtDueDate(txId, value);
        });
      }

      // keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // close top-most
          if (document.getElementById('confirm-modal') && !document.getElementById('confirm-modal').classList.contains('hidden')) return closeConfirm();
          if (document.getElementById('debt-details-modal') && !document.getElementById('debt-details-modal').classList.contains('hidden')) return closeDebtDetails();
          if (document.getElementById('transaction-details-modal') && !document.getElementById('transaction-details-modal').classList.contains('hidden')) return closeTransactionDetails();
          if (document.getElementById('transaction-modal') && !document.getElementById('transaction-modal').classList.contains('hidden')) return closeModal();
          if (document.getElementById('quick-add') && !document.getElementById('quick-add').classList.contains('hidden')) return closeQuickAdd();
          if (document.querySelector('.screen.active')?.id === 'settings-screen') return closeSettings();
          if (document.querySelector('.screen.active')?.id === 'auth-screen') return goBack();
        }
      });

      // Restore last screen (except settings)
      const target = (state.lastScreen && state.lastScreen !== 'settings-screen' && state.lastScreen !== 'auth-screen') ? state.lastScreen : 'home-screen';
      showScreen(target, { push: false });

      // loader out
      setTimeout(() => {
        const loader = document.getElementById('loading');
        if (!loader) return;
        loader.style.transition = 'opacity 220ms ease';
        loader.style.opacity = '0';
        setTimeout(() => { try { loader.remove(); } catch { } }, 240);
      }, 550);
    }

    async function initSafe() {
      try {
        await init();
      } catch (err) {
        // Ensure we never get stuck on the loader.
        try {
          const loader = document.getElementById('loading');
          if (loader) {
            loader.style.transition = 'opacity 220ms ease';
            loader.style.opacity = '0';
            setTimeout(() => { try { loader.remove(); } catch { } }, 240);
          }
        } catch { }
        try {
          if (typeof showToast === 'function') showToast(String(err?.message || err || 'Init error'), 'error');
        } catch { }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      try { Cloud.init(); } catch { }
      initSafe();
    });
  </script>
</body>

</html>